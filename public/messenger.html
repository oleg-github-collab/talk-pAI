<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk pAI - Enterprise Messenger</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        .messenger-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 400px;
            text-align: center;
        }

        .login-box h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #5a6fd8;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e4e6ea;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e4e6ea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #f0f2f5;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .action-btn:hover {
            background: #e4e6ea;
        }

        /* Search */
        .search-container {
            padding: 16px 20px;
            border-bottom: 1px solid #e4e6ea;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 1px solid #e4e6ea;
            border-radius: 20px;
            background: #f0f2f5;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #65676b;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-item:hover {
            background: #f0f2f5;
        }

        .chat-item.active {
            background: #e7f3ff;
            border-right: 3px solid #1877f2;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-last-message {
            color: #65676b;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: #65676b;
            font-size: 12px;
            white-space: nowrap;
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e4e6ea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .chat-header-details h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
        }

        .chat-header-details p {
            font-size: 12px;
            color: #65676b;
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
        }

        .chat-actions-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #f0f2f5;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            position: relative;
        }

        .chat-actions-btn:hover {
            background: #e4e6ea;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e4e6ea;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 100;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: #f0f2f5;
        }

        /* Messages Area */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 70%;
        }

        .message.own {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .message-content {
            background: #f0f2f5;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 100%;
            word-wrap: break-word;
        }

        .message.own .message-content {
            background: #1877f2;
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #65676b;
            margin-top: 4px;
        }

        .message.own .message-time {
            color: rgba(255,255,255,0.7);
        }

        /* Audio Message */
        .audio-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f0f2f5;
            border-radius: 18px;
            max-width: 300px;
        }

        .message.own .audio-message {
            background: #1877f2;
        }

        .audio-play-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .message.own .audio-play-btn {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .audio-duration {
            font-size: 14px;
            color: #65676b;
        }

        .message.own .audio-duration {
            color: rgba(255,255,255,0.8);
        }

        /* File Message */
        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f0f2f5;
            border-radius: 18px;
            max-width: 300px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .message.own .file-message {
            background: #1877f2;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .message.own .file-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message.own .file-name {
            color: white;
        }

        .file-size {
            font-size: 12px;
            color: #65676b;
        }

        .message.own .file-size {
            color: rgba(255,255,255,0.7);
        }

        /* AI Indicator */
        .ai-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        /* Message Input */
        .message-input-container {
            padding: 20px;
            border-top: 1px solid #e4e6ea;
            background: white;
        }

        .message-input-box {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            padding: 8px 12px;
            background: #f0f2f5;
            border-radius: 24px;
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .message-input-box:focus-within {
            border-color: #1877f2;
            background: white;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .input-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1877f2;
            transition: background 0.2s;
        }

        .input-btn:hover {
            background: rgba(24, 119, 242, 0.1);
        }

        .message-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.4;
            max-height: 100px;
            min-height: 32px;
            padding: 8px 0;
        }

        .send-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #1877f2;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #166fe5;
        }

        .send-btn:disabled {
            background: #e4e6ea;
            cursor: not-allowed;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f0f2f5;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Welcome Modal */
        .welcome-modal .modal-content {
            text-align: center;
            max-width: 600px;
        }

        .welcome-logo {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 16px;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #65676b;
            margin-bottom: 32px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .feature-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .feature-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .feature-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .feature-desc {
            font-size: 14px;
            color: #65676b;
        }

        .welcome-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .welcome-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .welcome-btn.primary {
            background: #1877f2;
            color: white;
        }

        .welcome-btn.primary:hover {
            background: #166fe5;
        }

        .welcome-btn.secondary {
            background: #f0f2f5;
            color: #333;
        }

        .welcome-btn.secondary:hover {
            background: #e4e6ea;
        }

        /* File Input */
        .file-input {
            display: none;
        }

        /* Audio Recording */
        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e74c3c;
            font-size: 14px;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            color: #65676b;
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: #65676b;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-chat {
                width: 100%;
            }

            .message {
                max-width: 85%;
            }
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-16 {
            margin-bottom: 16px;
        }

        .mt-8 {
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="logo">ü§ñ</div>
            <h1>Talk pAI</h1>
            <div id="loginForm">
                <div class="form-group">
                    <label for="nickname">Username</label>
                    <input type="text" id="nickname" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button class="login-btn" onclick="login()">Sign In</button>
                <button class="login-btn" style="background: #42b883;" onclick="register()">Create Account</button>
            </div>
            <div id="loginError" class="hidden" style="color: #e74c3c; margin-top: 16px;"></div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="modal" id="welcomeModal">
        <div class="modal-content welcome-modal">
            <div class="welcome-logo">üöÄ</div>
            <h2 class="welcome-title">Welcome to Talk pAI!</h2>
            <p class="welcome-subtitle">Your enterprise-grade AI-powered messenger is ready to transform your communication.</p>

            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon">üí¨</div>
                    <div class="feature-title">Real-time Chat</div>
                    <div class="feature-desc">Instant messaging with advanced features</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ü§ñ</div>
                    <div class="feature-title">AI Assistant</div>
                    <div class="feature-desc">ChatGPT-4o powered conversations</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üéµ</div>
                    <div class="feature-title">Audio Messages</div>
                    <div class="feature-desc">Voice messages up to 1 minute</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üìÅ</div>
                    <div class="feature-title">File Sharing</div>
                    <div class="feature-desc">Share files up to 5MB</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üîç</div>
                    <div class="feature-title">Smart Search</div>
                    <div class="feature-desc">Find messages and users instantly</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üè¢</div>
                    <div class="feature-title">Enterprise Features</div>
                    <div class="feature-desc">Teams, workspaces, and permissions</div>
                </div>
            </div>

            <div class="welcome-actions">
                <button class="welcome-btn primary" onclick="closeWelcomeModal()">Get Started</button>
                <button class="welcome-btn secondary" onclick="showTutorial()">Take Tutorial</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="modal" id="tutorialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Quick Tutorial</h3>
                <button class="modal-close" onclick="closeTutorialModal()">√ó</button>
            </div>
            <div id="tutorialContent">
                <div class="tutorial-step" data-step="1">
                    <h4>üó®Ô∏è Start Chatting</h4>
                    <p>Click the "+" button to create a new chat. Search for users and start conversations instantly.</p>
                </div>
                <div class="tutorial-step hidden" data-step="2">
                    <h4>ü§ñ AI Assistant</h4>
                    <p>Toggle AI mode with the robot button. Get intelligent responses and assistance from ChatGPT-4o.</p>
                </div>
                <div class="tutorial-step hidden" data-step="3">
                    <h4>üéµ Voice Messages</h4>
                    <p>Hold the microphone button to record voice messages up to 1 minute long.</p>
                </div>
                <div class="tutorial-step hidden" data-step="4">
                    <h4>üìÅ File Sharing</h4>
                    <p>Use the attachment button to share files up to 5MB. Supports all common file formats.</p>
                </div>
                <div class="tutorial-step hidden" data-step="5">
                    <h4>üîç Search Everything</h4>
                    <p>Use the search bar to find messages, users, or chats. Three dots menu gives you more options.</p>
                </div>
            </div>
            <div class="welcome-actions">
                <button class="welcome-btn secondary" onclick="prevTutorialStep()">Previous</button>
                <button class="welcome-btn primary" onclick="nextTutorialStep()">Next</button>
                <button class="welcome-btn primary hidden" onclick="closeTutorialModal()">Finish</button>
            </div>
        </div>
    </div>

    <!-- Main Messenger -->
    <div class="messenger-container hidden" id="messengerContainer">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-name" id="userName">User</div>
                </div>
                <div class="header-actions">
                    <button class="action-btn" onclick="showNewChatModal()" title="New Chat">+</button>
                    <button class="action-btn" onclick="toggleAIMode()" id="aiToggle" title="AI Assistant">ü§ñ</button>
                    <button class="action-btn" onclick="showSettingsModal()" title="Settings">‚öôÔ∏è</button>
                </div>
            </div>

            <!-- Search -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search chats..." id="chatSearch" oninput="searchChats()">
                    <span class="search-icon">üîç</span>
                </div>
            </div>

            <!-- Chat List -->
            <div class="chat-list" id="chatList">
                <!-- Chat items will be populated here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-header-avatar" id="chatHeaderAvatar">C</div>
                    <div class="chat-header-details">
                        <h3 id="chatHeaderName">Select a chat</h3>
                        <p id="chatHeaderStatus">No chat selected</p>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="chat-actions-btn" onclick="toggleChatSearch()" title="Search in chat">üîç</button>
                    <button class="chat-actions-btn" onclick="toggleChatMenu()" title="Chat options">‚ãØ</button>
                    <div class="dropdown-menu" id="chatMenu">
                        <a href="#" class="dropdown-item" onclick="searchInChat()">
                            üîç Search in chat
                        </a>
                        <a href="#" class="dropdown-item" onclick="viewChatInfo()">
                            ‚ÑπÔ∏è Chat info
                        </a>
                        <a href="#" class="dropdown-item" onclick="muteChat()">
                            üîá Mute chat
                        </a>
                        <a href="#" class="dropdown-item" onclick="deleteChat()">
                            üóëÔ∏è Delete chat
                        </a>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="messages-container" id="messagesContainer">
                <div class="text-center" style="color: #65676b; margin-top: 40px;">
                    Select a chat to start messaging
                </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
                <div class="message-input-box">
                    <div class="input-actions">
                        <input type="file" class="file-input" id="fileInput" accept="*/*" onchange="handleFileSelect()">
                        <button class="input-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">üìé</button>
                        <button class="input-btn" id="audioBtn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()" title="Record audio">üé§</button>
                    </div>
                    <textarea class="message-input" id="messageInput" placeholder="Type a message..." onkeydown="handleKeyDown(event)" oninput="handleInputChange()"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>‚û§</button>
                </div>
                <div class="recording-indicator hidden" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    Recording... <span id="recordingTime">0:00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Chat</h3>
                <button class="modal-close" onclick="closeNewChatModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Search users:</label>
                <input type="text" id="userSearch" placeholder="Type username..." oninput="searchUsers()">
            </div>
            <div id="userSearchResults" class="mt-8">
                <!-- User search results will appear here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let currentChat = null;
        let chats = [];
        let isAIMode = false;
        let isRecording = false;
        let mediaRecorder = null;
        let recordingStartTime = null;
        let recordingTimer = null;
        let tutorialStep = 1;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // Authentication
        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch('/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        currentUser = data;
                        showMessenger();
                        return;
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                }
                localStorage.removeItem('token');
            }
            showLogin();
        }

        async function login() {
            const nickname = document.getElementById('nickname').value;
            const password = document.getElementById('password').value;

            if (!nickname || !password) {
                showError('Please enter both username and password');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname, password })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('token', data.token);
                    currentUser = data;
                    showMessenger();
                } else {
                    showError(data.error || 'Login failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        async function register() {
            const nickname = document.getElementById('nickname').value;
            const password = document.getElementById('password').value;

            if (!nickname || !password) {
                showError('Please enter both username and password');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname, password })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('token', data.user.token);
                    currentUser = data.user;
                    showMessenger();
                } else {
                    showError(data.error || 'Registration failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('messengerContainer').classList.add('hidden');
        }

        function showMessenger() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('messengerContainer').classList.remove('hidden');

            // Update user info
            document.getElementById('userName').textContent = currentUser.nickname;
            document.getElementById('userAvatar').textContent = currentUser.nickname.charAt(0).toUpperCase();

            // Initialize socket
            initializeSocket();

            // Load chats
            loadChats();

            // Show welcome modal for new users
            if (localStorage.getItem('hasSeenWelcome') !== 'true') {
                showWelcomeModal();
            }
        }

        // Socket initialization
        function initializeSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('Connected to server');
                socket.emit('user-connect', { userId: currentUser.id, username: currentUser.nickname });
            });

            socket.on('new-message', (message) => {
                if (currentChat && message.chatId === currentChat.id) {
                    addMessageToUI(message);
                }
                updateChatLastMessage(message.chatId, message);
            });

            socket.on('user-typing', (data) => {
                if (currentChat && data.chatId === currentChat.id && data.userId !== currentUser.id) {
                    showTypingIndicator(data.username);
                }
            });

            socket.on('user-stopped-typing', () => {
                hideTypingIndicator();
            });
        }

        // Welcome and tutorial
        function showWelcomeModal() {
            document.getElementById('welcomeModal').classList.add('show');
        }

        function closeWelcomeModal() {
            document.getElementById('welcomeModal').classList.remove('show');
            localStorage.setItem('hasSeenWelcome', 'true');
        }

        function showTutorial() {
            closeWelcomeModal();
            document.getElementById('tutorialModal').classList.add('show');
            tutorialStep = 1;
            updateTutorialStep();
        }

        function closeTutorialModal() {
            document.getElementById('tutorialModal').classList.remove('show');
            localStorage.setItem('hasSeenWelcome', 'true');
        }

        function nextTutorialStep() {
            if (tutorialStep < 5) {
                tutorialStep++;
                updateTutorialStep();
            } else {
                closeTutorialModal();
            }
        }

        function prevTutorialStep() {
            if (tutorialStep > 1) {
                tutorialStep--;
                updateTutorialStep();
            }
        }

        function updateTutorialStep() {
            const steps = document.querySelectorAll('.tutorial-step');
            steps.forEach((step, index) => {
                step.classList.toggle('hidden', index + 1 !== tutorialStep);
            });

            const prevBtn = document.querySelector('[onclick="prevTutorialStep()"]');
            const nextBtn = document.querySelector('[onclick="nextTutorialStep()"]');
            const finishBtn = document.querySelector('[onclick="closeTutorialModal()"]');

            prevBtn.style.display = tutorialStep === 1 ? 'none' : 'inline-block';
            nextBtn.style.display = tutorialStep === 5 ? 'none' : 'inline-block';
            finishBtn.style.display = tutorialStep === 5 ? 'inline-block' : 'none';
        }

        // Chat functionality
        async function loadChats() {
            try {
                const response = await fetch('/api/chat/my-chats', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    chats = data.chats || [];
                    renderChatList();
                }
            } catch (error) {
                console.error('Failed to load chats:', error);
            }
        }

        function renderChatList() {
            const chatList = document.getElementById('chatList');
            if (chats.length === 0) {
                chatList.innerHTML = '<div style="padding: 20px; text-align: center; color: #65676b;">No chats yet. Create your first chat!</div>';
                return;
            }

            chatList.innerHTML = chats.map(chat => {
                const lastMessage = chat.lastMessage || {};
                return `
                    <div class="chat-item ${currentChat && currentChat.id === chat.id ? 'active' : ''}" onclick="selectChat('${chat.id}')">
                        <div class="chat-avatar">${chat.name ? chat.name.charAt(0).toUpperCase() : 'C'}</div>
                        <div class="chat-info">
                            <div class="chat-name">${chat.name || 'Unnamed Chat'}</div>
                            <div class="chat-last-message">${lastMessage.content || 'No messages yet'}</div>
                        </div>
                        <div class="chat-time">${lastMessage.timestamp ? formatTime(lastMessage.timestamp) : ''}</div>
                    </div>
                `;
            }).join('');
        }

        async function selectChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            currentChat = chat;

            // Update UI
            document.getElementById('chatHeaderName').textContent = chat.name || 'Unnamed Chat';
            document.getElementById('chatHeaderStatus').textContent = 'Online';
            document.getElementById('chatHeaderAvatar').textContent = chat.name ? chat.name.charAt(0).toUpperCase() : 'C';

            // Join chat room
            if (socket) {
                socket.emit('join-chat', chatId);
            }

            // Load messages
            await loadMessages(chatId);

            // Update chat list
            renderChatList();
        }

        async function loadMessages(chatId) {
            try {
                const response = await fetch(`/api/chat/${chatId}/messages`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    renderMessages(data.messages || []);
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center" style="color: #65676b; margin-top: 40px;">No messages yet. Start the conversation!</div>';
                return;
            }

            container.innerHTML = messages.map(message => createMessageHTML(message)).join('');
            scrollToBottom();
        }

        function createMessageHTML(message) {
            const isOwn = message.senderId === currentUser.id;
            const senderName = message.senderName || 'Unknown';

            let content = '';
            if (message.type === 'audio') {
                content = `
                    <div class="audio-message">
                        <button class="audio-play-btn" onclick="playAudio('${message.audioUrl}')">‚ñ∂</button>
                        <div class="audio-duration">${message.duration || '0:30'}</div>
                    </div>
                `;
            } else if (message.type === 'file') {
                content = `
                    <div class="file-message" onclick="downloadFile('${message.fileUrl}', '${message.fileName}')">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-info">
                            <div class="file-name">${message.fileName}</div>
                            <div class="file-size">${message.fileSize || 'Unknown size'}</div>
                        </div>
                    </div>
                `;
            } else {
                content = `<div class="message-content">${escapeHtml(message.content)}</div>`;
            }

            return `
                <div class="message ${isOwn ? 'own' : ''}">
                    ${!isOwn ? `<div class="message-avatar">${senderName.charAt(0).toUpperCase()}</div>` : ''}
                    ${content}
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                </div>
            `;
        }

        function addMessageToUI(message) {
            const container = document.getElementById('messagesContainer');
            if (container.innerHTML.includes('No messages yet')) {
                container.innerHTML = '';
            }
            container.innerHTML += createMessageHTML(message);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Message sending
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentChat) return;

            try {
                const response = await fetch(`/api/chat/${currentChat.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        content,
                        type: isAIMode ? 'ai' : 'text'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    input.value = '';
                    updateSendButton();

                    if (socket) {
                        socket.emit('send-message', {
                            chatId: currentChat.id,
                            content,
                            type: isAIMode ? 'ai' : 'text',
                            senderId: currentUser.id,
                            senderName: currentUser.nickname
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleInputChange() {
            updateSendButton();

            if (socket && currentChat) {
                const content = document.getElementById('messageInput').value;
                if (content.length > 0) {
                    socket.emit('typing-start', {
                        chatId: currentChat.id,
                        userId: currentUser.id,
                        username: currentUser.nickname
                    });
                } else {
                    socket.emit('typing-stop', {
                        chatId: currentChat.id,
                        userId: currentUser.id
                    });
                }
            }
        }

        function updateSendButton() {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendBtn');
            button.disabled = !input.value.trim();
        }

        // File handling
        async function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file || !currentChat) return;

            // Check file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`/api/chat/${currentChat.id}/file`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    if (socket) {
                        socket.emit('send-message', {
                            chatId: currentChat.id,
                            type: 'file',
                            fileName: file.name,
                            fileSize: formatFileSize(file.size),
                            fileUrl: data.fileUrl,
                            senderId: currentUser.id,
                            senderName: currentUser.nickname
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to upload file:', error);
                alert('Failed to upload file');
            }

            fileInput.value = '';
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Audio recording
        async function startRecording() {
            if (isRecording) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

                    // Check duration (60 second limit)
                    const duration = Date.now() - recordingStartTime;
                    if (duration > 60000) {
                        alert('Audio message must be less than 1 minute');
                        return;
                    }

                    await sendAudioMessage(audioBlob, duration);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                document.getElementById('recordingIndicator').classList.remove('hidden');
                document.getElementById('audioBtn').style.background = '#e74c3c';

                recordingTimer = setInterval(updateRecordingTime, 100);

                // Auto-stop after 60 seconds
                setTimeout(() => {
                    if (isRecording) {
                        stopRecording();
                    }
                }, 60000);

            } catch (error) {
                console.error('Failed to start recording:', error);
                alert('Unable to access microphone');
            }
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;

            isRecording = false;
            mediaRecorder.stop();

            document.getElementById('recordingIndicator').classList.add('hidden');
            document.getElementById('audioBtn').style.background = '';

            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        function updateRecordingTime() {
            if (!isRecording) return;

            const elapsed = Date.now() - recordingStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('recordingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        async function sendAudioMessage(audioBlob, duration) {
            if (!currentChat) return;

            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.wav');

            try {
                const response = await fetch(`/api/chat/${currentChat.id}/audio`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    if (socket) {
                        socket.emit('send-message', {
                            chatId: currentChat.id,
                            type: 'audio',
                            audioUrl: data.audioUrl,
                            duration: formatDuration(duration),
                            senderId: currentUser.id,
                            senderName: currentUser.nickname
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to send audio:', error);
                alert('Failed to send audio message');
            }
        }

        function playAudio(url) {
            const audio = new Audio(url);
            audio.play();
        }

        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // AI Mode
        function toggleAIMode() {
            isAIMode = !isAIMode;
            const button = document.getElementById('aiToggle');
            const input = document.getElementById('messageInput');

            if (isAIMode) {
                button.style.background = '#1877f2';
                button.style.color = 'white';
                input.placeholder = 'Ask AI assistant...';
                showAIIndicator();
            } else {
                button.style.background = '';
                button.style.color = '';
                input.placeholder = 'Type a message...';
                hideAIIndicator();
            }
        }

        function showAIIndicator() {
            const container = document.getElementById('messagesContainer');
            const indicator = document.createElement('div');
            indicator.className = 'ai-indicator';
            indicator.innerHTML = 'ü§ñ AI Assistant Mode - Your messages will be processed by ChatGPT-4o';
            indicator.id = 'aiIndicator';
            container.appendChild(indicator);
            scrollToBottom();
        }

        function hideAIIndicator() {
            const indicator = document.getElementById('aiIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Chat menu and search
        function toggleChatMenu() {
            const menu = document.getElementById('chatMenu');
            menu.classList.toggle('show');
        }

        function toggleChatSearch() {
            const searchBox = document.createElement('div');
            searchBox.className = 'search-container';
            searchBox.innerHTML = `
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search in this chat..." id="chatSearchInput" oninput="searchInCurrentChat()">
                    <span class="search-icon">üîç</span>
                </div>
            `;

            const chatHeader = document.querySelector('.chat-header');
            const existingSearch = document.getElementById('chatSearchInput');

            if (existingSearch) {
                existingSearch.closest('.search-container').remove();
            } else {
                chatHeader.appendChild(searchBox);
                searchBox.querySelector('input').focus();
            }
        }

        function searchInChat() {
            toggleChatSearch();
        }

        function searchInCurrentChat() {
            const query = document.getElementById('chatSearchInput').value.toLowerCase();
            const messages = document.querySelectorAll('.message');

            messages.forEach(message => {
                const content = message.textContent.toLowerCase();
                if (query && !content.includes(query)) {
                    message.style.opacity = '0.3';
                } else {
                    message.style.opacity = '1';
                }
            });
        }

        function viewChatInfo() {
            alert('Chat info feature coming soon!');
            toggleChatMenu();
        }

        function muteChat() {
            alert('Chat muted!');
            toggleChatMenu();
        }

        function deleteChat() {
            if (confirm('Are you sure you want to delete this chat?')) {
                // Implement delete chat functionality
                alert('Chat deleted!');
            }
            toggleChatMenu();
        }

        // Search users and chats
        function searchChats() {
            const query = document.getElementById('chatSearch').value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');

            chatItems.forEach(item => {
                const name = item.querySelector('.chat-name').textContent.toLowerCase();
                const lastMessage = item.querySelector('.chat-last-message').textContent.toLowerCase();

                if (name.includes(query) || lastMessage.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function showNewChatModal() {
            document.getElementById('newChatModal').classList.add('show');
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.remove('show');
            document.getElementById('userSearch').value = '';
            document.getElementById('userSearchResults').innerHTML = '';
        }

        async function searchUsers() {
            const query = document.getElementById('userSearch').value.trim();
            if (query.length < 2) {
                document.getElementById('userSearchResults').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/api/chat/search/users?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                if (data.success) {
                    renderUserSearchResults(data.users || []);
                }
            } catch (error) {
                console.error('Failed to search users:', error);
            }
        }

        function renderUserSearchResults(users) {
            const container = document.getElementById('userSearchResults');
            if (users.length === 0) {
                container.innerHTML = '<div style="padding: 16px; color: #65676b; text-align: center;">No users found</div>';
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="chat-item" onclick="createChat('${user.id}', '${user.nickname}')">
                    <div class="chat-avatar">${user.nickname.charAt(0).toUpperCase()}</div>
                    <div class="chat-info">
                        <div class="chat-name">${user.nickname}</div>
                        <div class="chat-last-message">Click to start chatting</div>
                    </div>
                </div>
            `).join('');
        }

        async function createChat(userId, userName) {
            try {
                const response = await fetch('/api/chat/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        participants: [userId],
                        name: userName
                    })
                });

                const data = await response.json();
                if (data.success) {
                    closeNewChatModal();
                    await loadChats();
                    selectChat(data.chat.id);
                }
            } catch (error) {
                console.error('Failed to create chat:', error);
            }
        }

        // Typing indicators
        function showTypingIndicator(username) {
            hideTypingIndicator();

            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                ${username} is typing
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;

            document.getElementById('messagesContainer').appendChild(indicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Settings modal
        function showSettingsModal() {
            alert('Settings feature coming soon!');
        }

        // Utility functions
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Now';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays < 7) return `${diffDays}d`;

            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateChatLastMessage(chatId, message) {
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                chat.lastMessage = message;
                renderChatList();
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.chat-actions-btn')) {
                document.getElementById('chatMenu').classList.remove('show');
            }
        });

        // Handle mobile back button
        window.addEventListener('popstate', (event) => {
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('show');
            }
        });
    </script>
</body>
</html>