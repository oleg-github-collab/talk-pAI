<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <title>Talk pAI - AI-Powered Messenger</title>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --primary-dark: #3730a3;
      --secondary: #06b6d4;
      --accent: #10b981;
      --success: #059669;
      --warning: #d97706;
      --error: #dc2626;
      --ai: #8b5cf6;
      --news: #f59e0b;

      --bg: #f8fafc;
      --bg-secondary: #f1f5f9;
      --surface: #ffffff;
      --surface-hover: #f8fafc;
      --surface-2: #f1f5f9;
      --surface-elevated: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);

      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --header-height: 64px;
      --bottom-bar-height: 76px;
      --safe-area-top: env(safe-area-inset-top);
      --safe-area-bottom: env(safe-area-inset-bottom);

      --gradient-primary: linear-gradient(135deg, #4f46e5, #6366f1);
      --gradient-secondary: linear-gradient(135deg, #06b6d4, #3b82f6);
      --gradient-ai: linear-gradient(135deg, #8b5cf6, #a855f7);
      --gradient-news: linear-gradient(135deg, #f59e0b, #f97316);
      --gradient-success: linear-gradient(135deg, #059669, #10b981);
      --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(255,255,255,0.4));
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --bg-secondary: #1e293b;
      --surface: #1e293b;
      --surface-hover: #334155;
      --surface-2: #374151;
      --surface-elevated: #1e293b;
      --text: #f8fafc;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: #334155;
      --border-light: #475569;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.3), 0 8px 10px -6px rgb(0 0 0 / 0.3);
      --gradient-glass: linear-gradient(135deg, rgba(30,41,59,0.8), rgba(30,41,59,0.4));
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      background-image: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      background-attachment: fixed;
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      position: fixed;
      width: 100%;
      padding-top: var(--safe-area-top);
      padding-bottom: var(--safe-area-bottom);
      font-feature-settings: 'cv02','cv03','cv04','cv11';
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.02) 0%, rgba(99, 102, 241, 0.01) 100%);
      z-index: -1;
    }

    .app {
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      background: var(--bg);
    }

    /* Performance Optimization for Smooth Animations on All Devices */
    * {
      /* Hardware acceleration for better performance */
      -webkit-transform: translate3d(0, 0, 0);
      -moz-transform: translate3d(0, 0, 0);
      -ms-transform: translate3d(0, 0, 0);
      -o-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      -webkit-perspective: 1000;
      perspective: 1000;
    }

    /* Optimized easing functions for 60fps */
    :root {
      --timing-fast: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --timing-smooth: cubic-bezier(0.4, 0, 0.2, 1);
      --timing-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    /* Reduce animations for users with motion preference */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* Ultra Enhanced Animations */
    @keyframes slideInRight {
      0% {
        transform: translate3d(100%, 0, 0) scale3d(0.95, 0.95, 1);
        opacity: 0;
      }
      100% {
        transform: translate3d(0, 0, 0) scale3d(1, 1, 1);
        opacity: 1;
      }
    }

    @keyframes slideInLeft {
      0% {
        transform: translate3d(-100%, 0, 0) scale3d(0.95, 0.95, 1);
        opacity: 0;
      }
      100% {
        transform: translate3d(0, 0, 0) scale3d(1, 1, 1);
        opacity: 1;
      }
    }

    @keyframes slideInUp {
      0% {
        transform: translate3d(0, 30px, 0) scale3d(0.95, 0.95, 1);
        opacity: 0;
      }
      100% {
        transform: translate3d(0, 0, 0) scale3d(1, 1, 1);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.98);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.9) rotate(-3deg);
        opacity: 0;
      }
      to {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale3d(1, 1, 1);
      }
      50% {
        opacity: 0.8;
        transform: scale3d(1.05, 1.05, 1);
      }
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%) rotate(-5deg); }
      100% { transform: translateX(100%) rotate(5deg); }
    }

    @keyframes float {
      0%, 100% { transform: translate3d(0, 0, 0) rotate3d(0, 0, 1, 0deg); }
      50% { transform: translate3d(0, -10px, 0) rotate3d(0, 0, 1, 1deg); }
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 30px rgba(124, 58, 237, 0.4), 0 0 60px rgba(124, 58, 237, 0.2);
        filter: brightness(1);
      }
      50% {
        box-shadow: 0 0 60px rgba(124, 58, 237, 0.8), 0 0 100px rgba(236, 72, 153, 0.4), 0 0 140px rgba(0, 245, 255, 0.2);
        filter: brightness(1.2);
      }
    }

    @keyframes gentleGlow {
      0%, 100% {
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.1);
      }
      50% {
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15);
      }
    }

    @keyframes slideUp {
      0% {
        opacity: 0;
        transform: translateY(30px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes textFade {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Screens */
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transform: translateX(100%);
      transition: all 0.4s var(--timing-smooth);
      will-change: transform, opacity;
    }

    .screen.active {
      opacity: 1;
      pointer-events: all;
      transform: translateX(0);
    }

    .screen.sliding-left {
      transform: translateX(-100%);
    }

    /* Enhanced Auth Screen */
    .auth-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 2rem;
      max-width: 420px;
      margin: 0 auto;
      width: 100%;
      animation: fadeIn 0.6s ease-out;
    }

    .logo {
      text-align: center;
      margin-bottom: 3rem;
      animation: slideInUp 0.8s ease-out 0.2s both;
    }

    .logo-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 8px rgba(99, 102, 241, 0.3));
      animation: float 3s ease-in-out infinite;
      display: inline-block;
    }

    .logo h1 {
      font-size: 2.8rem;
      font-weight: 900;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
      animation: textFade 0.8s ease-out;
      position: relative;
    }

    .logo h1::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(99, 102, 241, 0.1));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      opacity: 0.2;
      animation: none;
    }

    .logo p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 500;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      animation: slideInUp 0.8s ease-out 0.4s both;
    }

    /* Enhanced Input Groups */
    .input-group {
      position: relative;
    }

    .input-group input {
      width: 100%;
      padding: 1.5rem 2rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 1.1rem;
      font-weight: 500;
      transition: all 0.4s var(--timing-smooth);
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow);
      position: relative;
      z-index: 1;
    }

    .input-group input::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      padding: 2px;
      background: var(--gradient-primary);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: xor;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: transparent;
      background: var(--surface-elevated);
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--shadow-2xl);
      animation: glow 2s ease-in-out infinite;
    }

    .input-group input:focus::before {
      opacity: 1;
    }

    .input-group input:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .input-group::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: var(--radius);
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 0;
    }

    .input-group:focus-within::before {
      opacity: 0.3;
      animation: glow 2s ease-in-out infinite;
    }

    .input-group label {
      position: absolute;
      left: 2rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
      transition: all 0.4s var(--timing-smooth);
      background: var(--surface);
      padding: 0 0.75rem;
      font-weight: 600;
      font-size: 1rem;
      z-index: 2;
      border-radius: 8px;
    }

    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label {
      top: -8px;
      font-size: 0.875rem;
      color: var(--primary);
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 10px rgba(124, 58, 237, 0.5);
      transform: translateY(0) scale(0.95);
    }

    /* Ultra Enhanced Buttons */
    .btn {
      padding: 1.25rem 2rem;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s var(--timing-smooth);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(20px);
      letter-spacing: 0.025em;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      padding: 2px;
      background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent, rgba(255,255,255,0.1));
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: xor;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .btn:hover::after {
      opacity: 1;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow-lg);
    }

    .btn-primary:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: var(--shadow-lg);
      animation: gentleGlow 2s ease-in-out infinite;
    }

    .btn-primary:active {
      transform: translateY(-1px) scale(1.01);
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
    }

    .btn-secondary:hover {
      background: var(--surface-hover);
      border-color: var(--primary);
      transform: translateY(-2px) scale(1.01);
      box-shadow: var(--shadow-lg);
    }

    .btn-ai {
      background: var(--gradient-ai);
      color: white;
      box-shadow: var(--shadow-lg);
    }

    .btn-ai:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: var(--shadow-lg);
    }

    .btn-news {
      background: var(--gradient-news);
      color: white;
      box-shadow: var(--shadow-lg);
    }

    .btn-news:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: var(--shadow-lg);
    }

    .btn-text {
      background: none;
      color: var(--primary);
      padding: 1rem;
      font-weight: 600;
      position: relative;
    }

    .btn-text::before {
      background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
    }

    .btn-text:hover {
      background: rgba(99, 102, 241, 0.1);
      transform: translateY(-1px);
    }


    /* Enhanced Header */
    .header {
      height: var(--header-height);
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      gap: 1rem;
      position: relative;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-title {
      flex: 1;
      font-weight: 700;
      font-size: 1.25rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--surface-hover);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s var(--timing-smooth);
      font-size: 1.25rem;
      backdrop-filter: blur(10px);
    }

    .header-btn:hover {
      background: var(--surface-2);
      transform: scale(1.05);
      box-shadow: var(--shadow);
    }

    .header-btn:active {
      transform: scale(0.95);
    }

    /* Enhanced Chat List */
    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: calc(var(--bottom-bar-height) + 1rem);
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .chat-list::-webkit-scrollbar {
      display: none;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 1.25rem;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.3s var(--timing-smooth);
      position: relative;
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
      backdrop-filter: blur(10px);
    }

    .chat-item::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      background: var(--gradient-glass);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .chat-item:hover::before {
      opacity: 1;
    }

    .chat-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .chat-item.active {
      background: var(--surface-elevated);
      box-shadow: var(--shadow);
    }

    .chat-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--surface-2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .chat-avatar.ai {
      background: var(--gradient-ai);
      color: white;
    }

    .chat-avatar.news {
      background: var(--gradient-news);
      color: white;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
      z-index: 1;
    }

    .chat-name {
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .online-indicator {
      width: 10px;
      height: 10px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .chat-preview {
      color: var(--text-secondary);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }

    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.5rem;
      z-index: 1;
    }

    .chat-time {
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .unread-badge {
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      min-width: 24px;
      text-align: center;
      animation: scaleIn 0.3s ease-out;
    }

    /* Enhanced Messages */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding-bottom: calc(var(--bottom-bar-height) + 1rem);
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .messages-container::-webkit-scrollbar {
      display: none;
    }

    .message {
      display: flex;
      gap: 0.75rem;
      max-width: 85%;
      animation: slideInUp 0.4s ease-out;
      will-change: transform, opacity;
    }

    .message.own {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--surface-2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 1.1rem;
      box-shadow: var(--shadow-sm);
    }

    .message-content {
      background: var(--surface-elevated);
      padding: 1rem 1.25rem;
      border-radius: var(--radius-lg);
      border-bottom-left-radius: 8px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .message-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gradient-glass);
    }

    .message.own .message-content {
      background: var(--gradient-primary);
      color: white;
      border-bottom-left-radius: var(--radius-lg);
      border-bottom-right-radius: 8px;
    }

    .message.ai .message-content {
      background: var(--gradient-ai);
      color: white;
    }

    .message.news .message-content {
      background: var(--gradient-news);
      color: white;
    }

    .message-text {
      word-wrap: break-word;
      line-height: 1.6;
      font-weight: 500;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 0.5rem;
      font-weight: 600;
    }

    /* Enhanced Typing Indicator */
    .typing-indicator {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 1.25rem;
      background: var(--surface-elevated);
      border-radius: var(--radius-lg);
      width: fit-content;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .typing-dot {
      width: 10px;
      height: 10px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-12px); }
    }

    /* Enhanced Message Input */
    .message-input-container {
      padding: 1.5rem;
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      box-shadow: var(--shadow-sm);
    }

    .input-wrapper {
      flex: 1;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: flex-end;
      padding: 0.75rem;
      gap: 0.75rem;
      transition: all 0.3s var(--timing-smooth);
      backdrop-filter: blur(10px);
    }

    .input-wrapper:focus-within {
      border-color: var(--primary);
      background: var(--surface-elevated);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .message-input {
      flex: 1;
      border: none;
      background: none;
      color: var(--text);
      font-size: 1rem;
      padding: 0.75rem;
      resize: none;
      max-height: 120px;
      line-height: 1.5;
      font-weight: 500;
    }

    .message-input:focus {
      outline: none;
    }

    .input-actions {
      display: flex;
      gap: 0.5rem;
    }

    .input-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--surface-hover);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s var(--timing-smooth);
      font-size: 1.25rem;
      backdrop-filter: blur(10px);
    }

    .input-btn:hover {
      background: var(--surface-2);
      transform: scale(1.05);
    }

    .input-btn:active {
      transform: scale(0.9);
    }

    .send-btn {
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow);
    }

    .send-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow);
    }

    .record-btn {
      background: var(--error);
      color: white;
    }

    .record-btn.recording {
      animation: pulse 1s infinite;
    }

    /* Enhanced Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(var(--bottom-bar-height) + var(--safe-area-bottom));
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border-light);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding-bottom: var(--safe-area-bottom);
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.3s var(--timing-smooth);
      color: var(--text-secondary);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: var(--radius);
    }

    .nav-item.active::before {
      opacity: 0.1;
    }

    .nav-item.active {
      color: var(--primary);
      transform: translateY(-1px);
    }

    .nav-item:hover {
      transform: translateY(-0.5px);
      color: var(--primary);
    }

    .nav-icon {
      font-size: 1.5rem;
      z-index: 1;
      transition: transform 0.3s ease;
    }

    .nav-item.active .nav-icon {
      transform: scale(1.05);
    }

    .nav-label {
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 1;
    }

    /* News Interface */
    .news-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: calc(var(--bottom-bar-height) + 1rem);
    }

    .news-header {
      background: var(--gradient-news);
      color: white;
      padding: 2rem;
      border-radius: var(--radius-lg);
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }

    .news-header h2 {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .news-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .category-card {
      background: var(--surface-elevated);
      border-radius: var(--radius);
      padding: 1.5rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s var(--timing-smooth);
      border: 2px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .category-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .category-card.selected {
      background: var(--gradient-primary);
      color: white;
      border-color: var(--primary);
    }

    .category-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .category-name {
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Enhanced Search */
    .search-container {
      padding: 1.5rem;
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-light);
    }

    .search-input {
      width: 100%;
      padding: 1rem 1.5rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s var(--timing-smooth);
      backdrop-filter: blur(10px);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--surface-elevated);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    /* Enhanced Settings */
    .settings-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: calc(var(--bottom-bar-height) + 1rem);
    }

    .settings-section {
      margin-bottom: 2rem;
    }

    .settings-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1rem;
      padding: 0 0.5rem;
    }

    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem;
      background: var(--surface-elevated);
      border-radius: var(--radius);
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.3s var(--timing-smooth);
      border: 2px solid var(--border-light);
      backdrop-filter: blur(10px);
    }

    .settings-item:hover {
      background: var(--surface-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .settings-label {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .settings-icon {
      font-size: 1.5rem;
    }

    /* Enhanced Toggle */
    .toggle {
      width: 56px;
      height: 32px;
      background: var(--surface-2);
      border-radius: 999px;
      position: relative;
      transition: all 0.3s var(--timing-smooth);
      cursor: pointer;
      border: 2px solid var(--border);
    }

    .toggle.active {
      background: var(--primary);
      border-color: var(--primary);
    }

    .toggle-slider {
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s var(--timing-smooth);
      box-shadow: var(--shadow);
    }

    .toggle.active .toggle-slider {
      transform: translateX(24px);
    }

    /* Enhanced Summary Card */
    .summary-card {
      background: var(--gradient-ai);
      color: white;
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      margin: 1rem 0;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
    }

    .summary-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .summary-content {
      font-size: 0.95rem;
      line-height: 1.6;
      opacity: 0.95;
      font-weight: 500;
    }

    /* Loading States */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--surface-2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Enhanced Toast */
    .toast {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface-elevated);
      color: var(--text);
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      z-index: 1000;
      animation: slideInUp 0.3s ease-out;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border);
      backdrop-filter: blur(20px);
      font-weight: 600;
      max-width: 90%;
    }

    /* Responsive Design */
    /* Mobile First - Small phones */
    @media (max-width: 375px) {
      .auth-container { padding: 1rem; max-width: 90%; }
      .logo h1 { font-size: 2.2rem; }
      .logo p { font-size: 0.9rem; }
      .input-group { margin-bottom: 1rem; }
      .btn { padding: 1rem 1.5rem; font-size: 0.95rem; }
      .header-title { font-size: 1.1rem; }
      .nav-label { font-size: 0.7rem; }
      .message { max-width: 95%; font-size: 0.9rem; }
      .chat-item { padding: 0.75rem; }
    }

    /* Mobile - Standard phones */
    @media (min-width: 376px) and (max-width: 640px) {
      .message { max-width: 90%; }
      .auth-container { padding: 1.5rem; max-width: 400px; }
      .header { padding: 0 1rem; }
      .message-input-container { padding: 1rem; }
      .logo h1 { font-size: 2.5rem; }
      .input-group input { font-size: 1rem; }
      .btn { min-height: 52px; }
    }

    /* Tablet - Portrait */
    @media (min-width: 641px) and (max-width: 768px) {
      .app {
        max-width: 600px;
        margin: 0 auto;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        box-shadow: var(--shadow-xl);
      }
      .auth-container { max-width: 480px; padding: 2rem; }
      .message { max-width: 75%; }
      .bottom-nav { max-width: 600px; left: 50%; transform: translateX(-50%); }
    }

    /* Tablet - Landscape & Small Desktop */
    @media (min-width: 769px) and (max-width: 1024px) {
      .app {
        max-width: 700px;
        margin: 0 auto;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        box-shadow: var(--shadow-2xl);
      }
      .auth-container { max-width: 520px; padding: 2.5rem; }
      .logo h1 { font-size: 3rem; }
      .message { max-width: 70%; }
      .bottom-nav { max-width: 700px; left: 50%; transform: translateX(-50%); }
      .header { padding: 0 2rem; }
      .message-input-container { padding: 1.5rem 2rem; }
    }

    /* Desktop Telegram-style Layout */
    @media (min-width: 1025px) {
      body {
        overflow: hidden;
        background: var(--bg);
      }

      .app {
        display: flex;
        height: 100vh;
        max-width: none;
        margin: 0;
        border: none;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
      }

      /* Desktop Sidebar */
      .desktop-sidebar {
        width: 420px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .sidebar-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-light);
        background: var(--surface-elevated);
      }

      .sidebar-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
      }

      .sidebar-search {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-light);
      }

      .sidebar-search input {
        width: 100%;
        padding: 1rem 1.5rem;
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        background: var(--bg);
        color: var(--text);
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      .sidebar-search input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .sidebar-chats {
        flex: 1;
        overflow-y: auto;
        padding: 0;
      }

      .sidebar-chat-item {
        display: flex;
        align-items: center;
        padding: 1rem 2rem;
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--surface);
      }

      .sidebar-chat-item:hover {
        background: var(--surface-hover);
      }

      .sidebar-chat-item.active {
        background: var(--primary);
        color: white;
      }

      .sidebar-chat-item.active .chat-preview,
      .sidebar-chat-item.active .chat-time {
        color: rgba(255, 255, 255, 0.8);
      }

      .sidebar-chat-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
        background: var(--gradient-primary);
      }

      .sidebar-chat-info {
        flex: 1;
        min-width: 0;
      }

      .sidebar-chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
      }

      .sidebar-chat-name {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .sidebar-chat-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
        flex-shrink: 0;
      }

      .sidebar-chat-preview {
        font-size: 0.9rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
      }

      .sidebar-unread {
        background: var(--primary);
        color: white;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.5rem;
        flex-shrink: 0;
      }

      /* Desktop Main Chat Area */
      .desktop-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg);
        height: 100vh;
      }

      .desktop-chat-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-light);
        background: var(--surface);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .desktop-chat-info {
        display: flex;
        align-items: center;
      }

      .desktop-chat-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        margin-right: 1rem;
        background: var(--gradient-secondary);
      }

      .desktop-chat-details h2 {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
        color: var(--text);
      }

      .desktop-chat-status {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin: 0.2rem 0 0 0;
      }

      .desktop-chat-actions {
        display: flex;
        gap: 1rem;
      }

      .desktop-action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: var(--surface-hover);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        transition: all 0.2s ease;
      }

      .desktop-action-btn:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-1px);
      }

      .desktop-messages {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        background: var(--bg);
      }

      .desktop-message-input {
        padding: 2rem;
        border-top: 1px solid var(--border-light);
        background: var(--surface);
      }

      /* Hide mobile elements on desktop */
      .header,
      .bottom-nav,
      #chatListScreen,
      #chatScreen,
      #newsScreen,
      #searchScreen {
        display: none;
      }

      /* Show desktop layout */
      .desktop-layout {
        display: flex;
      }

      /* Auth container adjustments */
      .auth-container {
        max-width: 600px;
        padding: 3rem;
        margin: auto;
      }
      .logo h1 { font-size: 3.5rem; }
      .logo p { font-size: 1.2rem; }
      .btn { font-size: 1.1rem; padding: 1.25rem 2.5rem; }

      /* Welcome screen for desktop */
      .desktop-welcome {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
        text-align: center;
      }

      .desktop-welcome-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.6;
      }

      .desktop-welcome h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text);
      }

      .desktop-welcome p {
        font-size: 1rem;
        opacity: 0.8;
        max-width: 400px;
      }
    }

    /* Performance Optimizations */
    .screen,
    .message,
    .chat-item,
    .btn,
    .input-btn {
      will-change: transform;
    }

    /* Accessibility */
    /* Touch devices optimization */
    @media (hover: none) and (pointer: coarse) {
      .btn, .header-btn, .input-btn, .nav-item {
        min-height: 44px;
        min-width: 44px;
      }
      .input-group input, .search-input {
        min-height: 48px;
      }
    }

    /* High DPI screens */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .logo-icon {
        font-size: 3.5rem;
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Dark mode preference */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --surface: #1e293b;
        --surface-elevated: #334155;
        --text: #f8fafc;
        --text-secondary: #cbd5e1;
      }
    }

    /* === СТИЛІ ДЛЯ ПОТУЖНОГО УПРАВЛІННЯ КОНТАКТАМИ === */

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2xl);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      animation: modalSlideIn 0.4s ease;
    }

    .modal-header {
      background: var(--gradient-primary);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-content {
      padding: 24px;
      max-height: calc(90vh - 80px);
      overflow-y: auto;
    }

    .contact-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .emoji-selector {
      margin: 16px 0;
    }

    .emoji-selector label {
      display: block;
      margin-bottom: 12px;
      font-weight: 600;
      color: var(--text);
    }

    .avatar-options {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }

    .avatar-btn {
      width: 48px;
      height: 48px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-btn:hover {
      border-color: var(--primary);
      transform: scale(1.1);
    }

    .avatar-btn.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }

    .contact-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-small:hover {
      background: var(--surface-hover);
      border-color: var(--primary);
    }

    .btn-small.danger {
      color: var(--error);
      border-color: var(--error);
    }

    .btn-small.danger:hover {
      background: var(--error);
      color: white;
    }

    .group-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .group-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--surface-2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .group-name {
      font-weight: 600;
      color: var(--text);
    }

    .group-actions {
      display: flex;
      gap: 8px;
    }

    .add-group-form {
      padding: 20px;
      background: var(--surface-2);
      border-radius: var(--radius);
      border: 2px dashed var(--border);
      display: flex;
      gap: 12px;
      align-items: end;
    }

    .favorite-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 12px;
      background: var(--surface-2);
      border-radius: var(--radius);
      transition: background 0.2s ease;
    }

    .favorite-toggle:hover {
      background: var(--surface-hover);
    }

    .favorite-toggle input[type="checkbox"] {
      margin: 0;
    }

    .group-filter {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .group-filter:hover,
    .group-filter.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .contact-filters {
      display: flex;
      gap: 8px;
      padding: 16px;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .contact-filters::-webkit-scrollbar {
      display: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Покращення для мобільних пристроїв */
    @media (max-width: 768px) {
      .modal {
        width: 95%;
        max-height: 95vh;
      }

      .avatar-options {
        grid-template-columns: repeat(4, 1fr);
      }

      .avatar-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }

      .contact-actions {
        flex-direction: column;
      }

      .add-group-form {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Покращення доступності */
    .modal:focus-within {
      outline: 2px solid var(--primary);
      outline-offset: 4px;
    }

    .avatar-btn:focus,
    .btn-small:focus,
    .favorite-toggle:focus-within {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Анімації для елементів списку */
    .group-item {
      animation: slideInFromLeft 0.3s ease;
    }

    .group-item:nth-child(2n) {
      animation-delay: 0.1s;
    }

    .group-item:nth-child(3n) {
      animation-delay: 0.2s;
    }

    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body data-theme="light">
  <div class="app">
    <!-- Auth Screen -->
    <div id="authScreen" class="screen active" style="display: flex !important; opacity: 1 !important; pointer-events: all !important; transform: translateX(0) !important; z-index: 9999 !important;">
      <div class="auth-container">
        <div class="logo">
          <div class="logo-icon">🤖</div>
          <h1 data-text="Talk pAI">Talk pAI</h1>
          <p>🌌 Next-Generation AI Messenger 🚀</p>
        </div>

        <div id="loginForm" class="auth-form">
          <div class="input-group">
            <input type="text" id="loginNickname" placeholder=" " required>
            <label>Nickname</label>
          </div>
          <div class="input-group">
            <input type="password" id="loginPassword" placeholder=" " required>
            <label>Password</label>
          </div>
          <button class="btn btn-primary" onclick="testLogin()" onmousedown="console.log('Login button pressed')">
            <span>🔐 Sign In</span>
          </button>
          <button class="btn btn-text" onclick="showRegister()" onmousedown="console.log('Register button pressed')">Create Account</button>
          <button class="btn btn-secondary" onclick="alert('🎉 УСПІХ! JavaScript працює!')" style="margin-top: 10px; background: #28a745;">
            <span>🧪 JavaScript Test</span>
          </button>
          <button class="btn btn-secondary" onclick="window.open('/test-clicks.html')" style="margin-top: 10px; background: #17a2b8;">
            <span>🔧 Full Test Page</span>
          </button>
        </div>

        <div id="registerForm" class="auth-form" style="display:none">
          <div class="input-group">
            <input type="text" id="regNickname" placeholder=" " required>
            <label>Choose Nickname</label>
          </div>
          <div class="input-group">
            <input type="password" id="regPassword" placeholder=" " required>
            <label>Password (min 6 chars)</label>
          </div>
          <button class="btn btn-primary" onclick="testRegister()">
            <span>Create Account</span>
          </button>
          <button class="btn btn-text" onclick="showLogin()">Back to Sign In</button>
        </div>
      </div>
    </div>

    <!-- Chat List Screen -->
    <div id="chatListScreen" class="screen">
      <div class="header">
        <div class="header-title">Talk pAI</div>
        <button class="header-btn" onclick="showNews()">📰</button>
        <button class="header-btn" onclick="showSearch()">🔍</button>
      </div>

      <div class="chat-list" id="chatList">
        <!-- Chat items will be populated here -->
      </div>

      <div class="bottom-nav">
        <div class="nav-item active" onclick="showChatList()">
          <span class="nav-icon">💬</span>
          <span class="nav-label">Chats</span>
        </div>
        <div class="nav-item" onclick="showContacts()">
          <span class="nav-icon">👥</span>
          <span class="nav-label">Contacts</span>
        </div>
        <div class="nav-item" onclick="showNews()">
          <span class="nav-icon">📰</span>
          <span class="nav-label">News</span>
        </div>
        <div class="nav-item" onclick="showAI()">
          <span class="nav-icon">🤖</span>
          <span class="nav-label">pAI</span>
        </div>
        <div class="nav-item" onclick="showSettings()">
          <span class="nav-icon">⚙️</span>
          <span class="nav-label">Settings</span>
        </div>
      </div>
    </div>

    <!-- Chat Screen -->
    <div id="chatScreen" class="screen">
      <div class="header">
        <button class="header-btn" onclick="backToList()">←</button>
        <div class="header-title" id="chatTitle">Chat</div>
        <button class="header-btn" onclick="summarizeChat()">📊</button>
      </div>

      <div class="messages-container" id="messages">
        <!-- Messages will be populated here -->
      </div>

      <div id="typingIndicator" class="typing-indicator" style="display:none">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>

      <div class="message-input-container">
        <div class="input-wrapper">
          <textarea
            id="messageInput"
            class="message-input"
            placeholder="Type a message..."
            rows="1"
            onkeypress="handleKeyPress(event)"
            oninput="adjustTextarea(this); handleTyping()"></textarea>
          <div class="input-actions">
            <button class="input-btn" onclick="attachImage()">📷</button>
            <button class="input-btn record-btn" id="recordBtn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">🎙️</button>
          </div>
        </div>
        <button class="input-btn send-btn" onclick="sendMessage()">➤</button>
      </div>
    </div>

    <!-- News Screen -->
    <div id="newsScreen" class="screen">
      <div class="header">
        <button class="header-btn" onclick="backToList()">←</button>
        <div class="header-title">News</div>
        <button class="header-btn" onclick="openChat('Sage')">📰</button>
      </div>

      <div class="news-container">
        <div class="news-header">
          <h2>🗞️ Sage News Center</h2>
          <p>Personalized news from hundreds of sources</p>
        </div>

        <div class="news-categories" id="newsCategories">
          <!-- Categories will be populated -->
        </div>

        <div id="newsContent">
          <!-- News content will be populated -->
        </div>
      </div>
    </div>

    <!-- Search Screen -->
    <div id="searchScreen" class="screen">
      <div class="header">
        <button class="header-btn" onclick="backToList()">←</button>
        <div class="header-title">Search Users</div>
      </div>

      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Search by nickname..." oninput="searchUsers()">
      </div>

      <div class="chat-list" id="searchResults">
        <!-- Search results will be populated here -->
      </div>
    </div>

    <!-- Settings Screen -->
    <div id="settingsScreen" class="screen">
      <div class="header">
        <button class="header-btn" onclick="backToList()">←</button>
        <div class="header-title">Settings</div>
      </div>

      <div class="settings-list">
        <div class="settings-section">
          <div class="settings-title">Appearance</div>
          <div class="settings-item" onclick="toggleTheme()">
            <div class="settings-label">
              <span class="settings-icon">🌙</span>
              <span>Dark Mode</span>
            </div>
            <div class="toggle" id="themeToggle">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-title">AI Assistants</div>
          <div class="settings-item" onclick="showAI()">
            <div class="settings-label">
              <span class="settings-icon">🤖</span>
              <span>Talk to pAI</span>
            </div>
            <span>→</span>
          </div>
          <div class="settings-item" onclick="openChat('Sage')">
            <div class="settings-label">
              <span class="settings-icon">📰</span>
              <span>Sage News Agent</span>
            </div>
            <span>→</span>
          </div>
          <div class="settings-item" onclick="summarizeAll()">
            <div class="settings-label">
              <span class="settings-icon">📊</span>
              <span>Summarize All Chats</span>
            </div>
            <span>→</span>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-title">Coming Soon</div>
          <div class="settings-item">
            <div class="settings-label">
              <span class="settings-icon">🧠</span>
              <span>Custom AI Agents</span>
            </div>
            <span style="color: var(--news); font-weight: 600;">Soon</span>
          </div>
          <div class="settings-item">
            <div class="settings-label">
              <span class="settings-icon">💰</span>
              <span>Finance Assistant</span>
            </div>
            <span style="color: var(--news); font-weight: 600;">Soon</span>
          </div>
          <div class="settings-item">
            <div class="settings-label">
              <span class="settings-icon">⚕️</span>
              <span>Health Coach</span>
            </div>
            <span style="color: var(--news); font-weight: 600;">Soon</span>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-title">Account</div>
          <div class="settings-item" onclick="logout()">
            <div class="settings-label">
              <span class="settings-icon">🚪</span>
              <span>Sign Out</span>
            </div>
            <span>→</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Desktop Layout (shown only on desktop) -->
    <div class="desktop-layout" style="display: none;">
      <!-- Desktop Sidebar -->
      <div class="desktop-sidebar">
        <div class="sidebar-header">
          <h1>Talk pAI</h1>
        </div>

        <div class="sidebar-search">
          <input type="text" placeholder="Search conversations..." id="desktopSearchInput" oninput="desktopSearch()">
        </div>

        <div class="sidebar-chats" id="desktopChatList">
          <!-- Chat items will be populated here -->
        </div>
      </div>

      <!-- Desktop Main Chat Area -->
      <div class="desktop-main" id="desktopMain">
        <div class="desktop-welcome">
          <div class="desktop-welcome-icon">💬</div>
          <h2>Welcome to Talk pAI</h2>
          <p>Select a conversation from the sidebar to start chatting with AI assistants and your contacts.</p>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="uploadImage(event)">

  <script>
    const API_URL = '/api';
    let socket = null;
    let currentUser = null;
    let currentChat = null;
    let lastMessageId = 0;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let typingTimeout = null;
    let newsCategories = ['technology', 'business', 'science', 'world', 'health', 'entertainment'];

    // Initialize app with enhanced animations
    // Debug: Ensure DOM is ready and functions work
    function debugLog(message) {
      console.log(`[DEBUG] ${message}`);
      // Show debug info visually if needed
    }

    // Emergency fallback if checkAuth fails
    function forceAuthScreen() {
      debugLog('Forcing auth screen');
      const authScreen = document.getElementById('authScreen');
      if (authScreen) {
        // Force show auth screen
        document.querySelectorAll('.screen').forEach(s => {
          s.classList.remove('active');
          s.style.display = 'none';
        });
        authScreen.classList.add('active');
        authScreen.style.display = 'flex';
        authScreen.style.pointerEvents = 'all';
        authScreen.style.opacity = '1';
        authScreen.style.transform = 'translateX(0)';
      }
    }

    // RADICAL FIX: Simple working login function
    async function testLogin() {
      console.log('🚀 TEST LOGIN CALLED');
      alert('🔥 Login function working!');

      const nickname = document.getElementById('loginNickname')?.value?.trim();
      const password = document.getElementById('loginPassword')?.value;

      console.log('Values:', { nickname, password });

      if (!nickname || !password) {
        alert('❌ Please fill in both fields!');
        return;
      }

      try {
        console.log('🌐 Making API call...');
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nickname, password })
        });

        const data = await response.json();
        console.log('📡 API Response:', data);

        if (data.success) {
          alert('✅ Login successful!');
          localStorage.setItem('token', data.token);
          localStorage.setItem('nickname', data.nickname);
          location.reload(); // Simple page reload to enter app
        } else {
          alert('❌ Login failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('💥 Login error:', error);
        alert('💥 Network error: ' + error.message);
      }
    }

    // RADICAL FIX: Simple working register function
    async function testRegister() {
      console.log('🚀 TEST REGISTER CALLED');
      alert('🔥 Register function working!');

      const nickname = document.getElementById('regNickname')?.value?.trim();
      const password = document.getElementById('regPassword')?.value;

      console.log('Register Values:', { nickname, password });

      if (!nickname || !password) {
        alert('❌ Please fill in both fields!');
        return;
      }

      if (password.length < 6) {
        alert('❌ Password must be at least 6 characters!');
        return;
      }

      try {
        console.log('🌐 Making register API call...');
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nickname, password })
        });

        const data = await response.json();
        console.log('📡 Register API Response:', data);

        if (data.success) {
          alert('✅ Registration successful!');
          localStorage.setItem('token', data.user.token);
          localStorage.setItem('nickname', data.user.nickname);
          location.reload(); // Simple page reload to enter app
        } else {
          alert('❌ Registration failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('💥 Register error:', error);
        alert('💥 Network error: ' + error.message);
      }
    }

    // Simple showRegister and showLogin functions
    function showRegister() {
      console.log('🔄 Showing register form');
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'flex';
    }

    function showLogin() {
      console.log('🔄 Showing login form');
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'flex';
    }

    document.addEventListener('DOMContentLoaded', () => {
      debugLog('DOM Content Loaded');
      try {
        checkAuth();
        setupSocketListeners();
        adjustViewportHeight();
        initializeNewsCategories();
        setupIntersectionObserver();
      } catch (error) {
        debugLog('Error in initialization: ' + error.message);
        // Force auth screen as fallback
        forceAuthScreen();
      }
    });

    // Performance optimization with intersection observer
    function setupIntersectionObserver() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.willChange = 'transform';
          } else {
            entry.target.style.willChange = 'auto';
          }
        });
      });

      // Observe animated elements
      document.querySelectorAll('.message, .chat-item, .btn').forEach(el => {
        observer.observe(el);
      });
    }

    // Enhanced viewport height for mobile
    function adjustViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    window.addEventListener('resize', adjustViewportHeight);
    window.addEventListener('orientationchange', () => {
      setTimeout(adjustViewportHeight, 100);
    });

    // Desktop layout detection
    function isDesktop() {
      return window.innerWidth >= 1025;
    }

    function showDesktopLayout() {
      if (isDesktop()) {
        document.querySelector('.desktop-layout').style.display = 'flex';
        document.querySelector('.app > .screen.active').style.display = 'none';
        loadDesktopContacts();
        return true;
      }
      return false;
    }

    // Auth functions with enhanced animations
    async function checkAuth() {
      const token = localStorage.getItem('token');
      const nickname = localStorage.getItem('nickname');

      if (token && nickname) {
        currentUser = { token, nickname };
        const keepAliveResult = await keepAlive();

        if (keepAliveResult) {
          // Check if desktop layout should be shown
          if (showDesktopLayout()) {
            return; // Desktop layout shown, don't show mobile
          }

          // Show mobile interface
          showScreen('chatListScreen');
          loadChats();
          connectSocket();
          return;
        }
      }

      // Show auth screen if not authenticated
      showScreen('authScreen');
    }

    async function login() {
      debugLog('Login function called');
      const nickname = document.getElementById('loginNickname').value.trim();
      const password = document.getElementById('loginPassword').value;

      debugLog(`Login attempt: ${nickname}`);

      if (!nickname || !password) {
        debugLog('Missing credentials');
        showToast('Please fill in all fields', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nickname, password })
        });

        const data = await response.json();

        if (data.success) {
          currentUser = {
            nickname: data.nickname,
            token: data.token,
            avatar: data.avatar
          };

          localStorage.setItem('token', data.token);
          localStorage.setItem('nickname', data.nickname);
          localStorage.setItem('avatar', data.avatar);

          connectSocket();

          if (showDesktopLayout()) {
            showToast(data.message, 'success');
          } else {
            showScreen('chatListScreen');
            loadChats();
            showToast(data.message, 'success');
          }
        } else {
          showToast(data.error || 'Login failed', 'error');
        }
      } catch (error) {
        showToast('Connection error', 'error');
      }
    }

    async function register() {
      const nickname = document.getElementById('regNickname').value.trim();
      const password = document.getElementById('regPassword').value;

      if (!nickname || nickname.length < 3) {
        showToast('Nickname must be at least 3 characters', 'error');
        return;
      }

      if (password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nickname, password })
        });

        const data = await response.json();

        if (data.success) {
          currentUser = {
            nickname: data.nickname,
            token: data.token,
            avatar: '👤'
          };

          localStorage.setItem('token', data.token);
          localStorage.setItem('nickname', data.nickname);
          localStorage.setItem('avatar', '👤');

          connectSocket();

          if (showDesktopLayout()) {
            showToast(data.message, 'success');
          } else {
            showScreen('chatListScreen');
            loadChats();
            showToast(data.message, 'success');
          }
        } else {
          showToast(data.error || 'Registration failed', 'error');
        }
      } catch (error) {
        showToast('Connection error', 'error');
      }
    }

    async function keepAlive() {
      if (!currentUser) return false;

      try {
        const response = await fetch(`${API_URL}/auth/keepalive`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          }
        });

        const data = await response.json();

        if (data.renewed) {
          currentUser.token = data.token;
          localStorage.setItem('token', data.token);
        }

        return data.success;
      } catch (error) {
        console.error('Keep alive failed:', error);
        return false;
      }
    }

    function logout() {
      localStorage.clear();
      currentUser = null;
      if (socket) socket.disconnect();
      showScreen('authScreen');
      showToast('Signed out successfully', 'info');
    }

    // Socket.io with enhanced error handling
    function connectSocket() {
      if (socket) return;

      socket = io();
      setupSocketListeners();

      socket.emit('authenticate', {
        nickname: currentUser.nickname,
        token: currentUser.token
      });
    }

    function setupSocketListeners() {
      if (!socket) return;

      socket.on('authenticated', (data) => {
        if (!data.success) {
          logout();
        }
      });

      socket.on('newMessage', (message) => {
        if (currentChat === message.sender || currentChat === message.receiver || message.receiver === 'all') {
          displayMessage(message);
        }
        loadChats();

        // Play notification sound if not focused
        if (document.hidden && message.sender !== currentUser.nickname) {
          playNotificationSound();
        }
      });

      socket.on('userTyping', (data) => {
        if (currentChat === data.sender) {
          showTypingIndicator(data.isTyping);
        }
      });

      socket.on('userOnline', (data) => {
        updateUserStatus(data.nickname, true);
      });

      socket.on('userOffline', (data) => {
        updateUserStatus(data.nickname, false);
      });
    }

    // Enhanced UI Functions with smooth transitions
    function showScreen(screenId) {
      const currentScreen = document.querySelector('.screen.active');
      const newScreen = document.getElementById(screenId);

      if (currentScreen) {
        currentScreen.classList.add('sliding-left');
        setTimeout(() => {
          currentScreen.classList.remove('active', 'sliding-left');
        }, 400);
      }

      setTimeout(() => {
        newScreen.classList.add('active');
        updateBottomNav(screenId);
      }, 200);
    }

    function updateBottomNav(screenId) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

      const navMap = {
        'chatListScreen': 0,
        'searchScreen': 1,
        'newsScreen': 2,
        'settingsScreen': 4
      };

      const navItems = document.querySelectorAll('.nav-item');
      if (navMap[screenId] !== undefined) {
        navItems[navMap[screenId]].classList.add('active');
      }
    }

    function showLogin() {
      document.getElementById('loginForm').style.display = 'flex';
      document.getElementById('registerForm').style.display = 'none';
    }

    function showRegister() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'flex';
    }


    // Enhanced toast with types
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;

      const colors = {
        success: 'var(--success)',
        error: 'var(--error)',
        warning: 'var(--warning)',
        info: 'var(--primary)'
      };

      toast.style.cssText = `
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--surface-elevated);
        color: var(--text);
        padding: 1rem 1.5rem;
        border-radius: var(--radius);
        z-index: 1000;
        animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-xl);
        border-left: 4px solid ${colors[type]};
        backdrop-filter: blur(20px);
        font-weight: 600;
        max-width: 90%;
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideInUp 0.3s reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Enhanced chat functions
    async function loadChats() {
      try {
        const response = await fetch(`${API_URL}/contacts`, {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          }
        });

        const data = await response.json();

        if (data.success) {
          displayChatList(data.contacts);
        }
      } catch (error) {
        console.error('Failed to load chats:', error);
      }
    }

    function displayChatList(contacts) {
      const chatList = document.getElementById('chatList');

      // Always show pAI and Sage first
      const paiContact = contacts.find(c => c.nickname === 'pAI') || {
        nickname: 'pAI',
        avatar: '🤖',
        online: true,
        unread: 0
      };

      const sageContact = contacts.find(c => c.nickname === 'Sage') || {
        nickname: 'Sage',
        avatar: '📰',
        online: true,
        unread: 0
      };

      let html = `
        <div class="chat-item" onclick="openChat('pAI')" style="animation-delay: 0.1s">
          <div class="chat-avatar ai">🤖</div>
          <div class="chat-info">
            <div class="chat-name">
              pAI Assistant
              <span class="online-indicator"></span>
            </div>
            <div class="chat-preview">Your personal AI assistant</div>
          </div>
          ${paiContact.unread > 0 ? `<div class="chat-meta"><span class="unread-badge">${paiContact.unread}</span></div>` : ''}
        </div>

        <div class="chat-item" onclick="openChat('Sage')" style="animation-delay: 0.2s">
          <div class="chat-avatar news">📰</div>
          <div class="chat-info">
            <div class="chat-name">
              Sage News Agent
              <span class="online-indicator"></span>
            </div>
            <div class="chat-preview">Personalized news briefings</div>
          </div>
          ${sageContact.unread > 0 ? `<div class="chat-meta"><span class="unread-badge">${sageContact.unread}</span></div>` : ''}
        </div>
      `;

      // Add other contacts
      contacts.filter(c => c.nickname !== 'pAI' && c.nickname !== 'Sage').forEach((contact, index) => {
        html += `
          <div class="chat-item" onclick="openChat('${contact.nickname}')" style="animation-delay: ${0.3 + index * 0.1}s">
            <div class="chat-avatar">${contact.avatar || '👤'}</div>
            <div class="chat-info">
              <div class="chat-name">
                ${contact.nickname}
                ${contact.online ? '<span class="online-indicator"></span>' : ''}
              </div>
              <div class="chat-preview">${contact.lastMessage || 'Start a conversation'}</div>
            </div>
            ${contact.unread > 0 ? `<div class="chat-meta"><span class="unread-badge">${contact.unread}</span></div>` : ''}
          </div>
        `;
      });

      chatList.innerHTML = html;

      // Trigger animations
      setTimeout(() => {
        chatList.querySelectorAll('.chat-item').forEach((item, index) => {
          item.style.animation = `slideInUp 0.4s ease-out ${index * 0.05}s both`;
        });
      }, 100);
    }

    async function openChat(nickname) {
      currentChat = nickname;
      document.getElementById('chatTitle').textContent = nickname === 'pAI' ? 'pAI Assistant' :
                                                          nickname === 'Sage' ? 'Sage News Agent' : nickname;
      showScreen('chatScreen');

      // Clear messages with fade out
      const messagesContainer = document.getElementById('messages');
      messagesContainer.style.opacity = '0.3';

      setTimeout(() => {
        messagesContainer.innerHTML = '';
        messagesContainer.style.opacity = '1';
        loadMessages();
      }, 200);
    }

    async function loadMessages() {
      if (!currentChat) return;

      try {
        const response = await fetch(`${API_URL}/messages?conversation=${currentChat}&lastId=${lastMessageId}`, {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          }
        });

        const data = await response.json();

        if (data.success) {
          data.messages.forEach((message, index) => {
            setTimeout(() => displayMessage(message), index * 50);
          });
          lastMessageId = data.lastId;
        }
      } catch (error) {
        console.error('Failed to load messages:', error);
      }
    }

    function displayMessage(message) {
      const container = document.getElementById('messages');
      const isOwn = message.sender === currentUser.nickname;
      const isAI = message.sender === 'pAI';
      const isSage = message.sender === 'Sage';

      const messageEl = document.createElement('div');
      messageEl.className = `message ${isOwn ? 'own' : ''} ${isAI ? 'ai' : ''} ${isSage ? 'news' : ''}`;

      let avatarEmoji = isOwn ? (currentUser.avatar || '👤') :
                       isAI ? '🤖' :
                       isSage ? '📰' : '👤';

      if (message.type === 'audio') {
        messageEl.innerHTML = `
          <div class="message-avatar">${avatarEmoji}</div>
          <div class="message-content">
            <div class="audio-message">
              <button class="audio-play-btn" onclick="playAudio('${message.content}')">▶</button>
              <div class="audio-waveform">
                ${Array(20).fill(0).map(() => `<div class="audio-bar" style="height: ${Math.random() * 100}%"></div>`).join('')}
              </div>
              <span class="audio-duration">0:00</span>
            </div>
            <div class="message-time">${message.timestamp}</div>
          </div>
        `;
      } else if (message.type === 'image') {
        messageEl.innerHTML = `
          <div class="message-avatar">${avatarEmoji}</div>
          <div class="message-content">
            <img src="${message.content}" style="max-width: 100%; border-radius: 12px; box-shadow: var(--shadow);">
            <div class="message-time">${message.timestamp}</div>
          </div>
        `;
      } else {
        messageEl.innerHTML = `
          <div class="message-avatar">${avatarEmoji}</div>
          <div class="message-content">
            <div class="message-text">${escapeHtml(message.content).replace(/\n/g, '<br>')}</div>
            <div class="message-time">${message.timestamp}</div>
          </div>
        `;
      }

      container.appendChild(messageEl);
      container.scrollTop = container.scrollHeight;

      // Add entrance animation
      messageEl.style.opacity = '0';
      messageEl.style.transform = 'translateY(20px)';

      requestAnimationFrame(() => {
        messageEl.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        messageEl.style.opacity = '1';
        messageEl.style.transform = 'translateY(0)';
      });
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();

      if (!content || !currentChat) return;

      // Add optimistic message
      const optimisticMessage = {
        id: Date.now(),
        sender: currentUser.nickname,
        receiver: currentChat,
        type: 'text',
        content: content,
        timestamp: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })
      };

      displayMessage(optimisticMessage);
      input.value = '';
      adjustTextarea(input);

      try {
        const response = await fetch(`${API_URL}/messages/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          },
          body: JSON.stringify({
            receiver: currentChat,
            type: 'text',
            content
          })
        });

        const data = await response.json();

        if (!data.success) {
          showToast(data.error || 'Failed to send message', 'error');
          // Remove optimistic message on failure
          const messages = document.getElementById('messages');
          const lastMessage = messages.lastElementChild;
          if (lastMessage) lastMessage.remove();
        }
      } catch (error) {
        showToast('Failed to send message', 'error');
      }
    }

    // News functionality
    function initializeNewsCategories() {
      const container = document.getElementById('newsCategories');
      const categories = [
        { id: 'technology', name: 'Technology', icon: '📱' },
        { id: 'business', name: 'Business', icon: '💼' },
        { id: 'science', name: 'Science', icon: '🧬' },
        { id: 'world', name: 'World', icon: '🌍' },
        { id: 'health', name: 'Health', icon: '⚕️' },
        { id: 'entertainment', name: 'Entertainment', icon: '🎬' }
      ];

      container.innerHTML = categories.map(cat => `
        <div class="category-card" onclick="selectNewsCategory('${cat.id}')" data-category="${cat.id}">
          <div class="category-icon">${cat.icon}</div>
          <div class="category-name">${cat.name}</div>
        </div>
      `).join('');
    }

    async function selectNewsCategory(category) {
      // Update UI
      document.querySelectorAll('.category-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.category === category);
      });

      // Load news for category
      try {
        const response = await fetch(`${API_URL}/news/latest?category=${category}&limit=10`, {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          }
        });

        const data = await response.json();

        if (data.success) {
          displayNews(data.articles, category);
        }
      } catch (error) {
        console.error('Failed to load news:', error);
        showToast('Failed to load news', 'error');
      }
    }

    function displayNews(articles, category) {
      const container = document.getElementById('newsContent');

      if (!articles || articles.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">📰</div>
            <div>No news available for this category</div>
            <div style="margin-top: 0.5rem; font-size: 0.9rem;">Try selecting a different category or talk to Sage!</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem; text-transform: capitalize;">${category} News</h3>
          <p style="color: var(--text-secondary); font-size: 0.9rem;">${articles.length} recent articles</p>
        </div>
        <div class="news-articles">
          ${articles.map((article, index) => `
            <div class="news-article" style="animation-delay: ${index * 0.1}s" onclick="openNewsArticle('${article.link}')">
              <div class="news-source">${article.source}</div>
              <div class="news-title">${article.title}</div>
              <div class="news-description">${article.description || ''}</div>
              <div class="news-time">${new Date(article.pubDate).toLocaleDateString()}</div>
            </div>
          `).join('')}
        </div>
        <div style="text-align: center; margin-top: 2rem;">
          <button class="btn btn-news" onclick="openChat('Sage')">
            <span>Talk to Sage about these stories</span>
          </button>
        </div>
      `;

      // Add news article styles
      if (!document.getElementById('newsStyles')) {
        const styles = document.createElement('style');
        styles.id = 'newsStyles';
        styles.textContent = `
          .news-articles {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }

          .news-article {
            background: var(--surface-elevated);
            border-radius: var(--radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s var(--timing-smooth);
            border: 2px solid var(--border-light);
            backdrop-filter: blur(10px);
            animation: slideInUp 0.4s ease-out both;
          }

          .news-article:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
          }

          .news-source {
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
          }

          .news-title {
            font-weight: 700;
            font-size: 1.1rem;
            line-height: 1.4;
            margin-bottom: 0.75rem;
            color: var(--text);
          }

          .news-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
          }

          .news-time {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
          }
        `;
        document.head.appendChild(styles);
      }
    }

    function openNewsArticle(url) {
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    // Helper functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function adjustTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function handleTyping() {
      if (!socket || !currentChat) return;

      socket.emit('typing', {
        receiver: currentChat,
        isTyping: true
      });

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('typing', {
          receiver: currentChat,
          isTyping: false
        });
      }, 2000);
    }

    let typingTimer;

    function showTypingIndicator(isTyping) {
      const indicator = document.getElementById('typingIndicator');

      if (isTyping) {
        indicator.style.display = 'flex';

        // Clear existing timer
        clearTimeout(typingTimer);

        // Auto-hide after 3 seconds of no typing updates
        typingTimer = setTimeout(() => {
          indicator.style.display = 'none';
        }, 3000);
      } else {
        indicator.style.display = 'none';
        clearTimeout(typingTimer);
      }
    }

    function backToList() {
      currentChat = null;
      lastMessageId = 0;
      showScreen('chatListScreen');
      loadChats();
    }

    function toggleTheme() {
      const isDark = document.body.dataset.theme === 'dark';
      document.body.dataset.theme = isDark ? 'light' : 'dark';
      document.getElementById('themeToggle').classList.toggle('active');
      localStorage.setItem('theme', document.body.dataset.theme);

      // Add transition effect
      document.body.style.transition = 'all 0.3s ease';
      setTimeout(() => {
        document.body.style.transition = '';
      }, 300);
    }

    function showAI() {
      openChat('pAI');
    }

    function showNews() {
      showScreen('newsScreen');
      if (!document.querySelector('.category-card.selected')) {
        selectNewsCategory('technology');
      }
    }

    function showSearch() {
      showScreen('searchScreen');
      setTimeout(() => {
        document.getElementById('searchInput').focus();
      }, 300);
    }

    function showContacts() {
      showScreen('chatListScreen');
      loadChats();
    }

    function showSettings() {
      showScreen('settingsScreen');
    }

    function showChatList() {
      showScreen('chatListScreen');
      loadChats();
    }

    async function summarizeChat() {
      if (!currentChat) return;

      showToast('Generating summary...', 'info');

      try {
        const response = await fetch(`${API_URL}/messages/summarize`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          },
          body: JSON.stringify({
            conversation: currentChat,
            hours: 24
          })
        });

        const data = await response.json();

        if (data.success) {
          displaySummary(data.summary);
        } else {
          showToast('Failed to generate summary', 'error');
        }
      } catch (error) {
        showToast('Failed to generate summary', 'error');
      }
    }

    function displaySummary(summary) {
      const container = document.getElementById('messages');
      const summaryEl = document.createElement('div');
      summaryEl.className = 'summary-card';
      summaryEl.innerHTML = `
        <div class="summary-header">
          <span>📊</span>
          <span>Conversation Summary</span>
        </div>
        <div class="summary-content">${summary.replace(/\n/g, '<br>')}</div>
      `;
      container.appendChild(summaryEl);
      container.scrollTop = container.scrollHeight;

      // Add entrance animation
      summaryEl.style.opacity = '0';
      summaryEl.style.transform = 'scale(0.95)';

      requestAnimationFrame(() => {
        summaryEl.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        summaryEl.style.opacity = '1';
        summaryEl.style.transform = 'scale(1)';
      });
    }

    async function searchUsers() {
      const query = document.getElementById('searchInput').value.trim();

      if (query.length < 2) {
        document.getElementById('searchResults').innerHTML = '';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/users/search?query=${encodeURIComponent(query)}`, {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          }
        });

        const data = await response.json();

        if (data.success) {
          displaySearchResults(data.users);
        }
      } catch (error) {
        console.error('Search failed:', error);
      }
    }

    function displaySearchResults(users) {
      const container = document.getElementById('searchResults');

      if (users.length === 0) {
        container.innerHTML = `
          <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">🔍</div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">No users found</div>
            <div style="font-size: 0.9rem;">Try a different search term</div>
          </div>
        `;
        return;
      }

      let html = '';
      users.forEach((user, index) => {
        html += `
          <div class="chat-item" onclick="addContact('${user.nickname}')" style="animation-delay: ${index * 0.05}s">
            <div class="chat-avatar">${user.avatar || '👤'}</div>
            <div class="chat-info">
              <div class="chat-name">
                ${user.nickname}
                ${user.online ? '<span class="online-indicator"></span>' : ''}
              </div>
              <div class="chat-preview">${user.isContact ? 'Already in contacts' : 'Tap to add contact'}</div>
            </div>
            ${!user.isContact ? '<div class="chat-meta"><span style="color: var(--primary); font-weight: 600;">+</span></div>' : ''}
          </div>
        `;
      });

      container.innerHTML = html;

      // Trigger animations
      setTimeout(() => {
        container.querySelectorAll('.chat-item').forEach((item, index) => {
          item.style.animation = `slideInUp 0.4s ease-out ${index * 0.05}s both`;
        });
      }, 100);
    }

    async function addContact(nickname) {
      try {
        const response = await fetch(`${API_URL}/contacts/add`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          },
          body: JSON.stringify({ contact: nickname })
        });

        const data = await response.json();

        showToast(data.message || (data.success ? 'Contact added!' : 'Failed to add contact'),
                 data.success ? 'success' : 'error');

        if (data.success) {
          loadChats();
          // Refresh search results
          searchUsers();
        }
      } catch (error) {
        showToast('Failed to add contact', 'error');
      }
    }

    // Audio and image functions (simplified for this demo)
    async function startRecording() {
      showToast('Voice recording not implemented in demo', 'info');
    }

    function stopRecording() {
      // Implementation would go here
    }

    function attachImage() {
      document.getElementById('imageInput').click();
    }

    async function uploadImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      showToast('Image upload not implemented in demo', 'info');
    }

    function playAudio(url) {
      const audio = new Audio(url);
      audio.play().catch(() => {
        showToast('Failed to play audio', 'error');
      });
    }

    function playNotificationSound() {
      // Play a subtle notification sound
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      gainNode.gain.setValueAtTime(0, audioContext.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }

    function updateUserStatus(nickname, online) {
      // Update UI to show user online/offline status
      const chatItems = document.querySelectorAll('.chat-item');
      chatItems.forEach(item => {
        const nameEl = item.querySelector('.chat-name');
        if (nameEl && nameEl.textContent.includes(nickname)) {
          const indicator = item.querySelector('.online-indicator');
          if (indicator) {
            indicator.style.display = online ? 'block' : 'none';
          }
        }
      });
    }

    // Keep alive interval
    setInterval(keepAlive, 5 * 60 * 1000); // Every 5 minutes

    // Load theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.body.dataset.theme = savedTheme;
      if (savedTheme === 'dark') {
        document.getElementById('themeToggle')?.classList.add('active');
      }
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.dataset.theme = 'dark';
      document.getElementById('themeToggle')?.classList.add('active');
    }

    // Listen for system theme changes
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
        if (!localStorage.getItem('theme')) {
          document.body.dataset.theme = e.matches ? 'dark' : 'light';
        }
      });
    }

    // Performance optimizations
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // Reduce animations when not visible
        document.body.style.animationPlayState = 'paused';
      } else {
        document.body.style.animationPlayState = 'running';
      }
    });

    // ==================== DESKTOP FUNCTIONS ====================

    let desktopCurrentChat = null;
    let desktopMessages = [];

    // Load contacts for desktop sidebar
    async function loadDesktopContacts() {
      try {
        const response = await fetch(`${API_URL}/contacts`, {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          }
        });

        const data = await response.json();
        if (data.success) {
          populateDesktopSidebar(data.contacts);
        }
      } catch (error) {
        console.error('Error loading desktop contacts:', error);
      }
    }

    // Populate desktop sidebar with contacts
    function populateDesktopSidebar(contacts) {
      const container = document.getElementById('desktopChatList');

      let html = `
        <div class="sidebar-chat-item" onclick="openDesktopChat('pAI')">
          <div class="sidebar-chat-avatar">🤖</div>
          <div class="sidebar-chat-info">
            <div class="sidebar-chat-header">
              <div class="sidebar-chat-name">pAI Assistant</div>
              <div class="sidebar-chat-time">online</div>
            </div>
            <div class="sidebar-chat-preview">Your personal AI assistant</div>
          </div>
        </div>

        <div class="sidebar-chat-item" onclick="openDesktopChat('Sage')">
          <div class="sidebar-chat-avatar">📰</div>
          <div class="sidebar-chat-info">
            <div class="sidebar-chat-header">
              <div class="sidebar-chat-name">Sage News Agent</div>
              <div class="sidebar-chat-time">online</div>
            </div>
            <div class="sidebar-chat-preview">Personalized news briefings</div>
          </div>
        </div>
      `;

      // Add other contacts
      contacts.filter(c => c.nickname !== 'pAI' && c.nickname !== 'Sage').forEach(contact => {
        const lastSeen = contact.online ? 'online' : 'last seen recently';
        html += `
          <div class="sidebar-chat-item" onclick="openDesktopChat('${contact.nickname}')">
            <div class="sidebar-chat-avatar">${contact.avatar || '👤'}</div>
            <div class="sidebar-chat-info">
              <div class="sidebar-chat-header">
                <div class="sidebar-chat-name">${contact.display_name || contact.nickname}</div>
                <div class="sidebar-chat-time">${lastSeen}</div>
              </div>
              <div class="sidebar-chat-preview">Start a conversation</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Open desktop chat
    async function openDesktopChat(nickname) {
      desktopCurrentChat = nickname;

      // Update active chat in sidebar
      document.querySelectorAll('.sidebar-chat-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Update main chat area
      const mainArea = document.getElementById('desktopMain');
      const avatar = nickname === 'pAI' ? '🤖' : nickname === 'Sage' ? '📰' : '👤';
      const displayName = nickname === 'pAI' ? 'pAI Assistant' :
                          nickname === 'Sage' ? 'Sage News Agent' : nickname;
      const status = nickname === 'pAI' || nickname === 'Sage' ? 'online' : 'last seen recently';

      mainArea.innerHTML = `
        <div class="desktop-chat-header">
          <div class="desktop-chat-info">
            <div class="desktop-chat-avatar">${avatar}</div>
            <div class="desktop-chat-details">
              <h2>${displayName}</h2>
              <div class="desktop-chat-status">${status}</div>
            </div>
          </div>
          <div class="desktop-chat-actions">
            <button class="desktop-action-btn" onclick="desktopSummarizeChat()">📊</button>
            <button class="desktop-action-btn" onclick="desktopSearch()">🔍</button>
            <button class="desktop-action-btn" onclick="desktopMoreActions()">⋯</button>
          </div>
        </div>

        <div class="desktop-messages" id="desktopMessages">
          <!-- Messages will be loaded here -->
        </div>

        <div class="desktop-message-input">
          <div class="input-wrapper">
            <textarea
              id="desktopMessageInput"
              class="message-input"
              placeholder="Type a message..."
              rows="1"
              onkeypress="handleDesktopKeyPress(event)"
              oninput="adjustTextarea(this)"></textarea>
            <div class="input-actions">
              <button class="input-btn" onclick="attachImage()">📷</button>
              <button class="input-btn" onclick="startDesktopRecording()">🎙️</button>
            </div>
          </div>
          <button class="input-btn send-btn" onclick="sendDesktopMessage()">➤</button>
        </div>
      `;

      // Load messages for this chat
      await loadDesktopMessages();
    }

    // Load messages for desktop chat
    async function loadDesktopMessages() {
      if (!desktopCurrentChat) return;

      try {
        const response = await fetch(`${API_URL}/messages?conversation=${desktopCurrentChat}&lastId=${lastMessageId}`, {
          headers: {
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          }
        });

        const data = await response.json();
        if (data.success) {
          const container = document.getElementById('desktopMessages');
          container.innerHTML = '';

          data.messages.reverse().forEach(message => {
            addDesktopMessage(message);
          });

          container.scrollTop = container.scrollHeight;
        }
      } catch (error) {
        console.error('Error loading desktop messages:', error);
      }
    }

    // Add message to desktop chat
    function addDesktopMessage(message) {
      const container = document.getElementById('desktopMessages');
      if (!container) return;

      const messageEl = document.createElement('div');
      const isOwn = message.sender === currentUser.nickname;
      const isAI = message.sender === 'pAI';
      const isSage = message.sender === 'Sage';

      messageEl.className = `message ${isOwn ? 'own' : 'other'} ${isAI ? 'ai' : ''} ${isSage ? 'news' : ''}`;

      const avatarEmoji = isOwn ? '👤' :
                         isAI ? '🤖' :
                         isSage ? '📰' : '👤';

      messageEl.innerHTML = `
        <div class="message-avatar">${avatarEmoji}</div>
        <div class="message-content">
          <div class="message-text">${escapeHtml(message.content).replace(/\n/g, '<br>')}</div>
          <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
        </div>
      `;

      container.appendChild(messageEl);
      container.scrollTop = container.scrollHeight;
    }

    // Handle desktop enter key
    function handleDesktopKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendDesktopMessage();
      }
    }

    // Send desktop message
    async function sendDesktopMessage() {
      const input = document.getElementById('desktopMessageInput');
      const message = input.value.trim();

      if (!message || !desktopCurrentChat) return;

      input.value = '';
      adjustTextarea(input);

      // Add message immediately to UI
      const tempMessage = {
        sender: currentUser.nickname,
        content: message,
        timestamp: new Date().toISOString(),
        type: 'text'
      };
      addDesktopMessage(tempMessage);

      // Send via socket
      if (socket) {
        socket.emit('sendMessage', {
          receiver: desktopCurrentChat,
          content: message,
          type: 'text'
        });
      }
    }

    // Desktop search function
    function desktopSearch() {
      const searchInput = document.getElementById('desktopSearchInput');
      searchInput.focus();
    }

    // Desktop search implementation
    async function performDesktopSearch(query) {
      // Implement search functionality
      console.log('Searching for:', query);
    }

    // Desktop action functions
    async function desktopSummarizeChat() {
      if (!desktopCurrentChat) return;

      const messages = Array.from(document.querySelectorAll('#desktopMessages .message'))
        .map(el => ({
          sender: el.classList.contains('own') ? currentUser.nickname : desktopCurrentChat,
          content: el.querySelector('.message-text').textContent,
          time: new Date().toISOString()
        }));

      if (messages.length === 0) {
        showToast('No messages to summarize', 'info');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/ai/summarize`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentUser.token}`,
            'X-Nickname': currentUser.nickname
          },
          body: JSON.stringify({ messages })
        });

        const data = await response.json();
        if (data.success) {
          // Add summary as AI message
          const summaryMessage = {
            sender: 'pAI',
            content: `📊 **Conversation Summary:**\n\n${data.summary}`,
            timestamp: new Date().toISOString(),
            type: 'text'
          };
          addDesktopMessage(summaryMessage);
          showToast('Summary generated', 'success');
        }
      } catch (error) {
        console.error('Summarize error:', error);
        showToast('Failed to generate summary', 'error');
      }
    }

    function desktopMoreActions() {
      showToast('More actions coming soon!', 'info');
    }

    // Handle window resize
    window.addEventListener('resize', () => {
      if (currentUser && currentUser.token) {
        if (isDesktop() && document.querySelector('.desktop-layout').style.display === 'none') {
          showDesktopLayout();
        } else if (!isDesktop() && document.querySelector('.desktop-layout').style.display === 'flex') {
          document.querySelector('.desktop-layout').style.display = 'none';
          document.querySelector('.app > .screen.active').style.display = 'block';
        }
      }
    });

    // Update socket listeners for desktop
    function setupDesktopSocketListeners() {
      if (!socket) return;

      socket.on('newMessage', (message) => {
        if (isDesktop() && message.sender === desktopCurrentChat) {
          addDesktopMessage(message);
        }
      });

      socket.on('messageDelivered', (data) => {
        if (isDesktop() && data.receiver === desktopCurrentChat) {
          // Handle message delivered status
        }
      });
    }

    // Initialize desktop features
    document.addEventListener('DOMContentLoaded', () => {
      setupDesktopSocketListeners();

      // Handle desktop search input
      const searchInput = document.getElementById('desktopSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          performDesktopSearch(e.target.value);
        });
      }
    });

    // Service Worker registration for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {
          // Service worker registration failed
        });
      });
    }
    // === POTУЖНИЙ ФУНКЦІОНАЛ УПРАВЛІННЯ КОНТАКТАМИ ===

    // Контакти з групами та кастомними назвами
    let contactGroups = ['Favorites', 'Work', 'Family', 'Friends', 'General'];
    let allContacts = [];

    // Створити новий контакт з детальною інформацією
    async function createAdvancedContact() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal advanced-contact-modal">
          <div class="modal-header">
            <h3>🆕 Add New Contact</h3>
            <button onclick="this.closest('.modal-overlay').remove()" class="modal-close">×</button>
          </div>
          <div class="modal-content">
            <div class="contact-form">
              <div class="input-group">
                <input type="text" id="contactNickname" placeholder=" " required>
                <label>Nickname *</label>
              </div>

              <div class="input-group">
                <input type="text" id="contactDisplayName" placeholder=" ">
                <label>Custom Display Name</label>
              </div>

              <div class="input-group">
                <select id="contactGroup">
                  <option value="General">General</option>
                  <option value="Work">Work</option>
                  <option value="Family">Family</option>
                  <option value="Friends">Friends</option>
                  <option value="Favorites">⭐ Favorites</option>
                </select>
                <label>Group</label>
              </div>

              <div class="emoji-selector">
                <label>Choose Avatar:</label>
                <div class="avatar-options">
                  ${['👤', '👨', '👩', '🧑', '👶', '🧓', '👨‍💼', '👩‍💼', '👨‍💻', '👩‍💻', '👨‍🔬', '👩‍🔬'].map(emoji =>
                    `<button type="button" class="avatar-btn" onclick="selectAvatar('${emoji}')">${emoji}</button>`
                  ).join('')}
                </div>
              </div>

              <div class="contact-actions">
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAdvancedContact()">💾 Add Contact</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      document.getElementById('contactNickname').focus();
    }

    // Вибрати аватар
    function selectAvatar(emoji) {
      document.querySelectorAll('.avatar-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.classList.add('selected');
      event.target.setAttribute('data-selected', 'true');
    }

    // Зберегти контакт з розширеними даними
    async function saveAdvancedContact() {
      const nickname = document.getElementById('contactNickname').value.trim();
      const displayName = document.getElementById('contactDisplayName').value.trim();
      const group = document.getElementById('contactGroup').value;
      const selectedAvatar = document.querySelector('.avatar-btn[data-selected="true"]');

      if (!nickname) {
        showToast('Please enter nickname', 'error');
        return;
      }

      try {
        const response = await fetch(\`\${API_URL}/contacts/add\`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': \`Bearer \${currentUser.token}\`,
            'X-Nickname': currentUser.nickname
          },
          body: JSON.stringify({
            contact: nickname,
            customName: displayName || null,
            groupName: group,
            avatar: selectedAvatar ? selectedAvatar.textContent : '👤'
          })
        });

        const data = await response.json();

        if (data.success) {
          showToast(\`✅ Added \${displayName || nickname} to \${group}\`, 'success');
          document.querySelector('.modal-overlay').remove();
          loadChats();
          loadDesktopContacts();
        } else {
          showToast(data.error || 'Failed to add contact', 'error');
        }
      } catch (error) {
        console.error('Error adding contact:', error);
        showToast('Connection error', 'error');
      }
    }

    // Управління групами контактів
    function showGroupManagement() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = \`
        <div class="modal group-management-modal">
          <div class="modal-header">
            <h3>📁 Manage Contact Groups</h3>
            <button onclick="this.closest('.modal-overlay').remove()" class="modal-close">×</button>
          </div>
          <div class="modal-content">
            <div class="group-list">
              \${contactGroups.map(group => \`
                <div class="group-item">
                  <span class="group-name">\${group}</span>
                  <div class="group-actions">
                    <button class="btn-small" onclick="renameGroup('\${group}')">✏️ Rename</button>
                    \${group !== 'General' ? \`<button class="btn-small danger" onclick="deleteGroup('\${group}')">🗑️ Delete</button>\` : ''}
                  </div>
                </div>
              \`).join('')}
            </div>

            <div class="add-group-form">
              <div class="input-group">
                <input type="text" id="newGroupName" placeholder=" " maxlength="20">
                <label>New Group Name</label>
              </div>
              <button class="btn btn-primary" onclick="addNewGroup()">➕ Add Group</button>
            </div>
          </div>
        </div>
      \`;

      document.body.appendChild(modal);
    }

    // Додати нову групу
    async function addNewGroup() {
      const groupName = document.getElementById('newGroupName').value.trim();

      if (!groupName) {
        showToast('Please enter group name', 'error');
        return;
      }

      if (contactGroups.includes(groupName)) {
        showToast('Group already exists', 'error');
        return;
      }

      contactGroups.push(groupName);
      showToast(\`✅ Created group: \${groupName}\`, 'success');
      showGroupManagement(); // Refresh modal
    }

    // Редагувати контакт
    async function editContact(nickname) {
      try {
        const contact = allContacts.find(c => c.nickname === nickname);
        if (!contact) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = \`
          <div class="modal edit-contact-modal">
            <div class="modal-header">
              <h3>✏️ Edit Contact: \${contact.nickname}</h3>
              <button onclick="this.closest('.modal-overlay').remove()" class="modal-close">×</button>
            </div>
            <div class="modal-content">
              <div class="contact-form">
                <div class="input-group">
                  <input type="text" id="editDisplayName" value="\${contact.display_name || contact.nickname}" placeholder=" ">
                  <label>Display Name</label>
                </div>

                <div class="input-group">
                  <select id="editContactGroup">
                    \${contactGroups.map(group =>
                      \`<option value="\${group}" \${contact.group_name === group ? 'selected' : ''}>\${group}</option>\`
                    ).join('')}
                  </select>
                  <label>Group</label>
                </div>

                <div class="contact-actions">
                  <label class="favorite-toggle">
                    <input type="checkbox" id="editFavorite" \${contact.favorite ? 'checked' : ''}>
                    <span>⭐ Add to Favorites</span>
                  </label>
                </div>

                <div class="contact-actions">
                  <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                  <button class="btn btn-primary" onclick="updateContact('\${nickname}')">💾 Save Changes</button>
                  <button class="btn btn-danger" onclick="removeContact('\${nickname}')">🗑️ Remove</button>
                </div>
              </div>
            </div>
          </div>
        \`;

        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error editing contact:', error);
      }
    }

    // Оновити контакт
    async function updateContact(nickname) {
      const displayName = document.getElementById('editDisplayName').value.trim();
      const group = document.getElementById('editContactGroup').value;
      const favorite = document.getElementById('editFavorite').checked;

      try {
        const response = await fetch(\`\${API_URL}/contacts/update\`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': \`Bearer \${currentUser.token}\`,
            'X-Nickname': currentUser.nickname
          },
          body: JSON.stringify({
            contact: nickname,
            customName: displayName,
            groupName: group,
            favorite: favorite
          })
        });

        const data = await response.json();

        if (data.success) {
          showToast('✅ Contact updated successfully', 'success');
          document.querySelector('.modal-overlay').remove();
          loadChats();
          loadDesktopContacts();
        } else {
          showToast(data.error || 'Failed to update contact', 'error');
        }
      } catch (error) {
        console.error('Error updating contact:', error);
        showToast('Connection error', 'error');
      }
    }

    // Видалити контакт
    async function removeContact(nickname) {
      if (!confirm(\`Are you sure you want to remove \${nickname}?\`)) return;

      try {
        const response = await fetch(\`\${API_URL}/contacts/remove\`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': \`Bearer \${currentUser.token}\`,
            'X-Nickname': currentUser.nickname
          },
          body: JSON.stringify({ contact: nickname })
        });

        const data = await response.json();

        if (data.success) {
          showToast(\`🗑️ Removed \${nickname}\`, 'success');
          document.querySelector('.modal-overlay').remove();
          loadChats();
          loadDesktopContacts();
        } else {
          showToast(data.error || 'Failed to remove contact', 'error');
        }
      } catch (error) {
        console.error('Error removing contact:', error);
        showToast('Connection error', 'error');
      }
    }

    // Фільтрувати контакти по групах
    function filterContactsByGroup(groupName) {
      const filteredContacts = allContacts.filter(c => c.group_name === groupName);
      displayChatList(filteredContacts);

      // Update UI to show current filter
      document.querySelectorAll('.group-filter').forEach(btn => btn.classList.remove('active'));
      document.querySelector(\`[data-group="\${groupName}"]\`)?.classList.add('active');
    }

    // Пошук контактів з розширеними можливостями
    function advancedSearchContacts(query) {
      const searchResults = allContacts.filter(contact =>
        contact.nickname.toLowerCase().includes(query.toLowerCase()) ||
        (contact.display_name && contact.display_name.toLowerCase().includes(query.toLowerCase())) ||
        contact.group_name.toLowerCase().includes(query.toLowerCase())
      );

      displayChatList(searchResults);
    }

    // Імпорт/Експорт контактів
    function exportContacts() {
      const contactsData = {
        contacts: allContacts,
        groups: contactGroups,
        exportDate: new Date().toISOString(),
        version: '2.0'
      };

      const blob = new Blob([JSON.stringify(contactsData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = \`talk-pai-contacts-\${new Date().toISOString().split('T')[0]}.json\`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('📥 Contacts exported successfully', 'success');
    }

    function importContacts() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = handleContactImport;
      input.click();
    }

    async function handleContactImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (data.contacts && Array.isArray(data.contacts)) {
          // Add contacts one by one
          let imported = 0;
          for (const contact of data.contacts) {
            if (contact.nickname && contact.nickname !== currentUser.nickname) {
              try {
                await addContact(contact.nickname, contact.display_name, contact.group_name);
                imported++;
              } catch (error) {
                console.warn(\`Failed to import \${contact.nickname}:\`, error);
              }
            }
          }

          showToast(\`📥 Imported \${imported} contacts successfully\`, 'success');
          loadChats();
        } else {
          showToast('Invalid contacts file format', 'error');
        }
      } catch (error) {
        console.error('Import error:', error);
        showToast('Failed to import contacts', 'error');
      }
    }

  </script>
</body>
</html>