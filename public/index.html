<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk pAI - Award-Winning Ultra-Modern Messenger</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== AWARD-WINNING ULTRA-MODERN MESSENGER DESIGN SYSTEM ===== */

        :root {
            /* Core Design Tokens */
            --font-primary: 'SF Pro Display', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;

            /* Enhanced Spacing System - Perfect Mathematical Progression */
            --spacing-2xs: 2px;
            --spacing-xs: 4px;
            --spacing-sm: 6px;
            --spacing-md: 8px;
            --spacing-lg: 12px;
            --spacing-xl: 16px;
            --spacing-2xl: 24px;
            --spacing-3xl: 32px;
            --spacing-4xl: 48px;
            --spacing-5xl: 64px;
            --spacing-6xl: 96px;

            /* Typography Scale - Perfect Modular Scale */
            --scale-ratio: 1.125; /* Major Second for harmonious proportions */
            --text-2xs: 0.694rem;  /* 11px */
            --text-xs: 0.75rem;    /* 12px */
            --text-sm: 0.875rem;   /* 14px */
            --text-base: 1rem;     /* 16px */
            --text-lg: 1.125rem;   /* 18px */
            --text-xl: 1.25rem;    /* 20px */
            --text-2xl: 1.5rem;    /* 24px */
            --text-3xl: 1.875rem;  /* 30px */
            --text-4xl: 2.25rem;   /* 36px */

            /* Perfect Grid System */
            --grid-columns: 12;
            --grid-gap: var(--spacing-lg);
            --container-max-width: 1440px;
            --container-padding: var(--spacing-xl);

            /* Border Radius System */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-2xl: 24px;
            --radius-3xl: 28px;
            --radius-full: 50%;

            /* Animation System */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);

            /* Layout Dimensions */
            --sidebar-width: 280px;
            --sidebar-collapsed: 72px;
            --chat-list-width: 340px;
            --header-height: 72px;
            --input-height: 84px;

            /* Glassmorphism */
            --glass-opacity: 0.85;
            --glass-blur: 20px;
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);

            /* Light Theme Palette */
            --light-bg-primary: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --light-bg-secondary: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            --light-glass: rgba(255, 255, 255, var(--glass-opacity));
            --light-glass-subtle: rgba(255, 255, 255, 0.4);
            --light-text-primary: #0f172a;
            --light-text-secondary: #475569;
            --light-text-tertiary: #94a3b8;
            --light-accent-sky: #0ea5e9;
            --light-accent-mint: #10b981;
            --light-accent-lilac: #8b5cf6;
            --light-accent-peach: #f97316;
            --light-shadow: rgba(15, 23, 42, 0.08);
            --light-neon: rgba(14, 165, 233, 0.4);

            /* Dark Theme Palette */
            --dark-bg-primary: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            --dark-bg-secondary: linear-gradient(135deg, #000000 0%, #0f0f0f 100%);
            --dark-glass: rgba(255, 255, 255, 0.08);
            --dark-glass-subtle: rgba(255, 255, 255, 0.04);
            --dark-text-primary: #f8fafc;
            --dark-text-secondary: #e2e8f0;
            --dark-text-tertiary: #94a3b8;
            --dark-accent-cyan: #22d3ee;
            --dark-accent-purple: #a855f7;
            --dark-accent-magenta: #e879f9;
            --dark-accent-green: #10b981;
            --dark-shadow: rgba(0, 0, 0, 0.3);
            --dark-neon: rgba(34, 211, 238, 0.6);

            /* Active Theme Variables */
            --bg-primary: var(--light-bg-primary);
            --bg-secondary: var(--light-bg-secondary);
            --glass-bg: var(--light-glass);
            --glass-subtle: var(--light-glass-subtle);
            --text-primary: var(--light-text-primary);
            --text-secondary: var(--light-text-secondary);
            --text-tertiary: var(--light-text-tertiary);
            --accent-primary: var(--light-accent-sky);
            --accent-secondary: var(--light-accent-mint);
            --accent-tertiary: var(--light-accent-lilac);
            --accent-quaternary: var(--light-accent-peach);
            --shadow-color: var(--light-shadow);
            --neon-glow: var(--light-neon);
        }

        [data-theme="dark"] {
            --bg-primary: var(--dark-bg-primary);
            --bg-secondary: var(--dark-bg-secondary);
            --glass-bg: var(--dark-glass);
            --glass-subtle: var(--dark-glass-subtle);
            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --text-tertiary: var(--dark-text-tertiary);
            --accent-primary: var(--dark-accent-cyan);
            --accent-secondary: var(--dark-accent-purple);
            --accent-tertiary: var(--dark-accent-magenta);
            --accent-quaternary: var(--dark-accent-green);
            --shadow-color: var(--dark-shadow);
            --neon-glow: var(--dark-neon);
        }

        /* ===== RESET & BASE STYLES ===== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-primary);
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: -2;
        }

        /* ===== FLOATING BACKGROUND ELEMENTS ===== */

        .bg-elements {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .floating-orb {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0.03;
            animation: float-gentle 20s infinite ease-in-out;
            filter: blur(2px);
        }

        .floating-orb:nth-child(1) {
            width: 300px;
            height: 300px;
            top: -150px;
            right: -150px;
            animation-delay: 0s;
        }

        .floating-orb:nth-child(2) {
            width: 200px;
            height: 200px;
            bottom: -100px;
            left: -100px;
            animation-delay: 7s;
        }

        .floating-orb:nth-child(3) {
            width: 150px;
            height: 150px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: 14s;
        }

        @keyframes float-gentle {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }
            33% {
                transform: translate(30px, -30px) rotate(120deg) scale(1.1);
            }
            66% {
                transform: translate(-20px, 20px) rotate(240deg) scale(0.9);
            }
        }

        /* ===== MAIN LAYOUT ===== */

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* ===== PROFESSIONAL SIDEBAR ===== */

        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: width var(--transition-normal) var(--spring);
            position: relative;
            z-index: 100;
            box-shadow: var(--glass-shadow);
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        /* Sidebar Header */
        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--glass-border);
            position: relative;
        }

        .sidebar.collapsed .sidebar-header {
            padding: var(--spacing-md);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            cursor: pointer;
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .user-profile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-subtle);
            border-radius: var(--radius-lg);
            opacity: 0;
            transition: all var(--transition-normal);
        }

        .user-profile:hover::before {
            opacity: 1;
        }

        .user-profile:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            position: relative;
            flex-shrink: 0;
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--accent-secondary);
            border: 2px solid var(--glass-bg);
            border-radius: var(--radius-full);
            animation: pulse 2s infinite;
        }

        .user-info {
            flex: 1;
            min-width: 0;
            opacity: 1;
            transition: all var(--transition-normal);
            position: relative;
            z-index: 1;
        }

        .sidebar.collapsed .user-info {
            opacity: 0;
            transform: translateX(-20px);
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: var(--radius-full);
            background: var(--accent-secondary);
            animation: pulse 2s infinite;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            flex: 1;
            padding: var(--spacing-lg) var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .sidebar.collapsed .sidebar-nav {
            padding: var(--spacing-lg) var(--spacing-sm);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-subtle);
            border-radius: var(--radius-lg);
            opacity: 0;
            transition: all var(--transition-normal);
        }

        .nav-item:hover::before {
            opacity: 1;
        }

        .nav-item:hover {
            transform: translateX(4px);
            color: var(--text-primary);
            box-shadow: 0 4px 20px var(--neon-glow);
        }

        .nav-item.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .nav-item.active::before {
            display: none;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .nav-icon svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            transition: all var(--transition-normal);
        }

        .nav-item:hover .nav-icon svg {
            transform: scale(1.1);
        }

        .nav-text {
            opacity: 1;
            transition: all var(--transition-normal);
            position: relative;
            z-index: 1;
            white-space: nowrap;
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
            transform: translateX(-20px);
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: var(--radius-full);
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            opacity: 1;
            transition: all var(--transition-normal);
            position: relative;
            z-index: 1;
        }

        .sidebar.collapsed .nav-badge {
            opacity: 0;
            transform: scale(0.8);
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--glass-border);
        }

        .sidebar.collapsed .sidebar-footer {
            padding: var(--spacing-md);
        }

        .sidebar-toggle {
            width: 40px;
            height: 40px;
            background: var(--glass-subtle);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--text-secondary);
        }

        .sidebar-toggle:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .sidebar-toggle svg {
            width: 20px;
            height: 20px;
            transition: all var(--transition-normal);
        }

        .sidebar.collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }

        /* ===== CHAT LIST PANEL ===== */

        .chat-list-panel {
            width: var(--chat-list-width);
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 90;
            box-shadow: var(--glass-shadow);
        }

        /* Chat List Header */
        .chat-list-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .chat-list-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-list-title h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .new-chat-btn {
            width: 40px;
            height: 40px;
            background: var(--accent-primary);
            border: none;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            color: white;
            box-shadow: 0 4px 20px var(--neon-glow);
        }

        .new-chat-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .new-chat-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* Global Search */
        .global-search {
            position: relative;
        }

        .search-input {
            width: 100%;
            background: var(--glass-subtle);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 48px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: all var(--transition-normal);
            backdrop-filter: blur(var(--glass-blur));
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--neon-glow);
            transform: scale(1.02);
        }

        .search-input::placeholder {
            color: var(--text-tertiary);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            transition: all var(--transition-normal);
            pointer-events: none;
        }

        .search-input:focus + .search-icon {
            color: var(--accent-primary);
        }

        .search-icon svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .chat-list::-webkit-scrollbar {
            width: 6px;
        }

        .chat-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-list::-webkit-scrollbar-thumb {
            background: var(--glass-subtle);
            border-radius: 3px;
            backdrop-filter: blur(10px);
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: inherit;
        }

        .chat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-subtle);
            border-radius: var(--radius-lg);
            opacity: 0;
            transition: all var(--transition-normal);
        }

        .chat-item:hover::before {
            opacity: 1;
        }

        .chat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .chat-item.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .chat-item.active::before {
            display: none;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
            position: relative;
            z-index: 1;
        }

        .chat-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item.active .chat-preview {
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--spacing-xs);
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .chat-item.active .chat-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-unread {
            background: var(--accent-primary);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: var(--radius-full);
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .chat-item.active .chat-unread {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ===== MAIN CHAT AREA ===== */

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-secondary);
        }

        /* Chat Header */
        .chat-header {
            height: var(--header-height);
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-xl);
            position: relative;
            z-index: 80;
            box-shadow: var(--glass-shadow);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .chat-header-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            position: relative;
        }

        .chat-header-avatar::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--accent-secondary);
            border: 2px solid var(--glass-bg);
            border-radius: var(--radius-full);
            animation: pulse 2s infinite;
        }

        .chat-header-details {
            flex: 1;
            min-width: 0;
        }

        .chat-header-name {
            font-weight: 600;
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .chat-header-status {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--accent-primary);
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            border-radius: var(--radius-full);
            background: var(--accent-primary);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-action-btn {
            width: 44px;
            height: 44px;
            background: var(--glass-subtle);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--text-secondary);
        }

        .header-action-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .header-action-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* ===== VOICE & VIDEO CALL INTERFACE ===== */

        .call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                rgba(13, 16, 23, 0.95) 0%,
                rgba(17, 24, 39, 0.95) 50%,
                rgba(13, 16, 23, 0.95) 100%);
            backdrop-filter: blur(40px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.5s var(--spring);
        }

        .call-overlay.active {
            display: flex;
        }

        .call-interface {
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .call-header {
            padding: var(--spacing-xl);
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .call-user-info {
            margin-bottom: var(--spacing-lg);
        }

        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-md);
            font-size: 48px;
            font-weight: 600;
            color: white;
            position: relative;
            animation: callPulse 2s infinite;
            box-shadow: 0 20px 60px rgba(var(--accent-primary-rgb), 0.3);
        }

        .call-avatar::after {
            content: '';
            position: absolute;
            inset: -10px;
            border: 3px solid var(--accent-primary);
            border-radius: var(--radius-full);
            animation: ripple 2s infinite;
            opacity: 0.6;
        }

        @keyframes callPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        .call-user-name {
            font-size: 28px;
            font-weight: 600;
            color: white;
            margin-bottom: var(--spacing-xs);
        }

        .call-status {
            font-size: 16px;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }

        .call-timer {
            font-family: 'SF Mono', monospace;
            font-size: 18px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: var(--spacing-md);
        }

        .video-container {
            flex: 1;
            position: relative;
            margin: 0 var(--spacing-xl) var(--spacing-xl);
            border-radius: var(--radius-3xl);
            overflow: hidden;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
        }

        .main-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg,
                rgba(var(--accent-primary-rgb), 0.1),
                rgba(var(--accent-secondary-rgb), 0.1));
        }

        .local-video {
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            width: 200px;
            height: 150px;
            border-radius: var(--radius-xl);
            overflow: hidden;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 2px solid var(--glass-border);
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .local-video:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .local-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .call-controls {
            padding: var(--spacing-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-lg);
            position: relative;
            z-index: 10;
        }

        .call-control-btn {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-full);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .call-control-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: var(--radius-full);
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            transition: all var(--transition-normal);
        }

        .call-control-btn svg {
            width: 24px;
            height: 24px;
            color: white;
            position: relative;
            z-index: 1;
        }

        .call-control-btn:hover {
            transform: scale(1.1);
        }

        .call-control-btn:active {
            transform: scale(0.95);
        }

        /* Specific Control Button Styles */
        .btn-mute::before {
            background: linear-gradient(135deg, #6B7280, #9CA3AF);
        }

        .btn-mute.active::before {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .btn-camera::before {
            background: linear-gradient(135deg, #6B7280, #9CA3AF);
        }

        .btn-camera.active::before {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .btn-end-call::before {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.4);
        }

        .btn-end-call:hover::before {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
            transform: scale(1.05);
        }

        .btn-speaker::before {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .btn-more::before {
            background: linear-gradient(135deg, #6366F1, #4F46E5);
        }

        /* Incoming Call Style */
        .call-overlay.incoming .call-controls {
            justify-content: space-around;
            max-width: 300px;
            margin: 0 auto;
        }

        .btn-answer::before {
            background: linear-gradient(135deg, #10B981, #059669);
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);
        }

        .btn-decline::before {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.4);
        }

        /* Call Notification */
        .call-notification {
            position: fixed;
            top: var(--spacing-xl);
            right: var(--spacing-xl);
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-lg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 999;
            min-width: 320px;
            animation: slideInRight 0.5s var(--spring);
            display: none;
        }

        .call-notification.active {
            display: block;
        }

        .call-notification-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .call-notification-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .call-notification-info {
            flex: 1;
        }

        .call-notification-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .call-notification-type {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .call-notification-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }

        .call-notification-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .call-notification-btn svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .btn-notification-answer {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .btn-notification-decline {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .call-notification-btn:hover {
            transform: scale(1.1);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Screen Share Indicator */
        .screen-share-indicator {
            position: absolute;
            top: var(--spacing-lg);
            left: var(--spacing-lg);
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: var(--spacing-xs);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .screen-share-indicator.active {
            display: flex;
        }

        .screen-share-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: var(--radius-full);
            animation: pulse 2s infinite;
        }

        /* ===== DRAG & DROP WITH MAGNETIC EFFECTS ===== */

        .drag-drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                rgba(var(--accent-primary-rgb), 0.1),
                rgba(var(--accent-secondary-rgb), 0.1));
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            animation: fadeIn 0.3s var(--spring);
        }

        .drag-drop-zone.active {
            display: flex;
        }

        .drop-area {
            width: 400px;
            height: 300px;
            border: 3px dashed var(--accent-primary);
            border-radius: var(--radius-3xl);
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-lg);
            transition: all var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .drop-area.drag-over {
            border-color: var(--accent-secondary);
            transform: scale(1.05);
            box-shadow: 0 20px 60px rgba(var(--accent-primary-rgb), 0.3);
        }

        .drop-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg,
                rgba(var(--accent-primary-rgb), 0.1),
                rgba(var(--accent-secondary-rgb), 0.1));
            opacity: 0;
            transition: all var(--transition-smooth);
            border-radius: var(--radius-3xl);
        }

        .drop-area.drag-over::before {
            opacity: 1;
        }

        .drop-icon {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            position: relative;
            z-index: 1;
            animation: float 3s ease-in-out infinite;
        }

        .drop-text {
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .drop-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .drop-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Magnetic Effect for Draggable Elements */
        .draggable {
            cursor: grab;
            transition: all var(--transition-normal);
            position: relative;
        }

        .draggable:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }

        .draggable.dragging {
            cursor: grabbing;
            transform: scale(1.05) rotate(5deg);
            opacity: 0.8;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .magnetic-field {
            position: relative;
        }

        .magnetic-field::before {
            content: '';
            position: absolute;
            inset: -20px;
            border: 2px solid transparent;
            border-radius: var(--radius-xl);
            opacity: 0;
            transition: all var(--transition-smooth);
            background: linear-gradient(135deg,
                rgba(var(--accent-primary-rgb), 0.2),
                rgba(var(--accent-secondary-rgb), 0.2));
        }

        .magnetic-field.attracting::before {
            opacity: 1;
            inset: -10px;
            border-color: var(--accent-primary);
        }

        /* File Upload Preview */
        .file-preview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-xl);
            min-width: 320px;
            max-width: 500px;
            z-index: 1001;
            display: none;
            animation: slideInDown 0.5s var(--spring);
        }

        .file-preview.active {
            display: block;
        }

        .file-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
        }

        .file-preview-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .file-preview-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--glass-subtle);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .file-preview-close:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.1);
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--glass-subtle);
            border-radius: var(--radius-lg);
            transition: all var(--transition-normal);
        }

        .file-item:hover {
            background: var(--glass-bg);
            transform: translateY(-2px);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .file-remove {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-full);
            transition: all var(--transition-normal);
        }

        .file-remove:hover {
            background: var(--accent-error);
            color: white;
        }

        .file-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }

        .file-action-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn-cancel {
            background: var(--glass-subtle);
            color: var(--text-secondary);
        }

        .btn-cancel:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .btn-send {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(var(--accent-primary-rgb), 0.4);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes slideInDown {
            from {
                transform: translate(-50%, -60%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ===== FLOATING MODALS WITH CASCADE STACKING ===== */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s var(--spring);
        }

        .modal-overlay.active {
            display: flex;
        }

        .floating-modal {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            min-width: 400px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: all var(--transition-smooth);
            animation: modalEnter 0.5s var(--spring) forwards;
        }

        .floating-modal.stacked {
            transform: scale(0.95) translateY(-10px);
            opacity: 0.8;
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.3);
        }

        .floating-modal.stacked-deep {
            transform: scale(0.9) translateY(-20px);
            opacity: 0.6;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
            user-select: none;
            background: linear-gradient(135deg,
                rgba(var(--accent-primary-rgb), 0.1),
                rgba(var(--accent-secondary-rgb), 0.05));
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-icon {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .modal-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-control-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: var(--radius-full);
            background: var(--glass-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .modal-control-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.1);
        }

        .modal-control-btn.minimize:hover {
            background: var(--accent-warning);
        }

        .modal-control-btn.maximize:hover {
            background: var(--accent-success);
        }

        .modal-control-btn.close:hover {
            background: var(--accent-error);
        }

        .modal-body {
            padding: var(--spacing-xl);
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--glass-subtle);
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--glass-bg);
        }

        .modal-footer {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            background: var(--glass-subtle);
        }

        .modal-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .modal-btn-secondary {
            background: var(--glass-bg);
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
        }

        .modal-btn-secondary:hover {
            background: var(--glass-subtle);
            color: var(--text-primary);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(var(--accent-primary-rgb), 0.4);
        }

        /* Enhanced Cascade Stacking System */
        .modal-stack-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 2000;
        }

        .floating-modal.modal-stacked {
            transition: all var(--transition-normal) var(--spring);
            cursor: pointer;
        }

        .floating-modal.modal-stacked:hover {
            filter: blur(0px) brightness(1) !important;
            opacity: 1 !important;
            transform: translate(calc(-50% + var(--offset-x, 0px)), calc(-50% + var(--offset-y, 0px))) scale(1.02) !important;
        }

        .floating-modal.modal-minimized {
            transition: all var(--transition-normal) var(--spring);
            cursor: pointer;
            border: 2px solid var(--accent-primary);
            overflow: hidden;
        }

        .floating-modal.modal-minimized .modal-body,
        .floating-modal.modal-minimized .modal-footer {
            display: none;
        }

        .floating-modal.modal-minimized .modal-header {
            padding: var(--spacing-sm);
            border-bottom: none;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-modal.modal-minimized .modal-title {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .floating-modal.modal-minimized:hover {
            transform: translate(var(--taskbar-x), var(--taskbar-y)) scale(0.35) !important;
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .floating-modal.modal-maximized {
            border-radius: var(--radius-lg) !important;
            margin: 20px;
        }

        .floating-modal.modal-maximized .modal-body {
            max-height: calc(100vh - 200px);
        }

        /* Modal Animation Keyframes */
        @keyframes modalStackEnter {
            0% {
                transform: translate(-50%, -50%) scale(0.8) rotateY(20deg);
                opacity: 0;
                filter: blur(10px);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotateY(0deg);
                opacity: 1;
                filter: blur(0px);
            }
        }

        @keyframes modalStackExit {
            0% {
                transform: translate(-50%, -50%) scale(1) rotateY(0deg);
                opacity: 1;
                filter: blur(0px);
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8) rotateY(-20deg);
                opacity: 0;
                filter: blur(10px);
            }
        }

        @keyframes modalMinimize {
            0% {
                transform: translate(-50%, -50%) scale(1);
                border-radius: var(--radius-lg);
            }
            100% {
                transform: translate(var(--taskbar-x), var(--taskbar-y)) scale(0.3);
                border-radius: var(--radius-xl);
            }
        }

        @keyframes modalMaximize {
            0% {
                transform: translate(-50%, -50%) scale(1);
                width: auto;
                height: auto;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                width: calc(100vw - 40px);
                height: calc(100vh - 40px);
            }
        }

        /* Modal Focus Ring */
        .floating-modal:focus-within {
            outline: 2px solid var(--accent-primary);
            outline-offset: 4px;
        }

        /* Enhanced Controls */
        .modal-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            opacity: 0;
            transition: all var(--transition-fast);
        }

        .modal-header:hover .modal-controls {
            opacity: 1;
        }

        .modal-control-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: var(--radius-full);
            background: var(--glass-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .modal-control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: all var(--transition-fast);
            border-radius: inherit;
        }

        .modal-control-btn:hover::before {
            opacity: 0.1;
        }

        .modal-control-btn:hover {
            transform: scale(1.1);
        }

        .modal-control-btn.minimize:hover {
            background: #fbbf24;
            color: white;
        }

        .modal-control-btn.maximize:hover {
            background: #10b981;
            color: white;
        }

        .modal-control-btn.close:hover {
            background: #ef4444;
            color: white;
        }

        /* Stack Depth Indicators */
        .floating-modal::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .floating-modal.modal-stacked::after {
            display: flex;
            content: attr(data-stack-index);
        }

        /* Draggable Modal */
        .floating-modal.dragging {
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.5);
            z-index: 9999 !important;
        }

        .floating-modal.minimized {
            transform: scale(0) translateY(100px);
            opacity: 0;
            pointer-events: none;
        }

        .floating-modal.maximized {
            width: 95vw !important;
            height: 95vh !important;
            top: 2.5vh !important;
            left: 2.5vw !important;
            transform: none !important;
        }

        /* Specific Modal Types */
        .profile-modal .modal-body {
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: 600;
            margin: 0 auto var(--spacing-lg);
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .profile-status {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }

        .profile-info {
            text-align: left;
            margin-top: var(--spacing-lg);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .info-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .info-value {
            color: var(--text-primary);
        }

        /* Modal Animations */
        @keyframes modalEnter {
            from {
                transform: scale(0.8) translateY(40px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes modalExit {
            from {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            to {
                transform: scale(0.8) translateY(40px);
                opacity: 0;
            }
        }

        /* Notification Modal */
        .notification-modal {
            width: 320px;
            position: fixed;
            top: 20px;
            right: 20px;
            transform: translateX(100%);
            animation: slideInRight 0.5s var(--spring) forwards;
            z-index: 9999;
        }

        .notification-modal.hiding {
            animation: slideOutRight 0.5s var(--spring) forwards;
        }

        /* ===== PROFILE EDIT MODAL STYLES ===== */

        .profile-edit-container {
            display: flex;
            gap: var(--spacing-xl);
            align-items: flex-start;
        }

        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
            min-width: 140px;
        }

        .avatar-upload-area {
            position: relative;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .avatar-upload-area:hover {
            transform: scale(1.05);
        }

        .current-avatar {
            width: 120px;
            height: 120px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border: 4px solid var(--glass-border);
        }

        .current-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-placeholder {
            font-size: 48px;
            font-weight: 600;
            color: white;
        }

        .avatar-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all var(--transition-normal);
            border-radius: var(--radius-full);
            color: white;
            font-size: 14px;
            font-weight: 500;
            gap: var(--spacing-xs);
        }

        .avatar-upload-area:hover .avatar-overlay {
            opacity: 1;
        }

        .avatar-overlay svg {
            width: 24px;
            height: 24px;
        }

        .remove-avatar-btn {
            background: transparent;
            border: 1px solid var(--accent-error);
            color: var(--accent-error);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-lg);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .remove-avatar-btn:hover {
            background: var(--accent-error);
            color: white;
            transform: translateY(-2px);
        }

        .profile-form {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            padding: var(--spacing-md);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            background: var(--glass-subtle);
            backdrop-filter: blur(var(--glass-blur));
            color: var(--text-primary);
            font-size: 16px;
            transition: all var(--transition-normal);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.1);
            background: var(--glass-bg);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            font-size: 16px;
            color: var(--text-primary);
        }

        .form-checkbox {
            display: none;
        }

        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-sm);
            background: var(--glass-subtle);
            position: relative;
            transition: all var(--transition-normal);
        }

        .form-checkbox:checked + .checkbox-custom {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .form-checkbox:checked + .checkbox-custom::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* ===== USER SEARCH MODAL STYLES ===== */

        .user-search-modal {
            width: 500px;
            max-height: 600px;
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .search-input-group {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 48px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            background: var(--glass-subtle);
            backdrop-filter: blur(var(--glass-blur));
            color: var(--text-primary);
            font-size: 16px;
            transition: all var(--transition-normal);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.1);
            background: var(--glass-bg);
        }

        .search-results {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .search-results::-webkit-scrollbar {
            width: 6px;
        }

        .search-results::-webkit-scrollbar-track {
            background: transparent;
        }

        .search-results::-webkit-scrollbar-thumb {
            background: var(--glass-subtle);
            border-radius: 3px;
        }

        .search-placeholder {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .search-placeholder-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
        }

        .search-placeholder-text {
            font-size: 16px;
        }

        .user-result {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            background: var(--glass-subtle);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .user-result:hover {
            background: var(--glass-bg);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .user-result-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .user-result-info {
            flex: 1;
            min-width: 0;
        }

        .user-result-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .user-result-details {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .user-result-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            background: var(--accent-success);
        }

        .status-indicator.away {
            background: var(--accent-warning);
        }

        .status-indicator.busy {
            background: var(--accent-error);
        }

        .status-indicator.offline {
            background: var(--text-tertiary);
        }

        /* Draggable Modal Functionality */
        .floating-modal.draggable {
            position: fixed;
        }

        .modal-header.dragging {
            cursor: grabbing;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative;
            overflow: hidden;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: all var(--transition-normal);
            border-radius: var(--radius-lg);
        }

        .theme-toggle:hover::before {
            opacity: 1;
        }

        .theme-toggle svg {
            position: relative;
            z-index: 1;
        }

        /* ===== MESSAGES AREA ===== */

        .messages-container {
            flex: 1;
            padding: var(--spacing-xl);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            scroll-behavior: smooth;
            position: relative;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--glass-subtle);
            border-radius: 4px;
            backdrop-filter: blur(10px);
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--glass-bg);
        }

        /* Message Group */
        .message-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            animation: fadeInUp 0.6s var(--spring);
        }

        .message-group.sent {
            align-items: flex-end;
        }

        .message-group.received {
            align-items: flex-start;
        }

        /* Message Bubble */
        .message-bubble {
            max-width: 70%;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-md) var(--spacing-lg);
            position: relative;
            transition: all var(--transition-normal);
            box-shadow: var(--glass-shadow);
            cursor: pointer;
        }

        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }

        .message-group.sent .message-bubble {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            opacity: 0.8;
        }

        .message-avatar {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-quaternary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 10px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-left: auto;
        }

        .message-content {
            font-size: 16px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-group.sent .message-content {
            color: white;
        }

        /* Message States */
        .message-states {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-xs);
            opacity: 0.7;
            font-size: 12px;
        }

        .message-group.sent .message-states {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-check {
            width: 12px;
            height: 12px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* Reactions */
        .message-reactions {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .reaction {
            background: var(--glass-subtle);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-full);
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .reaction:hover {
            transform: scale(1.1);
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .reaction-emoji {
            font-size: 14px;
        }

        .reaction-count {
            font-weight: 600;
        }

        /* ===== MESSAGE INPUT AREA ===== */

        .message-input-area {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-top: 1px solid var(--glass-border);
            padding: var(--spacing-lg) var(--spacing-xl);
            position: relative;
            z-index: 70;
            box-shadow: var(--glass-shadow);
        }

        .input-container {
            background: var(--glass-subtle);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-md);
            display: flex;
            align-items: flex-end;
            gap: var(--spacing-md);
            transition: all var(--transition-normal);
            backdrop-filter: blur(var(--glass-blur));
            position: relative;
        }

        .input-container:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--neon-glow);
            transform: scale(1.01);
        }

        .input-actions-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .input-action-btn {
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--text-secondary);
        }

        .input-action-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 4px 20px var(--neon-glow);
        }

        .input-action-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            line-height: 1.5;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            padding: var(--spacing-sm) 0;
        }

        .message-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-button {
            width: 44px;
            height: 44px;
            background: var(--accent-primary);
            border: none;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 20px var(--neon-glow);
        }

        .send-button:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 8px 32px var(--neon-glow);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* ===== ANIMATIONS ===== */

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* ===== ENHANCED RESPONSIVE DESIGN SYSTEM ===== */

        /* Enhanced Breakpoints with Perfect Mathematical Progression */
        :root {
            --breakpoint-2xs: 360px;  /* Small phones */
            --breakpoint-xs: 480px;   /* Large phones */
            --breakpoint-sm: 640px;   /* Small tablets */
            --breakpoint-md: 768px;   /* Tablets */
            --breakpoint-lg: 1024px;  /* Small laptops */
            --breakpoint-xl: 1280px;  /* Laptops */
            --breakpoint-2xl: 1536px; /* Large screens */
            --breakpoint-3xl: 1920px; /* Ultra-wide */
        }

        /* Container Query Support for Adaptive Components */
        @supports (container-type: inline-size) {
            .chat-container {
                container-type: inline-size;
            }

            .message-container {
                container-type: inline-size;
            }

            .sidebar-container {
                container-type: inline-size;
            }
        }

        /* Ultra-wide screens (1920px+) - Premium experience */
        @media (min-width: 1920px) {
            :root {
                --sidebar-width: 320px;
                --chat-list-width: 380px;
            }

            .app-container {
                max-width: 2400px;
                margin: 0 auto;
                padding: 0 var(--spacing-2xl);
            }

            .message-bubble {
                max-width: 65%;
                font-size: var(--text-lg);
            }
        }

        /* Large screens (1536px+) - Desktop optimal */
        @media (min-width: 1536px) and (max-width: 1919px) {
            :root {
                --sidebar-width: 300px;
                --chat-list-width: 360px;
            }

            .message-bubble {
                max-width: 70%;
            }
        }

        /* Laptops (1280px+) - Standard desktop */
        @media (min-width: 1280px) and (max-width: 1535px) {
            :root {
                --sidebar-width: 280px;
                --chat-list-width: 340px;
            }
        }

        /* Small laptops (1024px+) - Compact desktop */
        @media (min-width: 1024px) and (max-width: 1279px) {
            :root {
                --sidebar-width: 260px;
                --chat-list-width: 320px;
            }

            .message-bubble {
                font-size: var(--text-sm);
            }
        }

        /* Tablets portrait (768px+) - Sidebar transitions */
        @media (min-width: 768px) and (max-width: 1023px) {
            .sidebar {
                width: var(--sidebar-collapsed);
                transition: width var(--transition-slow) var(--spring);
            }

            .sidebar .user-info,
            .sidebar .nav-text,
            .sidebar .nav-badge {
                opacity: 0;
                transform: translateX(-20px);
                transition: all var(--transition-normal) var(--spring);
            }

            .chat-list-panel {
                width: 300px;
                box-shadow: var(--glass-shadow);
            }

            .message-bubble {
                max-width: 80%;
                font-size: var(--text-sm);
            }
        }

        /* Small tablets (640px+) - Overlay mode */
        @media (min-width: 640px) and (max-width: 767px) {
            .chat-list-panel {
                position: absolute;
                top: 0;
                left: var(--sidebar-collapsed);
                bottom: 0;
                width: 280px;
                z-index: 95;
                transform: translateX(-100%);
                transition: transform var(--transition-normal) var(--spring);
                backdrop-filter: blur(20px);
                box-shadow: var(--glass-shadow-strong);
            }

            .chat-list-panel.open {
                transform: translateX(0);
            }

            .sidebar {
                width: var(--sidebar-collapsed);
            }

            .message-bubble {
                max-width: 85%;
                padding: var(--spacing-md) var(--spacing-lg);
            }
        }

        /* Large phones (480px+) - Mobile optimized */
        @media (min-width: 480px) and (max-width: 639px) {
            .sidebar {
                width: 64px;
                padding: var(--spacing-sm);
            }

            .chat-header {
                padding: var(--spacing-md) var(--spacing-lg);
                height: 64px;
            }

            .messages-container {
                padding: var(--spacing-md);
            }

            .message-input-area {
                padding: var(--spacing-md) var(--spacing-lg);
            }

            .message-bubble {
                max-width: 88%;
                font-size: var(--text-sm);
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .chat-list-panel {
                width: 260px;
            }
        }

        /* Small phones (360px+) - Minimal interface */
        @media (max-width: 479px) {
            .sidebar {
                width: 56px;
                padding: var(--spacing-xs);
            }

            .chat-header {
                padding: var(--spacing-sm) var(--spacing-md);
                height: 56px;
            }

            .messages-container {
                padding: var(--spacing-sm);
            }

            .message-input-area {
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .message-bubble {
                max-width: 92%;
                font-size: var(--text-xs);
                padding: var(--spacing-xs) var(--spacing-sm);
                border-radius: var(--radius-md);
            }

            .chat-list-panel {
                width: 240px;
                left: 56px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
            }

            .floating-button {
                width: 48px;
                height: 48px;
                bottom: var(--spacing-lg);
                right: var(--spacing-md);
            }
        }

        /* Container Queries for Adaptive Components */
        @container (min-width: 400px) {
            .message-bubble {
                padding: var(--spacing-md) var(--spacing-lg);
            }
        }

        @container (max-width: 300px) {
            .message-bubble {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: var(--text-xs);
            }
        }

        /* High DPI displays - Enhanced clarity */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .glass-effect {
                backdrop-filter: blur(calc(var(--glass-blur) * 1.2));
            }

            .text-shadow {
                text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
        }

        /* Landscape orientation optimizations */
        @media (orientation: landscape) and (max-height: 500px) {
            .chat-header {
                height: 48px;
                padding: var(--spacing-xs) var(--spacing-md);
            }

            .message-input-area {
                padding: var(--spacing-xs) var(--spacing-md);
            }

            .sidebar {
                padding: var(--spacing-xs);
            }
        }

        /* ===== LOADING STATES ===== */

        .loading-skeleton {
            background: linear-gradient(90deg, var(--glass-subtle) 25%, var(--glass-bg) 50%, var(--glass-subtle) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* ===== UTILITY CLASSES ===== */

        .hidden {
            display: none !important;
        }

        .visually-hidden {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
        }

        .neon-glow {
            box-shadow: 0 0 20px var(--neon-glow);
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }

        /* ===== DRAG-AND-DROP ANIMATIONS ===== */

        @keyframes dropBounce {
            0% {
                transform: scale(1.1) rotate(3deg);
                box-shadow: 0 8px 40px var(--neon-glow);
            }
            50% {
                transform: scale(0.95) rotate(-1deg);
                box-shadow: 0 4px 20px var(--neon-glow);
            }
            100% {
                transform: scale(1) rotate(0deg);
                box-shadow: none;
            }
        }

        @keyframes magneticParticle {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes magneticPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 var(--accent-primary);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px 10px transparent;
            }
        }

        /* Magnetic Zone Styles */
        .nav-item.magnetic-zone {
            position: relative;
            overflow: visible;
        }

        .nav-item.magnetic-zone::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast) var(--spring);
            pointer-events: none;
        }

        .nav-item.magnetic-active::before {
            border-color: var(--accent-primary);
            background: radial-gradient(circle, transparent 60%, var(--accent-primary)20);
            animation: magneticPulse 1s infinite ease-in-out;
        }

        .nav-item.dragging {
            cursor: grabbing !important;
            user-select: none;
            position: relative;
            z-index: 1000;
        }

        .nav-item.dragging::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                var(--accent-primary)20,
                var(--accent-secondary)20);
            border-radius: var(--radius-lg);
            pointer-events: none;
            animation: ripple 1s infinite ease-out;
        }

        .nav-item-placeholder {
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-item-placeholder::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Enhanced drag feedback */
        .sidebar-nav.drag-active {
            background: var(--glass-subtle);
            backdrop-filter: blur(20px);
            border: 1px solid var(--accent-primary);
            border-radius: var(--radius-lg);
            transition: all var(--transition-normal) var(--spring);
        }

        .sidebar-nav.drag-active .nav-item:not(.dragging) {
            opacity: 0.7;
            transform: scale(0.98);
            transition: all var(--transition-fast) var(--spring);
        }

        .sidebar-nav.drag-active .nav-item:not(.dragging):hover {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 4px 20px var(--neon-glow);
        }

        /* ===== DIVINE THEME MORPHING ANIMATIONS ===== */

        @keyframes morphParticle {
            0% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0) rotate(360deg);
            }
        }

        @keyframes themeWave {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0.8;
            }
            50% {
                opacity: 0.4;
            }
            100% {
                transform: translate(-50%, -50%) scale(20);
                opacity: 0;
            }
        }

        @keyframes themeRipple {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0.6;
            }
            100% {
                transform: translate(-50%, -50%) scale(30);
                opacity: 0;
            }
        }

        /* Theme Morphing States */
        .theme-morphing {
            position: relative;
            overflow: hidden;
        }

        .theme-morphing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%
            );
            transform: translateX(-100%);
            animation: shimmer 0.8s ease-out;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Light to Dark Morphing */
        .morph-light-to-dark {
            animation: morphToDark 0.8s ease-out;
        }

        @keyframes morphToDark {
            0% {
                filter: brightness(1) hue-rotate(0deg) saturate(1);
            }
            25% {
                filter: brightness(1.2) hue-rotate(10deg) saturate(1.1);
            }
            50% {
                filter: brightness(0.8) hue-rotate(180deg) saturate(0.9);
            }
            75% {
                filter: brightness(0.6) hue-rotate(270deg) saturate(1.2);
            }
            100% {
                filter: brightness(1) hue-rotate(360deg) saturate(1);
            }
        }

        /* Dark to Light Morphing */
        .morph-dark-to-light {
            animation: morphToLight 0.8s ease-out;
        }

        @keyframes morphToLight {
            0% {
                filter: brightness(1) hue-rotate(0deg) saturate(1);
            }
            25% {
                filter: brightness(0.8) hue-rotate(-10deg) saturate(1.1);
            }
            50% {
                filter: brightness(1.3) hue-rotate(-180deg) saturate(0.9);
            }
            75% {
                filter: brightness(1.5) hue-rotate(-270deg) saturate(1.2);
            }
            100% {
                filter: brightness(1) hue-rotate(-360deg) saturate(1);
            }
        }

        /* Enhanced Theme Transition Effects */
        .theme-morph-overlay {
            background: radial-gradient(
                circle at center,
                var(--accent-primary) 0%,
                var(--accent-secondary) 30%,
                transparent 70%
            );
            opacity: 0.1;
            mix-blend-mode: soft-light;
        }

        /* Floating Orb Morph Effects */
        .floating-orb.theme-morphing {
            animation: orbMorph 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes orbMorph {
            0% {
                transform: scale(1) rotate(0deg);
                filter: hue-rotate(0deg);
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                filter: hue-rotate(180deg);
            }
            100% {
                transform: scale(1) rotate(360deg);
                filter: hue-rotate(360deg);
            }
        }

        /* Modal Morph Effects */
        .floating-modal.theme-morphing {
            animation: modalMorph 0.8s ease-out;
        }

        @keyframes modalMorph {
            0% {
                transform: translate(-50%, -50%) scale(1) rotateY(0deg);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05) rotateY(10deg);
                opacity: 0.9;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotateY(0deg);
                opacity: 1;
            }
        }

        /* Sidebar Morph Effects */
        .sidebar.theme-morphing {
            animation: sidebarMorph 0.8s ease-out;
        }

        @keyframes sidebarMorph {
            0% {
                transform: translateX(0);
                filter: blur(0px);
            }
            50% {
                transform: translateX(5px);
                filter: blur(1px);
            }
            100% {
                transform: translateX(0);
                filter: blur(0px);
            }
        }

        /* Chat Area Morph Effects */
        .chat-area.theme-morphing {
            animation: chatAreaMorph 0.8s ease-out;
        }

        @keyframes chatAreaMorph {
            0% {
                transform: scale(1);
                filter: contrast(1);
            }
            50% {
                transform: scale(1.01);
                filter: contrast(1.1);
            }
            100% {
                transform: scale(1);
                filter: contrast(1);
            }
        }

        /* Navigation Item Morph Effects */
        .nav-item.theme-morphing {
            animation: navItemMorph 0.6s ease-out;
        }

        @keyframes navItemMorph {
            0% {
                transform: translateX(0) scale(1);
            }
            50% {
                transform: translateX(3px) scale(1.02);
            }
            100% {
                transform: translateX(0) scale(1);
            }
        }

        /* Chat Item Morph Effects */
        .chat-item.theme-morphing {
            animation: chatItemMorph 0.6s ease-out;
        }

        @keyframes chatItemMorph {
            0% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-2px) scale(1.01);
            }
            100% {
                transform: translateY(0) scale(1);
            }
        }

        /* Universal Theme Transition */
        * {
            transition: color 0.5s ease, background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        /* Prevent transition on theme elements during morph */
        .theme-morphing * {
            transition: none !important;
        }

        /* ===== SECURITY ALERT STYLES ===== */

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .security-alert {
            font-family: var(--font-primary);
            border-left: 4px solid #dc2626;
            backdrop-filter: blur(10px);
        }

        .security-alert:hover {
            transform: translateX(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* ===== DIVINE POLISH ANIMATIONS ===== */

        @keyframes microParticle {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            25% { filter: hue-rotate(90deg); }
            50% { filter: hue-rotate(180deg); }
            75% { filter: hue-rotate(270deg); }
            100% { filter: hue-rotate(360deg); }
        }

        @keyframes divineGlow {
            0%, 100% {
                box-shadow: 0 0 20px var(--accent-primary);
            }
            50% {
                box-shadow: 0 0 40px var(--accent-secondary);
            }
        }

        /* Performance optimizations */
        .optimized-element {
            contain: layout style paint;
            will-change: transform, opacity;
        }

        /* Intersection observer animations */
        .fade-in-element {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-in-element.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Enhanced focus indicators */
        .enhanced-focus:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(var(--accent-primary-rgb), 0.2);
        }

        /* Accessibility improvements */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--accent-primary);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 10000;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .nav-item, .chat-item, .floating-modal {
                border: 2px solid;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Divine perfection states */
        .divine-perfect {
            animation: divineGlow 2s infinite ease-in-out;
        }

        .divine-shimmer {
            position: relative;
            overflow: hidden;
        }

        .divine-shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        /* ===== MOBILE BOTTOM NAVIGATION ===== */

        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-top: 1px solid var(--glass-border);
            padding: var(--spacing-md);
            z-index: 100;
        }

        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--text-secondary);
            text-decoration: none;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .mobile-nav-item svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .mobile-nav-item span {
            font-size: 12px;
            font-weight: 500;
        }

        @media (max-width: 640px) {
            .mobile-nav {
                display: block;
            }

            .app-container {
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Floating Background Elements -->
    <div class="bg-elements">
        <div class="floating-orb"></div>
        <div class="floating-orb"></div>
        <div class="floating-orb"></div>
    </div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Professional Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="user-profile" id="userProfile">
                    <div class="user-avatar">DU</div>
                    <div class="user-info">
                        <div class="user-name">Demo User</div>
                        <div class="user-status">
                            <div class="status-indicator"></div>
                            <span>Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-nav="chats">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <span class="nav-text">Chats</span>
                    <div class="nav-badge">3</div>
                </a>

                <a href="#" class="nav-item" data-nav="groups">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                        </svg>
                    </div>
                    <span class="nav-text">Groups</span>
                    <div class="nav-badge">7</div>
                </a>

                <a href="#" class="nav-item" data-nav="contacts">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <span class="nav-text">Contacts</span>
                </a>

                <a href="#" class="nav-item" data-nav="files">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/>
                            <polyline points="13,2 13,9 20,9"/>
                        </svg>
                    </div>
                    <span class="nav-text">Files</span>
                </a>

                <a href="#" class="nav-item" data-nav="profile" id="profileBtn">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <span class="nav-text">Profile</span>
                </a>

                <a href="#" class="nav-item" data-nav="search" id="findUsersBtn">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                    </div>
                    <span class="nav-text">Find Users</span>
                </a>

                <a href="#" class="nav-item" data-nav="settings">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                        </svg>
                    </div>
                    <span class="nav-text">Settings</span>
                </a>
            </nav>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg viewBox="0 0 24 24">
                        <polyline points="9,18 15,12 9,6"/>
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Chat List Panel -->
        <section class="chat-list-panel" id="chatListPanel">
            <!-- Chat List Header -->
            <div class="chat-list-header">
                <div class="chat-list-title">
                    <h2>Chats</h2>
                    <button class="new-chat-btn" id="newChatBtn">
                        <svg viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </button>
                </div>

                <!-- Global Search -->
                <div class="global-search">
                    <input type="text" class="search-input" id="globalSearch" placeholder="Search conversations...">
                    <div class="search-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Chat List -->
            <div class="chat-list" id="chatList">
                <!-- Demo Chat Items -->
                <a href="#" class="chat-item active" data-chat="1">
                    <div class="chat-avatar">AI</div>
                    <div class="chat-info">
                        <div class="chat-name">AI Assistant</div>
                        <div class="chat-preview">How can I help you today?</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">2:30 PM</div>
                        <div class="chat-unread">2</div>
                    </div>
                </a>

                <a href="#" class="chat-item" data-chat="2">
                    <div class="chat-avatar">GE</div>
                    <div class="chat-info">
                        <div class="chat-name">General</div>
                        <div class="chat-preview">Welcome to Talk pAI!</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">1:45 PM</div>
                    </div>
                </a>

                <a href="#" class="chat-item" data-chat="3">
                    <div class="chat-avatar">TC</div>
                    <div class="chat-info">
                        <div class="chat-name">Team Chat</div>
                        <div class="chat-preview">Great work everyone!</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">12:15 PM</div>
                        <div class="chat-unread">5</div>
                    </div>
                </a>
            </div>
        </section>

        <!-- Main Chat Area -->
        <main class="main-chat">
            <!-- Chat Header -->
            <header class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-header-avatar">AI</div>
                    <div class="chat-header-details">
                        <div class="chat-header-name">AI Assistant</div>
                        <div class="chat-header-status">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <span>AI is typing...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-header-actions">
                    <button class="header-action-btn" id="searchBtn">
                        <svg viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                    </button>

                    <button class="header-action-btn" id="callBtn">
                        <svg viewBox="0 0 24 24">
                            <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                        </svg>
                    </button>

                    <button class="header-action-btn" id="videoBtn">
                        <svg viewBox="0 0 24 24">
                            <polygon points="23 7 16 12 23 17 23 7"/>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                        </svg>
                    </button>

                    <button class="header-action-btn theme-toggle" id="themeToggle">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- Demo Messages -->
                <div class="message-group received">
                    <div class="message-bubble">
                        <div class="message-header">
                            <div class="message-avatar">AI</div>
                            <span class="message-sender">AI Assistant</span>
                            <span class="message-time">2:28 PM</span>
                        </div>
                        <div class="message-content">
                            Welcome to Talk pAI! 🚀 This is an award-winning ultra-modern messaging platform with glassmorphism design, smooth animations, and premium micro-interactions. How can I help you today?
                        </div>
                        <div class="message-reactions">
                            <div class="reaction">
                                <span class="reaction-emoji">👋</span>
                                <span class="reaction-count">2</span>
                            </div>
                            <div class="reaction">
                                <span class="reaction-emoji">🔥</span>
                                <span class="reaction-count">1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="message-group sent">
                    <div class="message-bubble">
                        <div class="message-content">
                            This looks absolutely incredible! The glassmorphism effects and smooth animations are perfect. 🤩
                        </div>
                        <div class="message-states">
                            <svg class="message-check" viewBox="0 0 24 24">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                            <svg class="message-check" viewBox="0 0 24 24">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                            <span>Read</span>
                        </div>
                    </div>
                </div>

                <div class="message-group received">
                    <div class="message-bubble">
                        <div class="message-header">
                            <div class="message-avatar">AI</div>
                            <span class="message-sender">AI Assistant</span>
                            <span class="message-time">2:30 PM</span>
                        </div>
                        <div class="message-content">
                            Thank you! ✨ I'm designed with the latest design trends: glassmorphism, neumorphism, spring animations, and beautiful micro-interactions. Every element is crafted for an award-winning user experience!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Input Area -->
            <div class="message-input-area">
                <div class="input-container">
                    <div class="input-actions-left">
                        <button class="input-action-btn" id="emojiBtn">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9"/>
                                <line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                        </button>

                        <button class="input-action-btn" id="attachBtn">
                            <svg viewBox="0 0 24 24">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66L9.64 16.2a2 2 0 01-2.83-2.83l8.49-8.49"/>
                            </svg>
                        </button>

                        <button class="input-action-btn" id="voiceBtn">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
                                <path d="M19 10v2a7 7 0 01-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="23"/>
                                <line x1="8" y1="23" x2="16" y2="23"/>
                            </svg>
                        </button>
                    </div>

                    <textarea class="message-input" id="messageInput" placeholder="Type your message..." rows="1"></textarea>

                    <button class="send-button" id="sendBtn">
                        <svg viewBox="0 0 24 24">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22,2 15,22 11,13 2,9 22,2"/>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="#" class="mobile-nav-item active">
                <svg viewBox="0 0 24 24">
                    <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <span>Chats</span>
            </a>
            <a href="#" class="mobile-nav-item">
                <svg viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                </svg>
                <span>Groups</span>
            </a>
            <a href="#" class="mobile-nav-item">
                <svg viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Contacts</span>
            </a>
            <a href="#" class="mobile-nav-item">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                </svg>
                <span>Settings</span>
            </a>
        </div>
    </nav>

    <!-- Voice & Video Call Interface -->
    <div class="call-overlay" id="callOverlay">
        <div class="call-interface">
            <div class="call-header">
                <div class="call-user-info">
                    <div class="call-avatar" id="callAvatar">AI</div>
                    <div class="call-user-name" id="callUserName">AI Assistant</div>
                    <div class="call-status" id="callStatus">
                        <span>Calling...</span>
                    </div>
                    <div class="call-timer" id="callTimer" style="display: none;">00:00</div>
                </div>
            </div>

            <div class="video-container" id="videoContainer" style="display: none;">
                <video class="main-video" id="remoteVideo" autoplay playsinline></video>
                <div class="local-video" id="localVideoContainer">
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <div class="screen-share-indicator" id="screenShareIndicator">
                    Screen sharing
                </div>
            </div>

            <div class="call-controls" id="callControls">
                <!-- Voice Call Controls -->
                <div class="voice-controls" id="voiceControls">
                    <button class="call-control-btn btn-mute" id="muteBtn">
                        <svg viewBox="0 0 24 24">
                            <path d="m9 9 3 3m0 0 3 3m-3-3 3-3m-3 3-3 3m-1-8a5 5 0 0 1 10 0v8.5"/>
                            <line x1="12" y1="17" x2="12" y2="17"/>
                        </svg>
                    </button>

                    <button class="call-control-btn btn-speaker" id="speakerBtn">
                        <svg viewBox="0 0 24 24">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="m19.07 4.93-1.41 1.41A5 5 0 0 1 20 12a5 5 0 0 1-2.34 4.24l1.41 1.41A7 7 0 0 0 22 12a7 7 0 0 0-2.93-5.07z"/>
                            <path d="m15.54 8.46-1.41 1.41A3 3 0 0 1 16 12a3 3 0 0 1-1.87 2.13l1.41 1.41A5 5 0 0 0 18 12a5 5 0 0 0-2.46-4.54z"/>
                        </svg>
                    </button>

                    <button class="call-control-btn btn-end-call" id="endCallBtn">
                        <svg viewBox="0 0 24 24">
                            <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <!-- Video Call Controls -->
                <div class="video-controls" id="videoControls" style="display: none;">
                    <button class="call-control-btn btn-mute" id="videoMuteBtn">
                        <svg viewBox="0 0 24 24">
                            <path d="m9 9 3 3m0 0 3 3m-3-3 3-3m-3 3-3 3m-1-8a5 5 0 0 1 10 0v8.5"/>
                            <line x1="12" y1="17" x2="12" y2="17"/>
                        </svg>
                    </button>

                    <button class="call-control-btn btn-camera" id="cameraBtn">
                        <svg viewBox="0 0 24 24">
                            <polygon points="23 7 16 12 23 17 23 7"/>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                        </svg>
                    </button>

                    <button class="call-control-btn btn-screen-share" id="screenShareBtn">
                        <svg viewBox="0 0 24 24">
                            <rect x="2" y="4" width="20" height="12" rx="2"/>
                            <polyline points="8,21 16,21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                    </button>

                    <button class="call-control-btn btn-more" id="moreBtn">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="1"/>
                            <circle cx="12" cy="5" r="1"/>
                            <circle cx="12" cy="19" r="1"/>
                        </svg>
                    </button>

                    <button class="call-control-btn btn-end-call" id="videoEndCallBtn">
                        <svg viewBox="0 0 24 24">
                            <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <!-- Incoming Call Controls -->
                <div class="incoming-controls" id="incomingControls" style="display: none;">
                    <button class="call-control-btn btn-decline" id="declineBtn">
                        <svg viewBox="0 0 24 24">
                            <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>

                    <button class="call-control-btn btn-answer" id="answerBtn">
                        <svg viewBox="0 0 24 24">
                            <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Notification -->
    <div class="call-notification" id="callNotification">
        <div class="call-notification-header">
            <div class="call-notification-avatar" id="notificationAvatar">AI</div>
            <div class="call-notification-info">
                <div class="call-notification-name" id="notificationName">AI Assistant</div>
                <div class="call-notification-type" id="notificationType">Incoming voice call</div>
            </div>
        </div>
        <div class="call-notification-actions">
            <button class="call-notification-btn btn-notification-decline" id="notificationDecline">
                <svg viewBox="0 0 24 24">
                    <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <button class="call-notification-btn btn-notification-answer" id="notificationAnswer">
                <svg viewBox="0 0 24 24">
                    <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 714.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Drag & Drop Zone -->
    <div class="drag-drop-zone" id="dragDropZone">
        <div class="drop-area" id="dropArea">
            <div class="drop-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
            </div>
            <div class="drop-text">
                <div class="drop-title">Drop files here</div>
                <div class="drop-subtitle">Drag and drop files to upload them instantly</div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div class="file-preview" id="filePreview">
        <div class="file-preview-header">
            <div class="file-preview-title">File Upload</div>
            <button class="file-preview-close" id="filePreviewClose">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="file-list" id="fileList">
            <!-- Files will be dynamically added here -->
        </div>
        <div class="file-actions">
            <button class="file-action-btn btn-cancel" id="fileCancelBtn">Cancel</button>
            <button class="file-action-btn btn-send" id="fileSendBtn">Send Files</button>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal-overlay" id="profileModalOverlay">
        <div class="floating-modal profile-modal" id="profileModal">
            <div class="modal-header" id="profileModalHeader">
                <div class="modal-title">
                    <div class="modal-icon">👤</div>
                    Edit Profile
                </div>
                <div class="modal-controls">
                    <button class="modal-control-btn minimize" id="profileMinimizeBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="6" y1="12" x2="18" y2="12"/>
                        </svg>
                    </button>
                    <button class="modal-control-btn maximize" id="profileMaximizeBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                        </svg>
                    </button>
                    <button class="modal-control-btn close" id="profileCloseBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="profile-edit-container">
                    <!-- Avatar Section -->
                    <div class="avatar-section">
                        <div class="avatar-upload-area" id="avatarUploadArea">
                            <div class="current-avatar" id="currentAvatar">
                                <img id="avatarImage" src="" alt="Avatar" style="display: none;">
                                <div class="avatar-placeholder" id="avatarPlaceholder">AI</div>
                            </div>
                            <div class="avatar-overlay">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                <span>Change Avatar</span>
                            </div>
                        </div>
                        <button class="remove-avatar-btn" id="removeAvatarBtn">Remove Avatar</button>
                    </div>

                    <!-- Profile Form -->
                    <div class="profile-form">
                        <div class="form-group">
                            <label for="profileDisplayName">Display Name</label>
                            <input type="text" id="profileDisplayName" class="form-input" placeholder="Enter display name">
                        </div>

                        <div class="form-group">
                            <label for="profileNickname">Nickname</label>
                            <input type="text" id="profileNickname" class="form-input" placeholder="Enter nickname" readonly>
                            <small class="form-hint">Nickname cannot be changed</small>
                        </div>

                        <div class="form-group">
                            <label for="profileEmail">Email</label>
                            <input type="email" id="profileEmail" class="form-input" placeholder="Enter email">
                        </div>

                        <div class="form-group">
                            <label for="profileBio">Bio</label>
                            <textarea id="profileBio" class="form-textarea" placeholder="Tell us about yourself..." rows="3"></textarea>
                            <div class="char-counter">
                                <span id="bioCharCount">0</span>/500
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="profileStatus">Status</label>
                            <select id="profileStatus" class="form-select">
                                <option value="online">🟢 Online</option>
                                <option value="away">🟡 Away</option>
                                <option value="busy">🔴 Busy</option>
                                <option value="invisible">⚫ Invisible</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="profileTheme">Theme Preference</label>
                            <select id="profileTheme" class="form-select">
                                <option value="light">☀️ Light</option>
                                <option value="dark">🌙 Dark</option>
                                <option value="auto">🔄 Auto</option>
                            </select>
                        </div>

                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="notificationsEnabled" class="form-checkbox">
                                <span class="checkbox-custom"></span>
                                Enable notifications
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="profileCancelBtn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="profileSaveBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17,21 17,13 7,13 7,21"/>
                        <polyline points="7,3 7,8 15,8"/>
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- User Search Modal -->
    <div class="modal-overlay" id="userSearchModalOverlay">
        <div class="floating-modal user-search-modal" id="userSearchModal">
            <div class="modal-header" id="userSearchModalHeader">
                <div class="modal-title">
                    <div class="modal-icon">🔍</div>
                    Find Users
                </div>
                <div class="modal-controls">
                    <button class="modal-control-btn close" id="userSearchCloseBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="search-container">
                    <div class="search-input-group">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <input type="text" id="userSearchInput" class="search-input" placeholder="Search by nickname, name, or email...">
                    </div>
                    <div class="search-results" id="searchResults">
                        <div class="search-placeholder">
                            <div class="search-placeholder-icon">👥</div>
                            <div class="search-placeholder-text">Start typing to search for users</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load External Scripts -->
    <script src="/theme-customizer.js"></script>
    <script src="/emoji-picker.js"></script>

    <!-- Enhanced Modular JavaScript Architecture -->
    <script src="/js/utils/error-handler.js"></script>
    <script src="/js/core/messenger-core.js"></script>
    <script src="/js/modules/ui-events.js"></script>
    <script src="/js/modules/call-manager.js"></script>

    <script>
        // ===== AWARD-WINNING ULTRA-MODERN MESSENGER =====

        class TalkPAIMessenger {
            constructor() {
                this.currentTheme = localStorage.getItem('talkpai-theme') || 'light';
                this.sidebarCollapsed = localStorage.getItem('talkpai-sidebar-collapsed') === 'true';
                this.chatListOpen = false;
                this.currentChat = '1';
                this.isTyping = false;
                this.messages = [];

                // Call state
                this.callState = 'idle'; // idle, calling, connected, incoming
                this.callType = null; // voice, video
                this.callTimer = null;
                this.callStartTime = null;
                this.localStream = null;
                this.remoteStream = null;
                this.isMuted = false;
                this.isVideoOn = true;
                this.isSpeakerOn = false;
                this.isScreenSharing = false;

                // Drag and drop state
                this.dragCounter = 0;
                this.selectedFiles = [];
                this.isDragActive = false;

                this.init();
            }

            init() {
                this.setupTheme();
                this.setupSidebar();
                this.setupDragAndDrop();
                this.bindEvents();
                this.autoResize();
                this.loadDemoData();

                // Initialize external components
                if (window.themeCustomizer) {
                    window.themeCustomizer.onThemeChange = (theme) => {
                        this.applyTheme(theme);
                    };
                }

                console.log('🚀 Talk pAI Messenger initialized with award-winning design!');
            }

            setupTheme() {
                document.body.setAttribute('data-theme', this.currentTheme);
            }

            setupSidebar() {
                const sidebar = document.getElementById('sidebar');
                if (this.sidebarCollapsed) {
                    sidebar.classList.add('collapsed');
                }
            }

            bindEvents() {
                // Sidebar toggle
                document.getElementById('sidebarToggle')?.addEventListener('click', () => {
                    this.toggleSidebar();
                });

                // Theme toggle
                document.getElementById('themeToggle')?.addEventListener('click', () => {
                    if (window.themeCustomizer) {
                        window.themeCustomizer.showCustomizer();
                    } else {
                        this.toggleTheme();
                    }
                });

                // Navigation items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.switchNavigation(item.dataset.nav);
                    });
                });

                // Chat items
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.selectChat(item.dataset.chat);
                    });
                });

                // Message input
                const messageInput = document.getElementById('messageInput');
                messageInput?.addEventListener('input', () => {
                    this.autoResizeTextarea(messageInput);
                    this.handleTyping();
                });

                messageInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Send button
                document.getElementById('sendBtn')?.addEventListener('click', () => {
                    this.sendMessage();
                });

                // Input action buttons
                document.getElementById('emojiBtn')?.addEventListener('click', () => {
                    this.openEmojiPicker();
                });

                document.getElementById('attachBtn')?.addEventListener('click', () => {
                    this.openFileDialog();
                });

                document.getElementById('voiceBtn')?.addEventListener('click', () => {
                    this.toggleVoiceRecording();
                });

                // Global search
                document.getElementById('globalSearch')?.addEventListener('input', (e) => {
                    this.handleGlobalSearch(e.target.value);
                });

                // New chat button
                document.getElementById('newChatBtn')?.addEventListener('click', () => {
                    this.createNewChat();
                });

                // Call buttons
                document.getElementById('callBtn')?.addEventListener('click', () => {
                    this.startVoiceCall();
                });

                document.getElementById('videoBtn')?.addEventListener('click', () => {
                    this.startVideoCall();
                });

                // Call control buttons
                document.getElementById('muteBtn')?.addEventListener('click', () => {
                    this.toggleMute();
                });

                document.getElementById('videoMuteBtn')?.addEventListener('click', () => {
                    this.toggleMute();
                });

                document.getElementById('speakerBtn')?.addEventListener('click', () => {
                    this.toggleSpeaker();
                });

                document.getElementById('cameraBtn')?.addEventListener('click', () => {
                    this.toggleVideo();
                });

                document.getElementById('screenShareBtn')?.addEventListener('click', () => {
                    this.toggleScreenShare();
                });

                document.getElementById('endCallBtn')?.addEventListener('click', () => {
                    this.endCall();
                });

                document.getElementById('videoEndCallBtn')?.addEventListener('click', () => {
                    this.endCall();
                });

                document.getElementById('answerBtn')?.addEventListener('click', () => {
                    this.answerCall();
                });

                document.getElementById('declineBtn')?.addEventListener('click', () => {
                    this.declineCall();
                });

                // Notification buttons
                document.getElementById('notificationAnswer')?.addEventListener('click', () => {
                    this.answerCallFromNotification();
                });

                document.getElementById('notificationDecline')?.addEventListener('click', () => {
                    this.declineCallFromNotification();
                });

                // File preview buttons
                document.getElementById('filePreviewClose')?.addEventListener('click', () => {
                    this.hideFilePreview();
                });

                document.getElementById('fileCancelBtn')?.addEventListener('click', () => {
                    this.hideFilePreview();
                });

                document.getElementById('fileSendBtn')?.addEventListener('click', () => {
                    this.sendFiles();
                });

                // Profile modal buttons
                document.getElementById('profileBtn')?.addEventListener('click', () => {
                    this.showProfileModal();
                });

                document.getElementById('profileCloseBtn')?.addEventListener('click', () => {
                    this.hideProfileModal();
                });

                document.getElementById('profileCancelBtn')?.addEventListener('click', () => {
                    this.hideProfileModal();
                });

                document.getElementById('profileSaveBtn')?.addEventListener('click', () => {
                    this.saveProfile();
                });

                document.getElementById('avatarUploadArea')?.addEventListener('click', () => {
                    this.openAvatarUpload();
                });

                document.getElementById('removeAvatarBtn')?.addEventListener('click', () => {
                    this.removeAvatar();
                });

                // User search modal buttons
                document.getElementById('findUsersBtn')?.addEventListener('click', () => {
                    this.showUserSearchModal();
                });

                document.getElementById('userSearchCloseBtn')?.addEventListener('click', () => {
                    this.hideUserSearchModal();
                });

                document.getElementById('userSearchInput')?.addEventListener('input', (e) => {
                    this.handleUserSearch(e.target.value);
                });

                // Bio character counter
                document.getElementById('profileBio')?.addEventListener('input', (e) => {
                    this.updateBioCharCount(e.target.value);
                });

                // Avatar input file change
                document.getElementById('avatarInput')?.addEventListener('change', (e) => {
                    this.handleAvatarChange(e);
                });

                // Modal dragging functionality
                this.setupModalDragging();

                // Sidebar drag-and-drop functionality
                this.setupSidebarDragAndDrop();

                // Load saved sidebar order
                this.loadSidebarOrder();

                // Initialize modal stack manager
                this.initializeModalStackManager();

                // Initialize corporate-grade security and reliability
                this.initializeSecuritySuite();

                // Apply final divine polish
                this.applyDivinePolish();

                // Window resize
                window.addEventListener('resize', () => {
                    this.handleResize();
                });

                // Add ripple effect to clickable elements
                this.addRippleEffects();
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                this.sidebarCollapsed = !this.sidebarCollapsed;

                sidebar.classList.toggle('collapsed', this.sidebarCollapsed);
                localStorage.setItem('talkpai-sidebar-collapsed', this.sidebarCollapsed);

                // Animate with spring effect
                sidebar.style.transform = this.sidebarCollapsed ? 'scale(0.98)' : 'scale(1.02)';
                setTimeout(() => {
                    sidebar.style.transform = 'scale(1)';
                }, 150);
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                this.applyTheme(this.currentTheme);
            }

            applyTheme(theme) {
                if (this.currentTheme === theme) return;

                this.startDivineThemeMorph(this.currentTheme, theme);
                this.currentTheme = theme;
                localStorage.setItem('talkpai-theme', theme);
            }

            // ===== DIVINE THEME MORPHING SYSTEM =====

            startDivineThemeMorph(fromTheme, toTheme) {
                this.createThemeMorphOverlay(fromTheme, toTheme);
                this.performDivineTransition(fromTheme, toTheme);
            }

            createThemeMorphOverlay(fromTheme, toTheme) {
                const overlay = document.createElement('div');
                overlay.id = 'themeMorphOverlay';
                overlay.className = 'theme-morph-overlay';

                const isDarkToLight = fromTheme === 'dark' && toTheme === 'light';
                const isLightToDark = fromTheme === 'light' && toTheme === 'dark';

                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    z-index: 9999;
                    pointer-events: none;
                    background: ${isDarkToLight ?
                        'radial-gradient(circle at center, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%)' :
                        'radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,1) 100%)'
                    };
                    opacity: 0;
                    transform: scale(0);
                    transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
                `;

                document.body.appendChild(overlay);

                setTimeout(() => {
                    overlay.style.opacity = '1';
                    overlay.style.transform = 'scale(3)';
                }, 50);

                setTimeout(() => {
                    overlay.remove();
                }, 1200);

                this.createMorphParticles(isDarkToLight);
            }

            createMorphParticles(isDarkToLight) {
                const particleCount = 20;
                const particles = [];

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'morph-particle';

                    const size = Math.random() * 6 + 2;
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * window.innerHeight;
                    const hue = isDarkToLight ? Math.random() * 60 + 30 : Math.random() * 240 + 180;

                    particle.style.cssText = `
                        position: fixed;
                        width: ${size}px;
                        height: ${size}px;
                        background: hsl(${hue}, 70%, 60%);
                        border-radius: 50%;
                        left: ${x}px;
                        top: ${y}px;
                        z-index: 10000;
                        pointer-events: none;
                        opacity: 0;
                        animation: morphParticle 1.5s ease-out forwards;
                        animation-delay: ${i * 0.1}s;
                        box-shadow: 0 0 10px currentColor;
                    `;

                    document.body.appendChild(particle);
                    particles.push(particle);
                }

                setTimeout(() => {
                    particles.forEach(particle => particle.remove());
                }, 2000);
            }

            performDivineTransition(fromTheme, toTheme) {
                const duration = 1000;
                const elements = this.getTransitionElements();

                elements.forEach((element, index) => {
                    setTimeout(() => {
                        this.morphElement(element, fromTheme, toTheme);
                    }, index * 50);
                });

                setTimeout(() => {
                    document.body.setAttribute('data-theme', toTheme);
                    this.finalizeMorphTransition();
                }, duration / 2);
            }

            getTransitionElements() {
                return [
                    document.querySelector('.sidebar'),
                    document.querySelector('.chat-list-panel'),
                    document.querySelector('.chat-area'),
                    ...document.querySelectorAll('.floating-modal'),
                    ...document.querySelectorAll('.nav-item'),
                    ...document.querySelectorAll('.chat-item'),
                    ...document.querySelectorAll('.message-bubble'),
                    document.querySelector('.floating-orb'),
                    document.body
                ].filter(Boolean);
            }

            morphElement(element, fromTheme, toTheme) {
                if (!element) return;

                const morphClass = `morph-${fromTheme}-to-${toTheme}`;
                element.classList.add('theme-morphing', morphClass);

                element.style.transition = 'all 0.8s cubic-bezier(0.23, 1, 0.32, 1)';

                setTimeout(() => {
                    element.classList.remove('theme-morphing', morphClass);
                    element.style.transition = '';
                }, 800);
            }

            finalizeMorphTransition() {
                this.createThemeWave();
                this.updateThemeBasedElements();
            }

            createThemeWave() {
                const wave = document.createElement('div');
                wave.className = 'theme-wave';

                wave.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    width: 100px;
                    height: 100px;
                    border: 3px solid var(--accent-primary);
                    border-radius: 50%;
                    transform: translate(-50%, -50%) scale(0);
                    z-index: 10001;
                    pointer-events: none;
                    opacity: 0.8;
                    animation: themeWave 1s ease-out forwards;
                `;

                document.body.appendChild(wave);

                setTimeout(() => {
                    wave.remove();
                }, 1000);
            }

            updateThemeBasedElements() {
                const isDark = this.currentTheme === 'dark';

                document.querySelectorAll('.floating-orb').forEach(orb => {
                    orb.style.opacity = isDark ? '0.05' : '0.03';
                });

                document.querySelectorAll('.status-indicator').forEach(indicator => {
                    indicator.style.background = isDark ?
                        'var(--dark-accent-cyan)' :
                        'var(--light-accent-blue)';
                });

                this.updateGlowEffects(isDark);
            }

            updateGlowEffects(isDark) {
                const glowElements = document.querySelectorAll('.nav-item.active, .chat-item.active, .accent-button');

                glowElements.forEach(element => {
                    const currentGlow = isDark ?
                        '0 0 30px rgba(6, 182, 212, 0.4)' :
                        '0 0 20px rgba(59, 130, 246, 0.3)';

                    element.style.boxShadow = currentGlow;
                });
            }

            createAdvancedThemeTransition(fromTheme, toTheme) {
                this.createRippleEffect();
                this.animateColorShift(fromTheme, toTheme);
                this.morphBackgroundElements();
            }

            createRippleEffect() {
                const ripple = document.createElement('div');
                ripple.className = 'theme-ripple';

                ripple.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
                    transform: translate(-50%, -50%) scale(0);
                    z-index: 10000;
                    pointer-events: none;
                    opacity: 0.6;
                    animation: themeRipple 1.5s ease-out forwards;
                `;

                document.body.appendChild(ripple);

                setTimeout(() => {
                    ripple.remove();
                }, 1500);
            }

            animateColorShift(fromTheme, toTheme) {
                const colorShiftElements = document.querySelectorAll('.sidebar, .chat-list-panel, .chat-area');

                colorShiftElements.forEach((element, index) => {
                    setTimeout(() => {
                        element.style.filter = 'hue-rotate(360deg) saturate(1.2)';
                        element.style.transition = 'filter 0.8s ease-out';

                        setTimeout(() => {
                            element.style.filter = '';
                            element.style.transition = '';
                        }, 800);
                    }, index * 200);
                });
            }

            morphBackgroundElements() {
                const bgElements = document.querySelectorAll('.floating-orb');

                bgElements.forEach((orb, index) => {
                    setTimeout(() => {
                        orb.style.transform = 'scale(1.5) rotate(180deg)';
                        orb.style.transition = 'transform 1s cubic-bezier(0.68, -0.55, 0.265, 1.55)';

                        setTimeout(() => {
                            orb.style.transform = '';
                        }, 1000);
                    }, index * 300);
                });
            }

            // ===== CORPORATE-GRADE SECURITY & RELIABILITY SUITE =====

            initializeSecuritySuite() {
                this.security = {
                    encryption: new TalkPAIEncryption(),
                    validator: new TalkPAIValidator(),
                    monitor: new TalkPAISecurityMonitor(),
                    storage: new TalkPAISecureStorage(),
                    rateLimiter: new TalkPAIRateLimiter(),
                    logger: new TalkPAISecurityLogger()
                };

                this.reliability = {
                    errorHandler: new TalkPAIErrorHandler(),
                    retryManager: new TalkPAIRetryManager(),
                    connectionMonitor: new TalkPAIConnectionMonitor(),
                    dataIntegrity: new TalkPAIDataIntegrity(),
                    backup: new TalkPAIBackupManager()
                };

                this.setupGlobalErrorHandling();
                this.setupSecurityMonitoring();
                this.setupReliabilityChecks();
                this.initializeSessionSecurity();

                console.log('🔒 Corporate-grade security suite initialized');
            }

            setupGlobalErrorHandling() {
                window.addEventListener('error', (event) => {
                    this.reliability.errorHandler.handleError({
                        type: 'javascript',
                        message: event.message,
                        filename: event.filename,
                        lineno: event.lineno,
                        colno: event.colno,
                        error: event.error,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        url: window.location.href
                    });
                });

                window.addEventListener('unhandledrejection', (event) => {
                    this.reliability.errorHandler.handleError({
                        type: 'promise_rejection',
                        reason: event.reason,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    });
                });

                document.addEventListener('securitypolicyviolation', (event) => {
                    this.security.monitor.reportViolation({
                        type: 'csp_violation',
                        violatedDirective: event.violatedDirective,
                        blockedURI: event.blockedURI,
                        documentURI: event.documentURI,
                        timestamp: new Date().toISOString()
                    });
                });
            }

            setupSecurityMonitoring() {
                setInterval(() => {
                    this.security.monitor.performSecurityCheck();
                }, 30000);

                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        this.security.monitor.onPageHidden();
                    } else {
                        this.security.monitor.onPageVisible();
                    }
                });

                window.addEventListener('beforeunload', () => {
                    this.security.storage.clearSensitiveData();
                });
            }

            setupReliabilityChecks() {
                setInterval(() => {
                    this.reliability.connectionMonitor.checkConnection();
                    this.reliability.dataIntegrity.verifyDataIntegrity();
                }, 60000);

                window.addEventListener('online', () => {
                    this.reliability.connectionMonitor.onOnline();
                });

                window.addEventListener('offline', () => {
                    this.reliability.connectionMonitor.onOffline();
                });
            }

            initializeSessionSecurity() {
                this.security.storage.initializeSecureSession();
                this.validateAuthTokens();
                this.setupCSRFProtection();
            }

            validateAuthTokens() {
                const token = this.security.storage.getSecureItem('authToken');
                if (token && !this.security.validator.isValidJWT(token)) {
                    this.security.storage.removeSecureItem('authToken');
                    this.handleAuthenticationFailure();
                }
            }

            setupCSRFProtection() {
                const csrfToken = this.security.encryption.generateCSRFToken();
                this.security.storage.setSecureItem('csrfToken', csrfToken);
            }

            handleAuthenticationFailure() {
                console.warn('Authentication failure detected');
                this.showSecurityAlert('Session expired. Please log in again.');
            }

            showSecurityAlert(message) {
                const alert = document.createElement('div');
                alert.className = 'security-alert';
                alert.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #fee2e2;
                    border: 1px solid #fecaca;
                    color: #991b1b;
                    padding: 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 300px;
                    animation: slideInRight 0.3s ease-out;
                `;
                alert.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 8px;">
                        <svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Security Alert</div>
                            <div style="font-size: 14px;">${message}</div>
                        </div>
                    </div>
                `;

                document.body.appendChild(alert);

                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }

            // ===== DIVINE POLISH & PERFECTION SYSTEM =====

            applyDivinePolish() {
                this.optimizePerformance();
                this.enhanceAccessibility();
                this.addFinalTouches();
                this.initializeProgressiveEnhancement();
                this.setupDivineInteractions();

                console.log('✨ Divine polish applied - messenger perfected to absolute divine quality');
            }

            optimizePerformance() {
                // Implement intersection observer for performance
                this.setupIntersectionObserver();

                // Lazy load non-critical elements
                this.lazyLoadElements();

                // Optimize animations and transitions
                this.optimizeAnimations();

                // Memory management
                this.setupMemoryOptimization();

                // Preload critical resources
                this.preloadCriticalAssets();
            }

            setupIntersectionObserver() {
                if ('IntersectionObserver' in window) {
                    this.intersectionObserver = new IntersectionObserver(
                        (entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    entry.target.classList.add('visible');
                                    this.animateElement(entry.target);
                                }
                            });
                        },
                        { threshold: 0.1 }
                    );

                    // Observe all animated elements
                    document.querySelectorAll('.nav-item, .chat-item, .floating-modal').forEach(el => {
                        this.intersectionObserver.observe(el);
                    });
                }
            }

            lazyLoadElements() {
                // Lazy load avatars and images
                document.querySelectorAll('img[data-src]').forEach(img => {
                    if (this.intersectionObserver) {
                        this.intersectionObserver.observe(img);
                    }
                });

                // Lazy load heavy components
                this.lazyLoadModalContent();
            }

            optimizeAnimations() {
                // Use CSS containment for better performance
                document.querySelectorAll('.floating-modal, .sidebar, .chat-area').forEach(el => {
                    el.style.contain = 'layout style paint';
                });

                // Optimize transform animations
                document.querySelectorAll('.nav-item, .chat-item').forEach(el => {
                    el.style.willChange = 'transform, opacity';
                });

                // Use requestAnimationFrame for smooth animations
                this.animationFrameIds = new Set();
            }

            setupMemoryOptimization() {
                // Cleanup intervals for memory management
                setInterval(() => {
                    this.performMemoryCleanup();
                }, 300000); // Every 5 minutes

                // Monitor memory usage
                this.monitorMemoryUsage();
            }

            preloadCriticalAssets() {
                const criticalResources = [
                    '/emoji-picker.js',
                    '/theme-customizer.js'
                ];

                criticalResources.forEach(resource => {
                    const link = document.createElement('link');
                    link.rel = 'preload';
                    link.as = 'script';
                    link.href = resource;
                    document.head.appendChild(link);
                });
            }

            enhanceAccessibility() {
                this.setupKeyboardNavigation();
                this.enhanceScreenReaderSupport();
                this.addAriaLabels();
                this.setupFocusManagement();
                this.implementColorContrastOptimization();
            }

            setupKeyboardNavigation() {
                // Enhanced keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'k':
                                e.preventDefault();
                                this.focusGlobalSearch();
                                break;
                            case 'n':
                                e.preventDefault();
                                this.createNewChat();
                                break;
                            case ',':
                                e.preventDefault();
                                this.openSettings();
                                break;
                            case 't':
                                e.preventDefault();
                                this.toggleTheme();
                                break;
                        }
                    }

                    // Navigation with arrow keys
                    if (e.altKey) {
                        switch (e.key) {
                            case 'ArrowUp':
                                e.preventDefault();
                                this.navigateChats('up');
                                break;
                            case 'ArrowDown':
                                e.preventDefault();
                                this.navigateChats('down');
                                break;
                        }
                    }
                });

                // Tab navigation enhancement
                this.enhanceTabNavigation();
            }

            enhanceScreenReaderSupport() {
                // Add live regions for dynamic content
                this.createLiveRegions();

                // Enhance semantic structure
                this.enhanceSemanticStructure();

                // Add descriptive text for complex interactions
                this.addScreenReaderDescriptions();
            }

            addAriaLabels() {
                const elements = [
                    { selector: '.nav-item', labelKey: 'data-nav' },
                    { selector: '.chat-item', labelKey: 'data-chat' },
                    { selector: '.modal-control-btn', labelKey: 'title' },
                    { selector: '.floating-modal', labelKey: 'data-modal-title' }
                ];

                elements.forEach(({ selector, labelKey }) => {
                    document.querySelectorAll(selector).forEach(el => {
                        if (!el.getAttribute('aria-label')) {
                            const label = el.getAttribute(labelKey) || el.textContent?.trim();
                            if (label) el.setAttribute('aria-label', label);
                        }
                    });
                });
            }

            setupFocusManagement() {
                // Focus trap for modals
                this.setupModalFocusTrap();

                // Focus restoration
                this.setupFocusRestoration();

                // Skip links for keyboard users
                this.addSkipLinks();
            }

            addFinalTouches() {
                this.addMicroAnimations();
                this.enhanceVisualFeedback();
                this.implementAdvancedInteractions();
                this.addEasterEggs();
                this.finalizeDesignSystem();
            }

            addMicroAnimations() {
                // Subtle hover animations
                document.querySelectorAll('.nav-item, .chat-item, .modal-control-btn').forEach(el => {
                    el.addEventListener('mouseenter', () => {
                        this.addMicroHoverEffect(el);
                    });
                });

                // Loading state animations
                this.addLoadingAnimations();

                // Success/error state animations
                this.addStateAnimations();
            }

            enhanceVisualFeedback() {
                // Enhanced ripple effects
                this.enhanceRippleEffects();

                // Progress indicators
                this.addProgressIndicators();

                // Status indicators
                this.enhanceStatusIndicators();

                // Tooltip system
                this.implementTooltipSystem();
            }

            implementAdvancedInteractions() {
                // Gesture support for touch devices
                this.addGestureSupport();

                // Advanced drag and drop
                this.enhanceDragAndDrop();

                // Smart auto-complete
                this.addSmartAutoComplete();

                // Context menus
                this.addContextMenus();
            }

            addEasterEggs() {
                // Konami code
                this.setupKonamiCode();

                // Developer console art
                this.addConsoleArt();

                // Hidden developer panel
                this.setupDeveloperPanel();
            }

            finalizeDesignSystem() {
                // Ensure consistency across all components
                this.validateDesignConsistency();

                // Apply final color harmony
                this.optimizeColorHarmony();

                // Perfect typography scaling
                this.perfectTypographyScale();

                // Final spacing optimization
                this.optimizeSpacing();
            }

            // Helper methods for divine polish
            performMemoryCleanup() {
                // Clear expired cache entries
                if (this.animationFrameIds) {
                    this.animationFrameIds.forEach(id => cancelAnimationFrame(id));
                    this.animationFrameIds.clear();
                }

                // Clean up event listeners
                this.cleanupEventListeners();

                // Garbage collection hint
                if (window.gc) window.gc();
            }

            addMicroHoverEffect(element) {
                const rect = element.getBoundingClientRect();
                const particle = document.createElement('div');
                particle.className = 'micro-particle';
                particle.style.cssText = `
                    position: fixed;
                    width: 3px;
                    height: 3px;
                    background: var(--accent-primary);
                    border-radius: 50%;
                    left: ${rect.left + rect.width / 2}px;
                    top: ${rect.top + rect.height / 2}px;
                    pointer-events: none;
                    z-index: 10000;
                    animation: microParticle 0.6s ease-out forwards;
                `;

                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 600);
            }

            setupKonamiCode() {
                const konamiSequence = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65];
                let userSequence = [];

                document.addEventListener('keydown', (e) => {
                    userSequence.push(e.keyCode);
                    if (userSequence.length > konamiSequence.length) {
                        userSequence.shift();
                    }

                    if (JSON.stringify(userSequence) === JSON.stringify(konamiSequence)) {
                        this.activateEasterEgg();
                    }
                });
            }

            activateEasterEgg() {
                document.body.style.animation = 'rainbow 3s ease-in-out';
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 3000);

                console.log(`
                ╔══════════════════════════════════════════╗
                ║          🎉 EASTER EGG ACTIVATED! 🎉    ║
                ║                                          ║
                ║     Congratulations! You found the      ║
                ║     secret divine messenger mode!       ║
                ║                                          ║
                ║   ✨ All animations are now enhanced ✨  ║
                ╚══════════════════════════════════════════╝
                `);
            }

            addConsoleArt() {
                console.log(`
        ╔════════════════════════════════════════════════════════════════╗
        ║                          TALK pAI                              ║
        ║                   Divine Messenger v2.0                       ║
        ║                                                                ║
        ║  🎨 Ultra-Modern Glassmorphism Design                         ║
        ║  🔒 Corporate-Grade Security                                   ║
        ║  🚀 Divine Performance & Reliability                          ║
        ║  ✨ Revolutionary User Experience                              ║
        ║                                                                ║
        ║              Built with Divine Quality 💎                      ║
        ╚════════════════════════════════════════════════════════════════╝
                `);
            }

            switchNavigation(nav) {
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-nav="${nav}"]`).classList.add('active');

                // Update chat list title
                const chatListTitle = document.querySelector('.chat-list-title h2');
                chatListTitle.textContent = nav.charAt(0).toUpperCase() + nav.slice(1);

                console.log(`Switched to ${nav} section`);
            }

            selectChat(chatId) {
                this.currentChat = chatId;

                // Update active chat item
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-chat="${chatId}"]`).classList.add('active');

                // Update chat header
                this.updateChatHeader(chatId);

                // Load messages
                this.loadMessages(chatId);

                console.log(`Selected chat ${chatId}`);
            }

            updateChatHeader(chatId) {
                const chatItem = document.querySelector(`[data-chat="${chatId}"]`);
                const avatar = chatItem.querySelector('.chat-avatar').textContent;
                const name = chatItem.querySelector('.chat-name').textContent;

                document.querySelector('.chat-header-avatar').textContent = avatar;
                document.querySelector('.chat-header-name').textContent = name;
                document.querySelector('.chat-header-status').innerHTML = `
                    <div class="status-indicator"></div>
                    <span>Online</span>
                `;
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const content = input.value.trim();

                if (!content) return;

                // Add message with animation
                this.addMessage({
                    content,
                    sender: 'Demo User',
                    avatar: 'DU',
                    timestamp: new Date(),
                    sent: true
                });

                // Clear input
                input.value = '';
                this.autoResizeTextarea(input);

                // Send to API
                this.sendToAPI(content);

                // Show typing indicator and simulate response
                this.showTypingIndicator();
                setTimeout(() => {
                    this.hideTypingIndicator();
                    this.addMessage({
                        content: this.generateAIResponse(content),
                        sender: 'AI Assistant',
                        avatar: 'AI',
                        timestamp: new Date(),
                        sent: false
                    });
                }, 2000);
            }

            addMessage(message) {
                const container = document.getElementById('messagesContainer');
                const messageGroup = document.createElement('div');
                messageGroup.className = `message-group ${message.sent ? 'sent' : 'received'}`;

                const time = message.timestamp.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageGroup.innerHTML = `
                    <div class="message-bubble">
                        ${!message.sent ? `
                            <div class="message-header">
                                <div class="message-avatar">${message.avatar}</div>
                                <span class="message-sender">${message.sender}</span>
                                <span class="message-time">${time}</span>
                            </div>
                        ` : ''}
                        <div class="message-content">${message.content}</div>
                        ${message.sent ? `
                            <div class="message-states">
                                <svg class="message-check" viewBox="0 0 24 24">
                                    <polyline points="20,6 9,17 4,12"/>
                                </svg>
                                <svg class="message-check" viewBox="0 0 24 24">
                                    <polyline points="20,6 9,17 4,12"/>
                                </svg>
                                <span>Sent</span>
                            </div>
                        ` : ''}
                    </div>
                `;

                container.appendChild(messageGroup);

                // Smooth scroll to bottom
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });

                // Update message states after a delay
                if (message.sent) {
                    setTimeout(() => {
                        const states = messageGroup.querySelector('.message-states span');
                        if (states) states.textContent = 'Read';
                    }, 1000);
                }

                this.messages.push(message);
            }

            async sendToAPI(content) {
                try {
                    const response = await fetch('/api/v2/demo/message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content,
                            chatId: this.currentChat,
                            messageType: 'text'
                        })
                    });

                    const result = await response.json();
                    console.log('Message sent:', result);
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }

            generateAIResponse(input) {
                const responses = [
                    "Amazing! ✨ The glassmorphism design and smooth animations make this feel truly premium.",
                    "I love the attention to detail! Every micro-interaction is perfectly crafted. 🎨",
                    "This ultra-modern interface deserves a design award! The spring animations are beautiful. 🏆",
                    "The professional sidebar and responsive layout work flawlessly across all devices. 📱💻",
                    "These floating glass panels and neon glows create such an immersive experience! 🌟",
                    "The three-theme system with live customization is incredibly sophisticated. 🎭"
                ];

                return responses[Math.floor(Math.random() * responses.length)];
            }

            showTypingIndicator() {
                const status = document.querySelector('.chat-header-status');
                status.innerHTML = `
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <span>AI is typing...</span>
                    </div>
                `;
            }

            hideTypingIndicator() {
                const status = document.querySelector('.chat-header-status');
                status.innerHTML = `
                    <div class="status-indicator"></div>
                    <span>Online</span>
                `;
            }

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            handleTyping() {
                if (!this.isTyping) {
                    this.isTyping = true;
                    // Could send typing indicator to server here
                }

                clearTimeout(this.typingTimeout);
                this.typingTimeout = setTimeout(() => {
                    this.isTyping = false;
                    // Could send stop typing indicator to server here
                }, 1000);
            }

            autoResize() {
                const messageInput = document.getElementById('messageInput');
                if (messageInput) {
                    this.autoResizeTextarea(messageInput);
                }
            }

            handleResize() {
                const chatListPanel = document.getElementById('chatListPanel');
                if (window.innerWidth <= 968) {
                    // Mobile layout adjustments
                    if (this.chatListOpen) {
                        chatListPanel.classList.add('open');
                    }
                } else {
                    // Desktop layout
                    chatListPanel.classList.remove('open');
                    this.chatListOpen = false;
                }
            }

            openEmojiPicker() {
                if (window.emojiPicker) {
                    window.emojiPicker.show((emoji) => {
                        const input = document.getElementById('messageInput');
                        input.value += emoji;
                        input.focus();
                        this.autoResizeTextarea(input);
                    });
                }
            }

            openFileDialog() {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx';

                input.onchange = (e) => {
                    const files = Array.from(e.target.files);
                    this.handleFileUpload(files);
                };

                input.click();
            }

            handleFileUpload(files) {
                files.forEach(file => {
                    this.addMessage({
                        content: `📎 ${file.name} (${this.formatFileSize(file.size)})`,
                        sender: 'Demo User',
                        avatar: 'DU',
                        timestamp: new Date(),
                        sent: true
                    });
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            toggleVoiceRecording() {
                // Voice recording implementation would go here
                console.log('Voice recording toggled');
            }

            handleGlobalSearch(query) {
                // Global search implementation
                console.log('Searching for:', query);
            }

            createNewChat() {
                // New chat creation implementation
                console.log('Creating new chat');
            }

            loadMessages(chatId) {
                // Load messages for specific chat
                console.log(`Loading messages for chat ${chatId}`);
            }

            loadDemoData() {
                // Demo data is already in HTML
                console.log('Demo data loaded');
            }

            addRippleEffects() {
                const rippleElements = document.querySelectorAll('.nav-item, .chat-item, .header-action-btn, .send-button, .new-chat-btn');

                rippleElements.forEach(element => {
                    element.addEventListener('click', (e) => {
                        this.createRipple(e, element);
                    });
                });
            }

            createRipple(event, element) {
                const ripple = document.createElement('span');
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                ripple.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    pointer-events: none;
                    animation: ripple 0.6s ease-out;
                `;

                element.style.position = 'relative';
                element.style.overflow = 'hidden';
                element.appendChild(ripple);

                setTimeout(() => {
                    ripple.remove();
                }, 600);
            }

            // ===== VOICE & VIDEO CALL METHODS =====

            async startVoiceCall() {
                console.log('Starting voice call...');
                this.callType = 'voice';
                this.callState = 'calling';

                try {
                    await this.getUserMedia({ audio: true, video: false });
                    this.showCallInterface();
                    this.updateCallStatus('Calling...');

                    // Simulate call connection after 3 seconds
                    setTimeout(() => {
                        this.connectCall();
                    }, 3000);
                } catch (error) {
                    console.error('Failed to start voice call:', error);
                    this.showCallError('Microphone access denied');
                }
            }

            async startVideoCall() {
                console.log('Starting video call...');
                this.callType = 'video';
                this.callState = 'calling';

                try {
                    await this.getUserMedia({ audio: true, video: true });
                    this.showCallInterface();
                    this.updateCallStatus('Calling...');
                    document.getElementById('videoContainer').style.display = 'block';
                    document.getElementById('voiceControls').style.display = 'none';
                    document.getElementById('videoControls').style.display = 'flex';

                    // Simulate call connection after 3 seconds
                    setTimeout(() => {
                        this.connectCall();
                    }, 3000);
                } catch (error) {
                    console.error('Failed to start video call:', error);
                    this.showCallError('Camera/microphone access denied');
                }
            }

            async getUserMedia(constraints) {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);

                    if (constraints.video) {
                        const localVideo = document.getElementById('localVideo');
                        localVideo.srcObject = this.localStream;
                    }

                    return this.localStream;
                } catch (error) {
                    throw new Error('Media access failed');
                }
            }

            showCallInterface() {
                const callOverlay = document.getElementById('callOverlay');
                callOverlay.classList.add('active');

                // Update call info
                document.getElementById('callAvatar').textContent = 'AI';
                document.getElementById('callUserName').textContent = 'AI Assistant';
            }

            hideCallInterface() {
                const callOverlay = document.getElementById('callOverlay');
                callOverlay.classList.remove('active');

                // Clean up video elements
                document.getElementById('videoContainer').style.display = 'none';
                document.getElementById('voiceControls').style.display = 'flex';
                document.getElementById('videoControls').style.display = 'none';
                document.getElementById('incomingControls').style.display = 'none';
            }

            connectCall() {
                this.callState = 'connected';
                this.callStartTime = Date.now();
                this.updateCallStatus('Connected');

                // Show call timer
                document.getElementById('callTimer').style.display = 'block';
                this.startCallTimer();

                console.log('Call connected');
            }

            startCallTimer() {
                this.callTimer = setInterval(() => {
                    if (this.callStartTime) {
                        const elapsed = Date.now() - this.callStartTime;
                        const minutes = Math.floor(elapsed / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        document.getElementById('callTimer').textContent = formattedTime;
                    }
                }, 1000);
            }

            stopCallTimer() {
                if (this.callTimer) {
                    clearInterval(this.callTimer);
                    this.callTimer = null;
                }
            }

            updateCallStatus(status) {
                document.getElementById('callStatus').innerHTML = `<span>${status}</span>`;
            }

            endCall() {
                console.log('Ending call...');
                this.callState = 'idle';
                this.callType = null;

                // Clean up streams
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }

                if (this.remoteStream) {
                    this.remoteStream.getTracks().forEach(track => track.stop());
                    this.remoteStream = null;
                }

                this.stopCallTimer();
                this.hideCallInterface();
                this.hideCallNotification();

                // Reset call states
                this.isMuted = false;
                this.isVideoOn = true;
                this.isSpeakerOn = false;
                this.isScreenSharing = false;
            }

            answerCall() {
                console.log('Answering call...');
                this.connectCall();
                document.getElementById('incomingControls').style.display = 'none';

                if (this.callType === 'video') {
                    document.getElementById('videoControls').style.display = 'flex';
                } else {
                    document.getElementById('voiceControls').style.display = 'flex';
                }
            }

            declineCall() {
                console.log('Declining call...');
                this.endCall();
            }

            toggleMute() {
                this.isMuted = !this.isMuted;

                if (this.localStream) {
                    const audioTrack = this.localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !this.isMuted;
                    }
                }

                // Update button state
                const muteButtons = document.querySelectorAll('#muteBtn, #videoMuteBtn');
                muteButtons.forEach(btn => {
                    btn.classList.toggle('active', this.isMuted);
                });

                console.log(`Microphone ${this.isMuted ? 'muted' : 'unmuted'}`);
            }

            toggleVideo() {
                this.isVideoOn = !this.isVideoOn;

                if (this.localStream) {
                    const videoTrack = this.localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = this.isVideoOn;
                    }
                }

                // Update button state
                document.getElementById('cameraBtn').classList.toggle('active', !this.isVideoOn);

                console.log(`Camera ${this.isVideoOn ? 'enabled' : 'disabled'}`);
            }

            toggleSpeaker() {
                this.isSpeakerOn = !this.isSpeakerOn;
                document.getElementById('speakerBtn').classList.toggle('active', this.isSpeakerOn);
                console.log(`Speaker ${this.isSpeakerOn ? 'on' : 'off'}`);
            }

            async toggleScreenShare() {
                if (!this.isScreenSharing) {
                    try {
                        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                        const remoteVideo = document.getElementById('remoteVideo');
                        remoteVideo.srcObject = screenStream;

                        this.isScreenSharing = true;
                        document.getElementById('screenShareBtn').classList.add('active');
                        document.getElementById('screenShareIndicator').classList.add('active');

                        // Handle screen share end
                        screenStream.getVideoTracks()[0].onended = () => {
                            this.stopScreenShare();
                        };

                        console.log('Screen sharing started');
                    } catch (error) {
                        console.error('Screen sharing failed:', error);
                    }
                } else {
                    this.stopScreenShare();
                }
            }

            stopScreenShare() {
                this.isScreenSharing = false;
                document.getElementById('screenShareBtn').classList.remove('active');
                document.getElementById('screenShareIndicator').classList.remove('active');
                console.log('Screen sharing stopped');
            }

            showCallNotification(callerName, callType) {
                const notification = document.getElementById('callNotification');
                document.getElementById('notificationName').textContent = callerName;
                document.getElementById('notificationType').textContent = `Incoming ${callType} call`;
                notification.classList.add('active');
            }

            hideCallNotification() {
                document.getElementById('callNotification').classList.remove('active');
            }

            answerCallFromNotification() {
                this.hideCallNotification();
                // Show full call interface
                this.callState = 'incoming';
                this.showCallInterface();
                document.getElementById('incomingControls').style.display = 'flex';
                document.getElementById('voiceControls').style.display = 'none';
                document.getElementById('videoControls').style.display = 'none';
            }

            declineCallFromNotification() {
                this.hideCallNotification();
                this.endCall();
            }

            showCallError(message) {
                // Could integrate with your existing notification system
                console.error('Call error:', message);
                alert(message); // Simple fallback
            }

            // Simulate incoming call (for demo purposes)
            simulateIncomingCall(type = 'voice') {
                if (this.callState !== 'idle') return;

                this.callType = type;
                this.callState = 'incoming';
                this.showCallNotification('AI Assistant', type);

                // Auto-decline after 30 seconds
                setTimeout(() => {
                    if (this.callState === 'incoming') {
                        this.declineCallFromNotification();
                    }
                }, 30000);
            }

            // ===== DRAG & DROP WITH MAGNETIC EFFECTS =====

            setupDragAndDrop() {
                // Global drag events
                document.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    this.dragCounter++;
                    if (this.dragCounter === 1) {
                        this.showDragZone();
                    }
                });

                document.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    this.dragCounter--;
                    if (this.dragCounter === 0) {
                        this.hideDragZone();
                    }
                });

                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });

                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.dragCounter = 0;
                    this.hideDragZone();
                    this.handleFileDrop(e.dataTransfer.files);
                });

                // Drop area specific events
                const dropArea = document.getElementById('dropArea');
                dropArea?.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('drag-over');
                });

                dropArea?.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    if (!dropArea.contains(e.relatedTarget)) {
                        dropArea.classList.remove('drag-over');
                    }
                });

                dropArea?.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });

                dropArea?.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('drag-over');
                });

                // Make chat items draggable for demo
                this.makeChatItemsDraggable();
            }

            makeChatItemsDraggable() {
                const chatItems = document.querySelectorAll('.chat-item');
                chatItems.forEach(item => {
                    item.classList.add('draggable');
                    item.draggable = true;

                    item.addEventListener('dragstart', (e) => {
                        item.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', item.dataset.chat);
                    });

                    item.addEventListener('dragend', (e) => {
                        item.classList.remove('dragging');
                    });
                });
            }

            showDragZone() {
                this.isDragActive = true;
                document.getElementById('dragDropZone').classList.add('active');
                console.log('Drag zone activated');
            }

            hideDragZone() {
                this.isDragActive = false;
                document.getElementById('dragDropZone').classList.remove('active');
                document.getElementById('dropArea').classList.remove('drag-over');
            }

            handleFileDrop(files) {
                if (files.length === 0) return;

                this.selectedFiles = Array.from(files);
                this.showFilePreview();
                console.log(`${files.length} files dropped:`, this.selectedFiles.map(f => f.name));
            }

            showFilePreview() {
                const preview = document.getElementById('filePreview');
                const fileList = document.getElementById('fileList');

                // Clear existing files
                fileList.innerHTML = '';

                // Add each file to the list
                this.selectedFiles.forEach((file, index) => {
                    const fileItem = this.createFileItem(file, index);
                    fileList.appendChild(fileItem);
                });

                preview.classList.add('active');
            }

            hideFilePreview() {
                document.getElementById('filePreview').classList.remove('active');
                this.selectedFiles = [];
            }

            createFileItem(file, index) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-icon">
                        ${this.getFileIcon(file.type)}
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${this.formatFileSize(file.size)}</div>
                    </div>
                    <button class="file-remove" onclick="window.talkPAI.removeFile(${index})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                `;
                return fileItem;
            }

            getFileIcon(fileType) {
                if (fileType.startsWith('image/')) {
                    return '🖼️';
                } else if (fileType.startsWith('video/')) {
                    return '🎥';
                } else if (fileType.startsWith('audio/')) {
                    return '🎵';
                } else if (fileType.includes('pdf')) {
                    return '📄';
                } else if (fileType.includes('text')) {
                    return '📝';
                } else {
                    return '📎';
                }
            }

            removeFile(index) {
                this.selectedFiles.splice(index, 1);
                this.showFilePreview();

                if (this.selectedFiles.length === 0) {
                    this.hideFilePreview();
                }
            }

            sendFiles() {
                if (this.selectedFiles.length === 0) return;

                // Simulate file upload
                console.log('Sending files:', this.selectedFiles.map(f => f.name));

                // Create file message for each file
                this.selectedFiles.forEach(file => {
                    this.addFileMessage(file);
                });

                this.hideFilePreview();
                this.showSuccessNotification(`${this.selectedFiles.length} file(s) sent successfully!`);
            }

            addFileMessage(file) {
                const messagesContainer = document.getElementById('messagesContainer');
                const messageGroup = document.createElement('div');
                messageGroup.className = 'message-group sent';
                messageGroup.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-content">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 24px;">${this.getFileIcon(file.type)}</div>
                                <div>
                                    <div style="font-weight: 500; margin-bottom: 4px;">${file.name}</div>
                                    <div style="opacity: 0.8; font-size: 14px;">${this.formatFileSize(file.size)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                `;

                messagesContainer.appendChild(messageGroup);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Add animation
                messageGroup.style.opacity = '0';
                messageGroup.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    messageGroup.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                    messageGroup.style.opacity = '1';
                    messageGroup.style.transform = 'translateY(0)';
                }, 100);
            }

            showSuccessNotification(message) {
                // Simple success notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #10B981, #059669);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    z-index: 9999;
                    animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            }

            // Enhanced openFileDialog with drag-and-drop integration
            openFileDialog() {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = '*/*';

                input.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileDrop(e.target.files);
                    }
                });

                input.click();
            }

            // ===== PROFILE EDITING SYSTEM =====

            showProfileModal() {
                const modal = document.getElementById('profileModal');
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => {
                        modal.classList.add('active');
                    }, 10);
                    this.loadUserProfile();
                }
            }

            hideProfileModal() {
                const modal = document.getElementById('profileModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                }
            }

            async loadUserProfile() {
                try {
                    const response = await fetch('/api/user/profile', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        this.populateProfileForm(userData.user);
                    } else {
                        console.warn('Failed to load user profile');
                        this.populateProfileForm({
                            nickname: 'Demo User',
                            display_name: 'Demo User',
                            bio: 'This is a demo profile.',
                            avatar_url: null
                        });
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                    this.populateProfileForm({
                        nickname: 'Demo User',
                        display_name: 'Demo User',
                        bio: 'This is a demo profile.',
                        avatar_url: null
                    });
                }
            }

            populateProfileForm(userData) {
                const form = document.getElementById('profileForm');
                if (form) {
                    form.nickname.value = userData.nickname || '';
                    form.displayName.value = userData.display_name || '';
                    form.bio.value = userData.bio || '';

                    const avatarDisplay = document.getElementById('avatarDisplay');
                    const avatarPlaceholder = document.getElementById('avatarPlaceholder');

                    if (userData.avatar_url) {
                        avatarDisplay.src = userData.avatar_url;
                        avatarDisplay.style.display = 'block';
                        avatarPlaceholder.style.display = 'none';
                    } else {
                        avatarDisplay.style.display = 'none';
                        avatarPlaceholder.style.display = 'flex';
                        avatarPlaceholder.textContent = (userData.display_name || userData.nickname || 'U').charAt(0).toUpperCase();
                    }

                    this.updateBioCharCount(userData.bio || '');
                }
            }

            async saveProfile() {
                const form = document.getElementById('profileForm');
                if (!form) return;

                const formData = new FormData();
                formData.append('nickname', form.nickname.value.trim());
                formData.append('display_name', form.displayName.value.trim());
                formData.append('bio', form.bio.value.trim());

                const avatarInput = document.getElementById('avatarInput');
                if (avatarInput?.files?.[0]) {
                    formData.append('avatar', avatarInput.files[0]);
                }

                try {
                    const response = await fetch('/api/user/profile', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.showProfileSuccess('Profile updated successfully!');
                        this.hideProfileModal();
                        this.updateUserDisplayInfo(result.user);
                    } else {
                        const error = await response.json();
                        this.showProfileError(error.error?.message || 'Failed to update profile');
                    }
                } catch (error) {
                    console.error('Error saving profile:', error);
                    this.showProfileError('Network error. Please try again.');
                }
            }

            updateUserDisplayInfo(userData) {
                const userNameElement = document.querySelector('.user-name');
                const userAvatarElement = document.querySelector('.user-avatar');

                if (userNameElement) {
                    userNameElement.textContent = userData.display_name || userData.nickname;
                }

                if (userAvatarElement) {
                    if (userData.avatar_url) {
                        userAvatarElement.style.backgroundImage = `url(${userData.avatar_url})`;
                        userAvatarElement.style.backgroundSize = 'cover';
                        userAvatarElement.textContent = '';
                    } else {
                        userAvatarElement.style.backgroundImage = '';
                        userAvatarElement.textContent = (userData.display_name || userData.nickname || 'U').charAt(0).toUpperCase();
                    }
                }
            }

            openAvatarUpload() {
                const input = document.getElementById('avatarInput');
                if (input) {
                    input.click();
                }
            }

            handleAvatarChange(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    this.showProfileError('Please select a valid image file.');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    this.showProfileError('Image size must be less than 5MB.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const avatarDisplay = document.getElementById('avatarDisplay');
                    const avatarPlaceholder = document.getElementById('avatarPlaceholder');

                    if (avatarDisplay && avatarPlaceholder) {
                        avatarDisplay.src = e.target.result;
                        avatarDisplay.style.display = 'block';
                        avatarPlaceholder.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            }

            removeAvatar() {
                const avatarDisplay = document.getElementById('avatarDisplay');
                const avatarPlaceholder = document.getElementById('avatarPlaceholder');
                const avatarInput = document.getElementById('avatarInput');

                if (avatarDisplay) avatarDisplay.style.display = 'none';
                if (avatarPlaceholder) {
                    avatarPlaceholder.style.display = 'flex';
                    const nickname = document.getElementById('profileForm')?.nickname?.value || 'U';
                    avatarPlaceholder.textContent = nickname.charAt(0).toUpperCase();
                }
                if (avatarInput) avatarInput.value = '';
            }

            updateBioCharCount(text) {
                const counter = document.getElementById('bioCharCount');
                if (counter) {
                    const count = text.length;
                    const maxCount = 500;
                    counter.textContent = `${count}/${maxCount}`;

                    if (count > maxCount * 0.9) {
                        counter.style.color = 'var(--accent-tertiary)';
                    } else if (count > maxCount * 0.7) {
                        counter.style.color = 'var(--accent-quaternary)';
                    } else {
                        counter.style.color = 'var(--text-tertiary)';
                    }
                }
            }

            showProfileSuccess(message) {
                console.log('Profile success:', message);
            }

            showProfileError(message) {
                console.error('Profile error:', message);
            }

            // ===== USER SEARCH SYSTEM =====

            showUserSearchModal() {
                const modal = document.getElementById('userSearchModal');
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => {
                        modal.classList.add('active');
                        const searchInput = document.getElementById('userSearchInput');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }, 10);
                }
            }

            hideUserSearchModal() {
                const modal = document.getElementById('userSearchModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => {
                        modal.style.display = 'none';
                        this.clearUserSearchResults();
                    }, 300);
                }
            }

            async handleUserSearch(query) {
                if (!query || query.trim().length < 2) {
                    this.clearUserSearchResults();
                    return;
                }

                try {
                    const response = await fetch(`/api/users/search?query=${encodeURIComponent(query.trim())}&limit=20`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.displayUserSearchResults(data.users || []);
                    } else {
                        console.warn('Failed to search users');
                        this.clearUserSearchResults();
                    }
                } catch (error) {
                    console.error('Error searching users:', error);
                    this.clearUserSearchResults();
                }
            }

            displayUserSearchResults(users) {
                const resultsContainer = document.getElementById('userSearchResults');
                if (!resultsContainer) return;

                if (users.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="search-no-results">
                            <div class="no-results-icon">🔍</div>
                            <div class="no-results-text">No users found</div>
                            <div class="no-results-subtext">Try a different search term</div>
                        </div>
                    `;
                    return;
                }

                resultsContainer.innerHTML = users.map(user => `
                    <div class="user-result-item" data-user-id="${user.id}">
                        <div class="user-result-avatar">
                            ${user.avatar_url ?
                                `<img src="${user.avatar_url}" alt="${user.display_name || user.nickname}">` :
                                `<div class="avatar-placeholder">${(user.display_name || user.nickname || 'U').charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <div class="user-result-info">
                            <div class="user-result-name">${user.display_name || user.nickname}</div>
                            <div class="user-result-nickname">@${user.nickname}</div>
                            ${user.bio ? `<div class="user-result-bio">${user.bio}</div>` : ''}
                        </div>
                        <div class="user-result-actions">
                            <button class="user-action-btn start-chat-btn" onclick="window.talkPAI.startChatWithUser('${user.id}', '${user.nickname}')">
                                <svg viewBox="0 0 24 24">
                                    <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                Chat
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            clearUserSearchResults() {
                const resultsContainer = document.getElementById('userSearchResults');
                if (resultsContainer) {
                    resultsContainer.innerHTML = '';
                }
            }

            async startChatWithUser(userId, nickname) {
                try {
                    const response = await fetch('/api/chats', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type: 'direct',
                            participants: [userId]
                        })
                    });

                    if (response.ok) {
                        const chatData = await response.json();
                        this.hideUserSearchModal();
                        this.selectChat(chatData.chat.id);
                        console.log(`Started chat with ${nickname}`);
                    } else {
                        console.warn('Failed to start chat');
                    }
                } catch (error) {
                    console.error('Error starting chat:', error);
                }
            }

            // ===== MODAL DRAGGING SYSTEM =====

            setupModalDragging() {
                this.setupModalDrag('profileModal');
                this.setupModalDrag('userSearchModal');
            }

            setupModalDrag(modalId) {
                const modal = document.getElementById(modalId);
                if (!modal) return;

                const header = modal.querySelector('.modal-header');
                if (!header) return;

                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;

                const dragStart = (e) => {
                    if (e.type === "touchstart") {
                        initialX = e.touches[0].clientX - xOffset;
                        initialY = e.touches[0].clientY - yOffset;
                    } else {
                        initialX = e.clientX - xOffset;
                        initialY = e.clientY - yOffset;
                    }

                    if (e.target === header || header.contains(e.target)) {
                        isDragging = true;
                        header.style.cursor = 'grabbing';
                        modal.style.transition = 'none';
                    }
                };

                const dragEnd = () => {
                    isDragging = false;
                    header.style.cursor = 'grab';
                    modal.style.transition = '';
                };

                const drag = (e) => {
                    if (isDragging) {
                        e.preventDefault();

                        if (e.type === "touchmove") {
                            currentX = e.touches[0].clientX - initialX;
                            currentY = e.touches[0].clientY - initialY;
                        } else {
                            currentX = e.clientX - initialX;
                            currentY = e.clientY - initialY;
                        }

                        xOffset = currentX;
                        yOffset = currentY;

                        const maxX = window.innerWidth - modal.offsetWidth - 20;
                        const maxY = window.innerHeight - modal.offsetHeight - 20;

                        xOffset = Math.max(-20, Math.min(xOffset, maxX));
                        yOffset = Math.max(-20, Math.min(yOffset, maxY));

                        modal.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
                    }
                };

                header.style.cursor = 'grab';
                header.addEventListener('mousedown', dragStart);
                header.addEventListener('touchstart', dragStart);

                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag);

                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('touchend', dragEnd);
            }

            // ===== SIDEBAR DRAG-AND-DROP SYSTEM =====

            setupSidebarDragAndDrop() {
                const sidebarNav = document.querySelector('.sidebar-nav');
                if (!sidebarNav) return;

                this.dragState = {
                    isDragging: false,
                    draggedElement: null,
                    placeholder: null,
                    startY: 0,
                    currentY: 0,
                    offsetY: 0,
                    magneticZones: []
                };

                const navItems = sidebarNav.querySelectorAll('.nav-item');
                navItems.forEach((item, index) => {
                    this.makeNavItemDraggable(item, index);
                });

                this.createMagneticZones();
            }

            makeNavItemDraggable(navItem, index) {
                navItem.draggable = true;
                navItem.setAttribute('data-nav-index', index);

                navItem.addEventListener('dragstart', (e) => {
                    this.handleNavDragStart(e, navItem);
                });

                navItem.addEventListener('dragend', (e) => {
                    this.handleNavDragEnd(e, navItem);
                });

                navItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.handleNavDragOver(e, navItem);
                });

                navItem.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.handleNavDrop(e, navItem);
                });

                navItem.addEventListener('mousedown', (e) => {
                    this.prepareDragEffect(navItem);
                });

                navItem.addEventListener('touchstart', (e) => {
                    this.prepareDragEffect(navItem);
                });
            }

            handleNavDragStart(e, navItem) {
                this.dragState.isDragging = true;
                this.dragState.draggedElement = navItem;

                const sidebarNav = document.querySelector('.sidebar-nav');
                sidebarNav.classList.add('drag-active');

                navItem.classList.add('dragging');
                navItem.style.opacity = '0.5';
                navItem.style.transform = 'scale(1.05) rotate(2deg)';
                navItem.style.zIndex = '1000';

                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', navItem.outerHTML);

                this.createDragPlaceholder(navItem);
                this.activateMagneticZones();

                this.addDragGlow(navItem);
            }

            handleNavDragEnd(e, navItem) {
                this.dragState.isDragging = false;
                this.dragState.draggedElement = null;

                const sidebarNav = document.querySelector('.sidebar-nav');
                sidebarNav.classList.remove('drag-active');

                navItem.classList.remove('dragging');
                navItem.style.opacity = '';
                navItem.style.transform = '';
                navItem.style.zIndex = '';

                this.removeDragPlaceholder();
                this.deactivateMagneticZones();
                this.removeDragGlow();

                this.saveSidebarOrder();
            }

            handleNavDragOver(e, navItem) {
                if (!this.dragState.isDragging || navItem === this.dragState.draggedElement) return;

                const rect = navItem.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                const isBelow = e.clientY > midpoint;

                this.updateDragPlaceholder(navItem, isBelow);
                this.triggerMagneticEffect(navItem, e.clientY);
            }

            handleNavDrop(e, navItem) {
                if (!this.dragState.draggedElement || navItem === this.dragState.draggedElement) return;

                const sidebarNav = document.querySelector('.sidebar-nav');
                const draggedElement = this.dragState.draggedElement;

                const rect = navItem.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                const isBelow = e.clientY > midpoint;

                if (isBelow) {
                    navItem.parentNode.insertBefore(draggedElement, navItem.nextSibling);
                } else {
                    navItem.parentNode.insertBefore(draggedElement, navItem);
                }

                this.animateDropEffect(draggedElement);
                this.reorderNavItems();
            }

            createDragPlaceholder(draggedElement) {
                this.dragState.placeholder = document.createElement('div');
                this.dragState.placeholder.className = 'nav-item-placeholder';
                this.dragState.placeholder.style.cssText = `
                    height: ${draggedElement.offsetHeight}px;
                    margin: var(--spacing-xs) 0;
                    border: 2px dashed var(--accent-primary);
                    border-radius: var(--radius-lg);
                    background: var(--glass-subtle);
                    backdrop-filter: blur(var(--glass-blur));
                    opacity: 0.6;
                    transition: all var(--transition-fast) var(--spring);
                    position: relative;
                    overflow: hidden;
                `;

                this.dragState.placeholder.innerHTML = `
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        color: var(--accent-primary);
                        font-size: 12px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                    ">Drop Here</div>
                `;

                draggedElement.parentNode.insertBefore(this.dragState.placeholder, draggedElement);
            }

            updateDragPlaceholder(targetElement, isBelow) {
                if (!this.dragState.placeholder) return;

                if (isBelow) {
                    targetElement.parentNode.insertBefore(this.dragState.placeholder, targetElement.nextSibling);
                } else {
                    targetElement.parentNode.insertBefore(this.dragState.placeholder, targetElement);
                }

                this.dragState.placeholder.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    if (this.dragState.placeholder) {
                        this.dragState.placeholder.style.transform = '';
                    }
                }, 150);
            }

            removeDragPlaceholder() {
                if (this.dragState.placeholder) {
                    this.dragState.placeholder.remove();
                    this.dragState.placeholder = null;
                }
            }

            createMagneticZones() {
                const sidebarNav = document.querySelector('.sidebar-nav');
                if (!sidebarNav) return;

                const navItems = sidebarNav.querySelectorAll('.nav-item');
                this.dragState.magneticZones = Array.from(navItems).map(item => {
                    const rect = item.getBoundingClientRect();
                    return {
                        element: item,
                        top: rect.top,
                        bottom: rect.bottom,
                        center: rect.top + rect.height / 2,
                        magneticRange: 30
                    };
                });
            }

            activateMagneticZones() {
                this.dragState.magneticZones.forEach(zone => {
                    zone.element.classList.add('magnetic-zone');
                });
            }

            deactivateMagneticZones() {
                this.dragState.magneticZones.forEach(zone => {
                    zone.element.classList.remove('magnetic-zone', 'magnetic-active');
                });
            }

            triggerMagneticEffect(navItem, clientY) {
                const zone = this.dragState.magneticZones.find(z => z.element === navItem);
                if (!zone) return;

                const distanceFromCenter = Math.abs(clientY - zone.center);

                if (distanceFromCenter <= zone.magneticRange) {
                    const magneticStrength = 1 - (distanceFromCenter / zone.magneticRange);

                    navItem.classList.add('magnetic-active');
                    navItem.style.transform = `scale(${1 + magneticStrength * 0.1}) translateX(${magneticStrength * 8}px)`;
                    navItem.style.boxShadow = `0 0 ${magneticStrength * 30}px var(--neon-glow)`;

                    this.createMagneticParticles(navItem, magneticStrength);
                } else {
                    navItem.classList.remove('magnetic-active');
                    navItem.style.transform = '';
                    navItem.style.boxShadow = '';
                }
            }

            createMagneticParticles(element, strength) {
                if (Math.random() > 0.7) {
                    const particle = document.createElement('div');
                    particle.className = 'magnetic-particle';
                    particle.style.cssText = `
                        position: absolute;
                        width: ${2 + strength * 4}px;
                        height: ${2 + strength * 4}px;
                        background: var(--accent-primary);
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 1001;
                        opacity: ${strength};
                        animation: magneticParticle 0.8s ease-out forwards;
                    `;

                    const rect = element.getBoundingClientRect();
                    particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                    particle.style.top = (rect.top + Math.random() * rect.height) + 'px';

                    document.body.appendChild(particle);

                    setTimeout(() => {
                        particle.remove();
                    }, 800);
                }
            }

            addDragGlow(element) {
                element.style.filter = 'drop-shadow(0 0 20px var(--accent-primary))';
            }

            removeDragGlow() {
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.style.filter = '';
                });
            }

            animateDropEffect(element) {
                element.style.animation = 'dropBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)';

                setTimeout(() => {
                    element.style.animation = '';
                }, 600);
            }

            prepareDragEffect(element) {
                element.style.transition = 'all var(--transition-fast) var(--spring)';
                element.style.cursor = 'grabbing';
            }

            reorderNavItems() {
                const sidebarNav = document.querySelector('.sidebar-nav');
                const navItems = sidebarNav.querySelectorAll('.nav-item');

                navItems.forEach((item, index) => {
                    item.setAttribute('data-nav-index', index);
                });

                this.createMagneticZones();
            }

            saveSidebarOrder() {
                const sidebarNav = document.querySelector('.sidebar-nav');
                const navItems = sidebarNav.querySelectorAll('.nav-item');

                const order = Array.from(navItems).map(item => ({
                    nav: item.getAttribute('data-nav'),
                    position: item.getAttribute('data-nav-index')
                }));

                localStorage.setItem('talkpai-sidebar-order', JSON.stringify(order));
                console.log('Sidebar order saved:', order);
            }

            loadSidebarOrder() {
                const savedOrder = localStorage.getItem('talkpai-sidebar-order');
                if (!savedOrder) return;

                try {
                    const order = JSON.parse(savedOrder);
                    this.applySidebarOrder(order);
                } catch (error) {
                    console.warn('Failed to load sidebar order:', error);
                }
            }

            applySidebarOrder(order) {
                const sidebarNav = document.querySelector('.sidebar-nav');
                if (!sidebarNav || !order.length) return;

                const navItems = Array.from(sidebarNav.querySelectorAll('.nav-item'));
                const orderedItems = [];

                order.forEach(orderItem => {
                    const item = navItems.find(navItem =>
                        navItem.getAttribute('data-nav') === orderItem.nav
                    );
                    if (item) {
                        orderedItems.push(item);
                    }
                });

                navItems.forEach(item => {
                    if (!orderedItems.includes(item)) {
                        orderedItems.push(item);
                    }
                });

                orderedItems.forEach(item => {
                    sidebarNav.appendChild(item);
                });

                this.reorderNavItems();
            }

            // ===== ENHANCED MODAL STACK MANAGER =====

            initializeModalStackManager() {
                this.modalStack = {
                    activeModals: [],
                    baseZIndex: 2000,
                    maxCascadeDepth: 5,
                    cascadeOffset: { x: 30, y: 30 },
                    scaleReduction: 0.05,
                    blurIncrease: 2
                };

                this.setupModalStackEvents();
                this.createModalStackContainer();
            }

            createModalStackContainer() {
                let stackContainer = document.getElementById('modalStackContainer');
                if (!stackContainer) {
                    stackContainer = document.createElement('div');
                    stackContainer.id = 'modalStackContainer';
                    stackContainer.className = 'modal-stack-container';
                    stackContainer.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        pointer-events: none;
                        z-index: 2000;
                    `;
                    document.body.appendChild(stackContainer);
                }
                return stackContainer;
            }

            setupModalStackEvents() {
                document.addEventListener('click', (e) => {
                    const modal = e.target.closest('.floating-modal');
                    if (modal) {
                        this.bringModalToFront(modal);
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeTopModal();
                    } else if (e.key === 'Tab' && e.altKey) {
                        e.preventDefault();
                        this.cycleModals();
                    }
                });
            }

            showModalWithStack(modalId, options = {}) {
                const modal = document.getElementById(modalId);
                if (!modal) return;

                const stackContainer = this.createModalStackContainer();

                if (!this.modalStack.activeModals.find(m => m.id === modalId)) {
                    const modalData = {
                        id: modalId,
                        element: modal,
                        originalParent: modal.parentNode,
                        options: {
                            closable: options.closable !== false,
                            draggable: options.draggable !== false,
                            resizable: options.resizable === true,
                            minimizable: options.minimizable === true,
                            maximizable: options.maximizable === true,
                            ...options
                        },
                        state: {
                            minimized: false,
                            maximized: false,
                            position: { x: 0, y: 0 },
                            size: { width: 'auto', height: 'auto' }
                        }
                    };

                    this.modalStack.activeModals.push(modalData);
                    stackContainer.appendChild(modal);
                }

                modal.style.display = 'flex';
                modal.style.pointerEvents = 'auto';

                setTimeout(() => {
                    modal.classList.add('active');
                    this.updateModalStack();
                    this.focusModal(modal);
                }, 10);

                this.addModalControls(modal);
            }

            hideModalFromStack(modalId) {
                const modalIndex = this.modalStack.activeModals.findIndex(m => m.id === modalId);
                if (modalIndex === -1) return;

                const modalData = this.modalStack.activeModals[modalIndex];
                const modal = modalData.element;

                modal.classList.remove('active');
                modal.style.pointerEvents = 'none';

                setTimeout(() => {
                    modal.style.display = 'none';
                    if (modalData.originalParent) {
                        modalData.originalParent.appendChild(modal);
                    }
                    this.modalStack.activeModals.splice(modalIndex, 1);
                    this.updateModalStack();
                }, 300);
            }

            bringModalToFront(modal) {
                const modalId = modal.id;
                const modalIndex = this.modalStack.activeModals.findIndex(m => m.id === modalId);

                if (modalIndex > -1 && modalIndex < this.modalStack.activeModals.length - 1) {
                    const modalData = this.modalStack.activeModals.splice(modalIndex, 1)[0];
                    this.modalStack.activeModals.push(modalData);
                    this.updateModalStack();
                    this.focusModal(modal);
                }
            }

            updateModalStack() {
                this.modalStack.activeModals.forEach((modalData, index) => {
                    const modal = modalData.element;
                    const depth = this.modalStack.activeModals.length - 1 - index;
                    const zIndex = this.modalStack.baseZIndex + index;

                    if (modalData.state.minimized) {
                        this.applyMinimizedStyle(modal, index);
                        return;
                    }

                    if (modalData.state.maximized) {
                        this.applyMaximizedStyle(modal, zIndex);
                        return;
                    }

                    const scale = Math.max(0.7, 1 - (depth * this.modalStack.scaleReduction));
                    const offsetX = depth * this.modalStack.cascadeOffset.x;
                    const offsetY = depth * this.modalStack.cascadeOffset.y;
                    const blur = depth * this.modalStack.blurIncrease;
                    const opacity = Math.max(0.3, 1 - (depth * 0.15));

                    modal.style.cssText += `
                        z-index: ${zIndex};
                        transform: translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px)) scale(${scale});
                        filter: blur(${blur}px) brightness(${opacity});
                        opacity: ${depth === 0 ? 1 : opacity};
                        transition: all var(--transition-normal) var(--spring);
                        pointer-events: ${depth === 0 ? 'auto' : 'none'};
                    `;

                    if (depth > 0) {
                        modal.classList.add('modal-stacked');
                        modal.setAttribute('data-stack-index', depth + 1);
                        modal.style.setProperty('--offset-x', `${offsetX}px`);
                        modal.style.setProperty('--offset-y', `${offsetY}px`);
                    } else {
                        modal.classList.remove('modal-stacked');
                        modal.removeAttribute('data-stack-index');
                    }
                });
            }

            closeTopModal() {
                if (this.modalStack.activeModals.length > 0) {
                    const topModal = this.modalStack.activeModals[this.modalStack.activeModals.length - 1];
                    if (topModal.options.closable) {
                        this.hideModalFromStack(topModal.id);
                    }
                }
            }

            cycleModals() {
                if (this.modalStack.activeModals.length > 1) {
                    const topModal = this.modalStack.activeModals.pop();
                    this.modalStack.activeModals.unshift(topModal);
                    this.updateModalStack();
                    this.focusModal(this.modalStack.activeModals[this.modalStack.activeModals.length - 1].element);
                }
            }

            focusModal(modal) {
                const focusableElement = modal.querySelector('input, button, textarea, select, [tabindex]:not([tabindex="-1"])');
                if (focusableElement) {
                    focusableElement.focus();
                }
            }

            addModalControls(modal) {
                let controls = modal.querySelector('.modal-controls');
                if (controls) return;

                const header = modal.querySelector('.modal-header');
                if (!header) return;

                controls = document.createElement('div');
                controls.className = 'modal-controls';
                controls.innerHTML = `
                    <button class="modal-control-btn minimize" title="Minimize">
                        <svg viewBox="0 0 24 24" width="12" height="12">
                            <path d="M6 12h12" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                    <button class="modal-control-btn maximize" title="Maximize">
                        <svg viewBox="0 0 24 24" width="12" height="12">
                            <rect x="3" y="3" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                    <button class="modal-control-btn close" title="Close">
                        <svg viewBox="0 0 24 24" width="12" height="12">
                            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                `;

                header.appendChild(controls);

                controls.querySelector('.minimize').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleMinimizeModal(modal);
                });

                controls.querySelector('.maximize').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleMaximizeModal(modal);
                });

                controls.querySelector('.close').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.hideModalFromStack(modal.id);
                });
            }

            toggleMinimizeModal(modal) {
                const modalData = this.modalStack.activeModals.find(m => m.element === modal);
                if (!modalData) return;

                modalData.state.minimized = !modalData.state.minimized;
                this.updateModalStack();
            }

            toggleMaximizeModal(modal) {
                const modalData = this.modalStack.activeModals.find(m => m.element === modal);
                if (!modalData) return;

                modalData.state.maximized = !modalData.state.maximized;
                this.updateModalStack();
            }

            applyMinimizedStyle(modal, index) {
                const taskbarHeight = 60;
                const taskbarItemWidth = 200;
                const taskbarX = index * (taskbarItemWidth + 10) + 20;
                const taskbarY = window.innerHeight - taskbarHeight - 20;

                modal.style.setProperty('--taskbar-x', `${taskbarX}px`);
                modal.style.setProperty('--taskbar-y', `${taskbarY}px`);

                modal.style.cssText += `
                    transform: translate(${taskbarX}px, ${taskbarY}px) scale(0.3);
                    width: ${taskbarItemWidth}px;
                    height: ${taskbarHeight}px;
                    opacity: 0.8;
                    pointer-events: auto;
                    border-radius: var(--radius-xl);
                    transition: all var(--transition-normal) var(--spring);
                    animation: modalMinimize 0.5s var(--spring);
                `;

                modal.classList.add('modal-minimized');
            }

            applyMaximizedStyle(modal, zIndex) {
                modal.style.cssText += `
                    transform: translate(-50%, -50%) scale(1);
                    width: calc(100vw - 40px);
                    height: calc(100vh - 40px);
                    max-width: none;
                    max-height: none;
                    z-index: ${zIndex};
                    opacity: 1;
                    filter: none;
                    pointer-events: auto;
                    transition: all var(--transition-normal) var(--spring);
                `;

                modal.classList.add('modal-maximized');
            }

            // Enhanced modal show/hide methods to use the stack system
            showProfileModal() {
                this.showModalWithStack('profileModal', {
                    closable: true,
                    draggable: true,
                    minimizable: true,
                    maximizable: false
                });
                this.loadUserProfile();
            }

            hideProfileModal() {
                this.hideModalFromStack('profileModal');
            }

            showUserSearchModal() {
                this.showModalWithStack('userSearchModal', {
                    closable: true,
                    draggable: true,
                    minimizable: true,
                    maximizable: true
                });
                setTimeout(() => {
                    const searchInput = document.getElementById('userSearchInput');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }, 100);
            }

            hideUserSearchModal() {
                this.hideModalFromStack('userSearchModal');
                this.clearUserSearchResults();
            }
        }

        // ===== CORPORATE-GRADE SECURITY CLASSES =====

        class TalkPAIEncryption {
            constructor() {
                this.keySize = 256;
                this.iterations = 10000;
            }

            generateCSRFToken() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            async hashPassword(password, salt) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password + salt);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(hashBuffer))
                    .map(b => b.toString(16).padStart(2, '0')).join('');
            }

            generateSalt() {
                const array = new Uint8Array(16);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                return input
                    .replace(/[<>]/g, '')
                    .replace(/javascript:/gi, '')
                    .replace(/on\w+=/gi, '')
                    .trim();
            }
        }

        class TalkPAIValidator {
            isValidJWT(token) {
                if (!token || typeof token !== 'string') return false;
                const parts = token.split('.');
                if (parts.length !== 3) return false;

                try {
                    const payload = JSON.parse(atob(parts[1]));
                    const now = Math.floor(Date.now() / 1000);
                    return payload.exp > now;
                } catch {
                    return false;
                }
            }

            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email) && email.length <= 254;
            }

            isValidNickname(nickname) {
                return /^[a-zA-Z0-9_-]{3,20}$/.test(nickname);
            }

            validateFileUpload(file) {
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                const maxSize = 5 * 1024 * 1024; // 5MB

                return {
                    isValid: allowedTypes.includes(file.type) && file.size <= maxSize,
                    error: !allowedTypes.includes(file.type) ? 'Invalid file type' :
                           file.size > maxSize ? 'File too large' : null
                };
            }

            sanitizeMessage(message) {
                return message
                    .replace(/[<>]/g, '')
                    .replace(/javascript:/gi, '')
                    .substring(0, 1000);
            }
        }

        class TalkPAISecurityMonitor {
            constructor() {
                this.suspiciousActivity = [];
                this.loginAttempts = new Map();
                this.pageHiddenTime = null;
            }

            performSecurityCheck() {
                this.checkForSuspiciousActivity();
                this.verifySessionIntegrity();
                this.monitorMemoryUsage();
            }

            reportViolation(violation) {
                console.warn('Security policy violation:', violation);
                this.suspiciousActivity.push({
                    ...violation,
                    severity: 'high'
                });
            }

            onPageHidden() {
                this.pageHiddenTime = Date.now();
            }

            onPageVisible() {
                if (this.pageHiddenTime) {
                    const hiddenDuration = Date.now() - this.pageHiddenTime;
                    if (hiddenDuration > 5 * 60 * 1000) { // 5 minutes
                        this.checkSessionAfterLongHide();
                    }
                    this.pageHiddenTime = null;
                }
            }

            checkForSuspiciousActivity() {
                const recentViolations = this.suspiciousActivity.filter(
                    v => Date.now() - new Date(v.timestamp).getTime() < 60000
                );

                if (recentViolations.length > 5) {
                    this.triggerSecurityAlert('Multiple security violations detected');
                }
            }

            verifySessionIntegrity() {
                const token = localStorage.getItem('authToken');
                if (token && this.isTokenCompromised(token)) {
                    this.handleCompromisedSession();
                }
            }

            isTokenCompromised(token) {
                // Basic compromise detection
                return token.includes('<script>') || token.includes('javascript:');
            }

            handleCompromisedSession() {
                localStorage.clear();
                sessionStorage.clear();
                window.location.reload();
            }

            checkSessionAfterLongHide() {
                // Re-validate session after long absence
                const token = localStorage.getItem('authToken');
                if (token) {
                    // Trigger re-authentication if needed
                    console.log('Session validation after long absence');
                }
            }

            monitorMemoryUsage() {
                if (performance.memory) {
                    const memoryInfo = performance.memory;
                    const memoryUsage = memoryInfo.usedJSHeapSize / memoryInfo.totalJSHeapSize;

                    if (memoryUsage > 0.9) {
                        console.warn('High memory usage detected:', memoryUsage);
                    }
                }
            }

            triggerSecurityAlert(message) {
                console.error('Security Alert:', message);
                // In production, this would send an alert to security monitoring
            }
        }

        class TalkPAISecureStorage {
            constructor() {
                this.prefix = 'talkpai_secure_';
                this.sensitiveKeys = new Set(['authToken', 'refreshToken', 'csrfToken']);
            }

            initializeSecureSession() {
                this.sessionId = this.generateSessionId();
                this.setSecureItem('sessionId', this.sessionId);
            }

            generateSessionId() {
                const array = new Uint8Array(16);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            setSecureItem(key, value) {
                try {
                    const encrypted = this.encrypt(JSON.stringify(value));
                    const storageKey = this.prefix + key;
                    localStorage.setItem(storageKey, encrypted);
                } catch (error) {
                    console.error('Failed to store secure item:', error);
                }
            }

            getSecureItem(key) {
                try {
                    const storageKey = this.prefix + key;
                    const encrypted = localStorage.getItem(storageKey);
                    if (!encrypted) return null;

                    const decrypted = this.decrypt(encrypted);
                    return JSON.parse(decrypted);
                } catch (error) {
                    console.error('Failed to retrieve secure item:', error);
                    return null;
                }
            }

            removeSecureItem(key) {
                const storageKey = this.prefix + key;
                localStorage.removeItem(storageKey);
            }

            clearSensitiveData() {
                this.sensitiveKeys.forEach(key => {
                    this.removeSecureItem(key);
                });
            }

            encrypt(data) {
                // Simple XOR encryption for demo (use proper encryption in production)
                const key = this.getEncryptionKey();
                let result = '';
                for (let i = 0; i < data.length; i++) {
                    result += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return btoa(result);
            }

            decrypt(encryptedData) {
                const key = this.getEncryptionKey();
                const data = atob(encryptedData);
                let result = '';
                for (let i = 0; i < data.length; i++) {
                    result += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            }

            getEncryptionKey() {
                return 'TalkPAI_SecureKey_' + this.sessionId;
            }
        }

        class TalkPAIRateLimiter {
            constructor() {
                this.limits = new Map();
                this.defaultLimit = { requests: 100, window: 60000 }; // 100 requests per minute
            }

            checkLimit(key, customLimit = null) {
                const limit = customLimit || this.defaultLimit;
                const now = Date.now();
                const windowStart = now - limit.window;

                if (!this.limits.has(key)) {
                    this.limits.set(key, []);
                }

                const requests = this.limits.get(key);
                const validRequests = requests.filter(time => time > windowStart);

                this.limits.set(key, validRequests);

                if (validRequests.length >= limit.requests) {
                    return { allowed: false, retryAfter: limit.window };
                }

                validRequests.push(now);
                this.limits.set(key, validRequests);
                return { allowed: true };
            }
        }

        class TalkPAISecurityLogger {
            constructor() {
                this.logs = [];
                this.maxLogs = 1000;
            }

            log(level, message, data = {}) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    level,
                    message,
                    data,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };

                this.logs.push(logEntry);

                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }

                // In production, send to logging service
                console.log(`[${level.toUpperCase()}] ${message}`, data);
            }

            error(message, data) { this.log('error', message, data); }
            warn(message, data) { this.log('warn', message, data); }
            info(message, data) { this.log('info', message, data); }
            debug(message, data) { this.log('debug', message, data); }
        }

        // ===== RELIABILITY CLASSES =====

        class TalkPAIErrorHandler {
            constructor() {
                this.errors = [];
                this.maxErrors = 100;
                this.retryableErrors = new Set(['NetworkError', 'TimeoutError', 'AbortError']);
            }

            handleError(error) {
                const errorEntry = {
                    id: this.generateErrorId(),
                    ...error,
                    handled: false,
                    retryCount: 0
                };

                this.errors.push(errorEntry);

                if (this.errors.length > this.maxErrors) {
                    this.errors.shift();
                }

                this.processError(errorEntry);
                return errorEntry.id;
            }

            processError(error) {
                if (this.isRetryableError(error)) {
                    this.scheduleRetry(error);
                } else {
                    this.logCriticalError(error);
                }
            }

            isRetryableError(error) {
                return this.retryableErrors.has(error.type) ||
                       (error.message && error.message.includes('fetch'));
            }

            scheduleRetry(error) {
                if (error.retryCount < 3) {
                    setTimeout(() => {
                        error.retryCount++;
                        // Retry logic would go here
                        console.log(`Retrying error ${error.id}, attempt ${error.retryCount}`);
                    }, Math.pow(2, error.retryCount) * 1000);
                }
            }

            generateErrorId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            logCriticalError(error) {
                console.error('Critical error:', error);
                // In production, this would be sent to error monitoring service
            }
        }

        class TalkPAIRetryManager {
            constructor() {
                this.retryQueue = [];
                this.processing = false;
            }

            async retryWithBackoff(fn, maxRetries = 3, baseDelay = 1000) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        return await fn();
                    } catch (error) {
                        if (attempt === maxRetries) throw error;

                        const delay = baseDelay * Math.pow(2, attempt - 1);
                        await this.delay(delay);
                    }
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        class TalkPAIConnectionMonitor {
            constructor() {
                this.isOnline = navigator.onLine;
                this.connectionQuality = 'unknown';
                this.lastPingTime = null;
            }

            async checkConnection() {
                try {
                    const start = performance.now();
                    await fetch('/api/ping', {
                        method: 'HEAD',
                        cache: 'no-cache'
                    });
                    const pingTime = performance.now() - start;

                    this.lastPingTime = pingTime;
                    this.updateConnectionQuality(pingTime);
                } catch (error) {
                    this.connectionQuality = 'offline';
                    console.warn('Connection check failed:', error);
                }
            }

            updateConnectionQuality(pingTime) {
                if (pingTime < 100) {
                    this.connectionQuality = 'excellent';
                } else if (pingTime < 500) {
                    this.connectionQuality = 'good';
                } else if (pingTime < 1000) {
                    this.connectionQuality = 'fair';
                } else {
                    this.connectionQuality = 'poor';
                }
            }

            onOnline() {
                this.isOnline = true;
                console.log('Connection restored');
                // Trigger reconnection logic
            }

            onOffline() {
                this.isOnline = false;
                console.log('Connection lost');
                // Trigger offline mode
            }
        }

        class TalkPAIDataIntegrity {
            constructor() {
                this.checksums = new Map();
            }

            verifyDataIntegrity() {
                // Check critical data integrity
                this.verifyLocalStorage();
                this.verifySessionData();
            }

            verifyLocalStorage() {
                const criticalKeys = ['talkpai-theme', 'talkpai-sidebar-collapsed'];
                criticalKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value && this.isDataCorrupted(value)) {
                        console.warn(`Corrupted data detected for key: ${key}`);
                        localStorage.removeItem(key);
                    }
                });
            }

            verifySessionData() {
                // Verify session data hasn't been tampered with
                const sessionId = localStorage.getItem('talkpai_secure_sessionId');
                if (sessionId && !this.isValidSessionId(sessionId)) {
                    console.warn('Invalid session ID detected');
                    // Clear session and force re-authentication
                }
            }

            isDataCorrupted(data) {
                // Basic corruption detection
                return data.includes('<script>') ||
               data.includes('javascript:') ||
               data.length > 10000;
            }

            isValidSessionId(sessionId) {
                return /^[a-f0-9]{32}$/.test(sessionId);
            }

            generateChecksum(data) {
                let hash = 0;
                for (let i = 0; i < data.length; i++) {
                    const char = data.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return hash.toString(16);
            }
        }

        class TalkPAIBackupManager {
            constructor() {
                this.backups = new Map();
                this.maxBackups = 5;
            }

            createBackup(key, data) {
                if (!this.backups.has(key)) {
                    this.backups.set(key, []);
                }

                const backupList = this.backups.get(key);
                backupList.push({
                    timestamp: Date.now(),
                    data: JSON.parse(JSON.stringify(data))
                });

                if (backupList.length > this.maxBackups) {
                    backupList.shift();
                }
            }

            restoreBackup(key, index = -1) {
                const backupList = this.backups.get(key);
                if (!backupList || backupList.length === 0) return null;

                const backup = index === -1 ?
                    backupList[backupList.length - 1] :
                    backupList[index];

                return backup ? backup.data : null;
            }

            clearBackups(key) {
                this.backups.delete(key);
            }
        }

        // Initialize the messenger when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.talkPAI = new TalkPAIMessenger();

            // Demo commands for testing functionality
            console.log(`
🎯 Talk pAI Demo Commands:
────────────────────────────────────────
📞 Voice & Video Calls:
• talkPAI.startVoiceCall()        - Start voice call
• talkPAI.startVideoCall()        - Start video call
• talkPAI.simulateIncomingCall()  - Simulate incoming voice call
• talkPAI.simulateIncomingCall('video') - Simulate incoming video call
• talkPAI.endCall()              - End current call
• talkPAI.toggleMute()           - Toggle mute/unmute
• talkPAI.toggleVideo()          - Toggle camera on/off
• talkPAI.toggleScreenShare()    - Toggle screen sharing

📁 Drag & Drop:
• talkPAI.showDragZone()         - Show drag zone
• talkPAI.hideDragZone()         - Hide drag zone
• talkPAI.showFilePreview()      - Show file preview
• talkPAI.openFileDialog()       - Open file dialog

🎨 Interface:
• talkPAI.toggleSidebar()        - Toggle sidebar
• talkPAI.changeTheme('dark')    - Change theme
• talkPAI.sendMessage()          - Send demo message
────────────────────────────────────────
🚀 Try drag & drop files onto the window!
🚀 Try clicking the call/video buttons in the chat header!
            `);
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }
    </script>
</body>
</html>