<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk pAI - Next Generation Messenger</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">

    <!-- Progressive Web App -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- External Libraries -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-js@8.0.0/lib/emoji.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>

    <style>
        /* ================================ */
        /* CSS CUSTOM PROPERTIES & THEMES  */
        /* ================================ */

        :root {
            /* Glassmorphism Colors */
            --glass-primary: rgba(255, 255, 255, 0.15);
            --glass-secondary: rgba(255, 255, 255, 0.08);
            --glass-accent: rgba(102, 126, 234, 0.2);
            --glass-hover: rgba(255, 255, 255, 0.25);
            --glass-active: rgba(255, 255, 255, 0.35);

            /* Background Gradients */
            --bg-primary: linear-gradient(135deg,
                #667eea 0%, #764ba2 25%, #667eea 50%, #764ba2 75%, #667eea 100%);
            --bg-secondary: linear-gradient(45deg,
                rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);

            /* Text Colors */
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.75);
            --text-tertiary: rgba(255, 255, 255, 0.55);
            --text-muted: rgba(255, 255, 255, 0.35);

            /* Accent Colors */
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --accent-success: #00d4aa;
            --accent-warning: #ff9500;
            --accent-error: #ff3b3b;
            --accent-info: #0099ff;

            /* Shadows */
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-glass-hover: 0 12px 48px rgba(0, 0, 0, 0.18);
            --shadow-neon: 0 0 20px rgba(102, 126, 234, 0.3);
            --shadow-neon-hover: 0 0 30px rgba(102, 126, 234, 0.5);

            /* Borders */
            --border-glass: 1px solid rgba(255, 255, 255, 0.18);
            --border-glass-strong: 1px solid rgba(255, 255, 255, 0.3);

            /* Blur */
            --blur-glass: blur(10px);
            --blur-strong: blur(20px);

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;

            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-2xl: 24px;

            /* Transitions */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
            --transition-normal: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
            --transition-spring: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);

            /* Layout */
            --sidebar-width: 320px;
            --sidebar-collapsed-width: 80px;
            --header-height: 70px;
            --chat-input-height: 80px;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --glass-primary: rgba(20, 20, 20, 0.8);
            --glass-secondary: rgba(20, 20, 20, 0.6);
            --glass-accent: rgba(102, 126, 234, 0.15);
            --glass-hover: rgba(40, 40, 40, 0.8);
            --glass-active: rgba(60, 60, 60, 0.8);

            --bg-primary: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            --bg-secondary: linear-gradient(45deg, rgba(20, 20, 20, 0.9) 0%, rgba(40, 40, 40, 0.9) 100%);

            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            --text-muted: rgba(255, 255, 255, 0.3);

            --border-glass: 1px solid rgba(255, 255, 255, 0.1);
            --border-glass-strong: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* AMOLED Theme */
        [data-theme="amoled"] {
            --glass-primary: rgba(0, 0, 0, 0.95);
            --glass-secondary: rgba(0, 0, 0, 0.8);
            --glass-accent: rgba(102, 126, 234, 0.2);
            --glass-hover: rgba(20, 20, 20, 0.95);
            --glass-active: rgba(40, 40, 40, 0.95);

            --bg-primary: #000000;
            --bg-secondary: linear-gradient(45deg, #000000 0%, #111111 100%);

            --border-glass: 1px solid rgba(255, 255, 255, 0.05);
            --border-glass-strong: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* ================================ */
        /* RESET & BASE STYLES              */
        /* ================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::before,
        *::after {
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(102, 126, 234, 0.05) 0%, transparent 50%);
            animation: backgroundFloat 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: scale(1) rotate(0deg); }
            33% { transform: scale(1.1) rotate(1deg); }
            66% { transform: scale(0.9) rotate(-1deg); }
        }

        /* ================================ */
        /* SCROLLBAR STYLES                 */
        /* ================================ */

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-primary);
            border-radius: 10px;
            backdrop-filter: var(--blur-glass);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--glass-hover);
        }

        /* ================================ */
        /* GLASS COMPONENTS                 */
        /* ================================ */

        .glass {
            background: var(--glass-primary);
            backdrop-filter: var(--blur-glass);
            -webkit-backdrop-filter: var(--blur-glass);
            border: var(--border-glass);
            box-shadow: var(--shadow-glass);
            transition: var(--transition-normal);
        }

        .glass:hover {
            background: var(--glass-hover);
            box-shadow: var(--shadow-glass-hover);
            transform: translateY(-1px);
        }

        .glass-strong {
            background: var(--glass-secondary);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border: var(--border-glass-strong);
        }

        .glass-accent {
            background: var(--glass-accent);
            box-shadow: var(--shadow-neon);
        }

        .glass-accent:hover {
            box-shadow: var(--shadow-neon-hover);
        }

        /* ================================ */
        /* LAYOUT COMPONENTS                */
        /* ================================ */

        .app-container {
            display: grid;
            grid-template-areas:
                "sidebar header"
                "sidebar main";
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: var(--header-height) 1fr;
            height: 100vh;
            gap: 0;
        }

        .app-container.sidebar-collapsed {
            grid-template-columns: var(--sidebar-collapsed-width) 1fr;
        }

        /* ================================ */
        /* SIDEBAR STYLES                   */
        /* ================================ */

        .sidebar {
            grid-area: sidebar;
            display: flex;
            flex-direction: column;
            background: var(--glass-primary);
            backdrop-filter: var(--blur-glass);
            border-right: var(--border-glass);
            box-shadow: var(--shadow-glass);
            z-index: 100;
            transition: var(--transition-spring);
            overflow: hidden;
        }

        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: var(--border-glass);
            background: var(--glass-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            min-height: var(--header-height);
        }

        .sidebar-collapsed .sidebar-header {
            padding: var(--space-md);
            justify-content: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 800;
            font-size: 1.25rem;
            color: var(--text-primary);
            transition: var(--transition-normal);
        }

        .sidebar-collapsed .logo-text {
            display: none;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--accent-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-neon);
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            margin-left: auto;
        }

        .sidebar-toggle:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-nav {
            padding: var(--space-md);
        }

        .nav-section {
            margin-bottom: var(--space-lg);
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-sm);
            padding: 0 var(--space-sm);
        }

        .sidebar-collapsed .nav-title {
            display: none;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition-fast);
            cursor: pointer;
            margin-bottom: var(--space-xs);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-normal);
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--glass-accent);
            color: var(--text-primary);
            box-shadow: var(--shadow-neon);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nav-text {
            flex: 1;
            transition: var(--transition-normal);
        }

        .sidebar-collapsed .nav-text {
            opacity: 0;
            transform: translateX(-10px);
        }

        .nav-badge {
            background: var(--accent-error);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ================================ */
        /* CHAT LIST STYLES                 */
        /* ================================ */

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 var(--space-md);
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
            margin-bottom: var(--space-sm);
            position: relative;
            overflow: hidden;
        }

        .chat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-hover);
            opacity: 0;
            transition: var(--transition-fast);
        }

        .chat-item:hover::before {
            opacity: 1;
        }

        .chat-item:hover {
            transform: scale(1.02);
        }

        .chat-item.active {
            background: var(--glass-accent);
            box-shadow: var(--shadow-neon);
        }

        .chat-item.pinned {
            border-left: 3px solid var(--accent-primary);
        }

        .chat-item.muted {
            opacity: 0.6;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--glass-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .chat-avatar.ai-assistant {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            box-shadow: var(--shadow-neon);
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-md);
        }

        .chat-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--glass-primary);
            background: var(--accent-success);
        }

        .chat-status.away {
            background: var(--accent-warning);
        }

        .chat-status.busy {
            background: var(--accent-error);
        }

        .chat-status.offline {
            background: var(--text-muted);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
            position: relative;
            z-index: 1;
        }

        .chat-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .chat-preview {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-xs);
            position: relative;
            z-index: 1;
        }

        .chat-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .chat-badge {
            background: var(--accent-primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .chat-menu-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            opacity: 0;
            transition: var(--transition-fast);
            position: relative;
            z-index: 2;
        }

        .chat-item:hover .chat-menu-btn {
            opacity: 1;
        }

        .chat-menu-btn:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        /* ================================ */
        /* HEADER STYLES                    */
        /* ================================ */

        .main-header {
            grid-area: header;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-xl);
            background: var(--glass-primary);
            backdrop-filter: var(--blur-glass);
            border-bottom: var(--border-glass);
            box-shadow: var(--shadow-glass);
            z-index: 90;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .header-search {
            position: relative;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: var(--space-md) var(--space-lg) var(--space-md) 3rem;
            background: var(--glass-secondary);
            border: var(--border-glass);
            border-radius: var(--radius-xl);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-fast);
            backdrop-filter: var(--blur-glass);
        }

        .search-input:focus {
            outline: none;
            background: var(--glass-hover);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-tertiary);
        }

        .search-icon {
            position: absolute;
            left: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            transition: var(--transition-fast);
        }

        .search-input:focus + .search-icon {
            color: var(--accent-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .header-btn {
            width: 40px;
            height: 40px;
            background: var(--glass-secondary);
            border: var(--border-glass);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .header-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--glass-accent);
            border-radius: 50%;
            transition: var(--transition-fast);
            transform: translate(-50%, -50%);
        }

        .header-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .header-btn:hover {
            color: var(--text-primary);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-neon);
        }

        .header-btn svg {
            position: relative;
            z-index: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--glass-accent);
            border: 2px solid var(--accent-primary);
            cursor: pointer;
            overflow: hidden;
            transition: var(--transition-fast);
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-neon-hover);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ================================ */
        /* MAIN CONTENT STYLES              */
        /* ================================ */

        .main-content {
            grid-area: main;
            display: flex;
            flex-direction: column;
            background: var(--glass-secondary);
            backdrop-filter: var(--blur-glass);
            position: relative;
            overflow: hidden;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            animation: messageSlideIn 0.3s ease-out;
            position: relative;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message.own .message-bubble {
            background: var(--glass-accent);
            border: 1px solid var(--accent-primary);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--glass-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
            border: var(--border-glass);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-md);
        }

        .message-content {
            flex: 1;
            max-width: 70%;
            position: relative;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }

        .message-sender {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .message-bubble {
            background: var(--glass-primary);
            border: var(--border-glass);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            color: var(--text-primary);
            line-height: 1.4;
            backdrop-filter: var(--blur-glass);
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .message-bubble:hover {
            background: var(--glass-hover);
            transform: translateY(-1px);
        }

        .message-reactions {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-sm);
            flex-wrap: wrap;
        }

        .reaction {
            background: var(--glass-secondary);
            border: var(--border-glass);
            border-radius: var(--radius-md);
            padding: 2px 6px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .reaction:hover {
            background: var(--glass-hover);
            transform: scale(1.05);
        }

        .reaction.own {
            background: var(--glass-accent);
            border-color: var(--accent-primary);
        }

        /* ================================ */
        /* INPUT AREA STYLES                */
        /* ================================ */

        .input-area {
            padding: var(--space-lg);
            background: var(--glass-primary);
            backdrop-filter: var(--blur-glass);
            border-top: var(--border-glass);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: var(--space-md);
            background: var(--glass-secondary);
            border: var(--border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-md);
            backdrop-filter: var(--blur-glass);
            transition: var(--transition-fast);
        }

        .input-container:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .input-btn {
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .input-btn:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 0.9375rem;
            line-height: 1.4;
            resize: none;
            max-height: 120px;
            min-height: 20px;
            padding: 0;
        }

        .message-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: 36px;
            height: 36px;
            background: var(--accent-primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-neon);
        }

        .send-btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
            box-shadow: var(--shadow-neon-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ================================ */
        /* MODALS & OVERLAYS                */
        /* ================================ */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: var(--blur-glass);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: var(--transition-normal);
        }

        .modal-overlay.active {
            opacity: 1;
        }

        .modal {
            background: var(--glass-primary);
            backdrop-filter: var(--blur-strong);
            border: var(--border-glass-strong);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-glass-hover);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: var(--transition-spring);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: var(--space-xl);
            border-bottom: var(--border-glass);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        .modal-content {
            padding: var(--space-xl);
            overflow-y: auto;
        }

        /* ================================ */
        /* CONTEXT MENU STYLES              */
        /* ================================ */

        .context-menu {
            position: fixed;
            background: var(--glass-primary);
            backdrop-filter: var(--blur-strong);
            border: var(--border-glass-strong);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-glass-hover);
            min-width: 200px;
            z-index: 2000;
            opacity: 0;
            transform: scale(0.9) translateY(-10px);
            transition: var(--transition-fast);
            overflow: hidden;
        }

        .context-menu.active {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.875rem;
        }

        .context-menu-item:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        .context-menu-item.danger:hover {
            background: rgba(255, 59, 59, 0.1);
            color: var(--accent-error);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-glass);
            margin: var(--space-xs) 0;
        }

        /* ================================ */
        /* RESPONSIVE DESIGN                */
        /* ================================ */

        @media (max-width: 1024px) {
            .app-container {
                grid-template-areas:
                    "header header"
                    "main main";
                grid-template-columns: 1fr;
                grid-template-rows: var(--header-height) 1fr;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 200;
                transform: translateX(-100%);
                transition: var(--transition-spring);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .header-search {
                min-width: 200px;
            }
        }

        @media (max-width: 768px) {
            :root {
                --sidebar-width: 280px;
                --space-lg: 1rem;
                --space-xl: 1.5rem;
            }

            .main-header {
                padding: 0 var(--space-lg);
            }

            .header-search {
                min-width: 150px;
            }

            .messages-container {
                padding: var(--space-md);
            }

            .input-area {
                padding: var(--space-md);
            }

            .message-content {
                max-width: 85%;
            }
        }

        @media (max-width: 480px) {
            .header-left {
                gap: var(--space-md);
            }

            .header-search {
                display: none;
            }

            .message-content {
                max-width: 90%;
            }

            .modal {
                margin: var(--space-md);
                max-width: calc(100vw - 2rem);
            }
        }

        /* ================================ */
        /* UTILITY CLASSES                  */
        /* ================================ */

        .hidden {
            display: none !important;
        }

        .invisible {
            visibility: hidden;
            opacity: 0;
        }

        .loading {
            pointer-events: none;
            opacity: 0.6;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glow {
            box-shadow: var(--shadow-neon);
        }

        .glow-hover:hover {
            box-shadow: var(--shadow-neon-hover);
        }

        /* ================================ */
        /* SKELETON LOADING                 */
        /* ================================ */

        .skeleton {
            background: linear-gradient(90deg, var(--glass-secondary) 25%, var(--glass-hover) 50%, var(--glass-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-chat {
            height: 60px;
            margin-bottom: var(--space-sm);
        }

        .skeleton-message {
            height: 40px;
            margin-bottom: var(--space-md);
            width: 70%;
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5em;
        }

        .skeleton-text.short {
            width: 60%;
        }

        .skeleton-text.long {
            width: 90%;
        }
    </style>
</head>
<body data-theme="light">
    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üí¨</div>
                    <span class="logo-text">Talk pAI</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18"/>
                    </svg>
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Navigation -->
                <div class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-title">Navigation</div>
                        <a href="#" class="nav-item active" data-view="chats">
                            <div class="nav-icon">üí¨</div>
                            <span class="nav-text">Chats</span>
                        </a>
                        <a href="#" class="nav-item" data-view="contacts">
                            <div class="nav-icon">üë•</div>
                            <span class="nav-text">Contacts</span>
                        </a>
                        <a href="#" class="nav-item" data-view="channels">
                            <div class="nav-icon">üì¢</div>
                            <span class="nav-text">Channels</span>
                        </a>
                        <a href="#" class="nav-item" data-view="settings">
                            <div class="nav-icon">‚öôÔ∏è</div>
                            <span class="nav-text">Settings</span>
                        </a>
                    </div>
                </div>

                <!-- Chat List -->
                <div class="chat-list" id="chatList">
                    <!-- AI Assistant Chat -->
                    <div class="chat-item active" data-chat-id="ai-assistant">
                        <div class="chat-avatar ai-assistant">
                            ü§ñ
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">
                                AI Assistant
                                <span class="chat-badge" style="background: linear-gradient(135deg, #667eea, #764ba2);">AI</span>
                            </div>
                            <div class="chat-preview">Advanced AI helper with multiple capabilities</div>
                        </div>
                        <div class="chat-meta">
                            <div class="chat-time">Now</div>
                        </div>
                        <button class="chat-menu-btn" onclick="showChatMenu(event, 'ai-assistant')">‚ãÆ</button>
                    </div>

                    <!-- Loading skeletons -->
                    <div class="skeleton skeleton-chat"></div>
                    <div class="skeleton skeleton-chat"></div>
                    <div class="skeleton skeleton-chat"></div>
                </div>
            </div>
        </div>

        <!-- Main Header -->
        <header class="main-header">
            <div class="header-left">
                <button class="header-btn mobile-sidebar-toggle" id="mobileSidebarToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18"/>
                    </svg>
                </button>

                <div class="header-search">
                    <input type="text" class="search-input" placeholder="Search messages, people, files..." id="globalSearch">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                </div>
            </div>

            <div class="header-right">
                <button class="header-btn" id="notificationsBtn" title="Notifications">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span class="nav-badge">3</span>
                </button>

                <button class="header-btn" id="themeToggle" title="Toggle Theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                </button>

                <div class="user-avatar" id="userAvatar" title="Profile">
                    <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë§</text></svg>" alt="User">
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="chat-area" id="chatArea">
                <!-- Messages Container -->
                <div class="messages-container" id="messagesContainer">
                    <!-- Welcome Message -->
                    <div class="message">
                        <div class="message-avatar ai-assistant">ü§ñ</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">AI Assistant</span>
                                <span class="message-time">Now</span>
                            </div>
                            <div class="message-bubble">
                                Welcome to the next generation of messaging! üöÄ

                                I'm your AI assistant, ready to help with:
                                ‚Ä¢ üí¨ Natural conversations
                                ‚Ä¢ üìä Data analysis and spreadsheets
                                ‚Ä¢ üé® Image generation and editing
                                ‚Ä¢ üîç Web search and research
                                ‚Ä¢ üìÑ Document processing
                                ‚Ä¢ üéµ Voice conversations

                                Try asking me anything or use voice messages!
                            </div>
                            <div class="message-reactions">
                                <div class="reaction">üëã 2</div>
                                <div class="reaction">üöÄ 1</div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading skeletons -->
                    <div class="skeleton skeleton-message"></div>
                    <div class="skeleton skeleton-message" style="width: 50%; margin-left: auto;"></div>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <div class="input-actions">
                            <button class="input-btn" id="attachBtn" title="Attach File">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                                </svg>
                            </button>

                            <button class="input-btn" id="voiceBtn" title="Voice Message">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                    <line x1="12" y1="19" x2="12" y2="23"/>
                                    <line x1="8" y1="23" x2="16" y2="23"/>
                                </svg>
                            </button>

                            <button class="input-btn" id="emojiBtn" title="Emoji">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                                </svg>
                            </button>
                        </div>

                        <textarea
                            class="message-input"
                            id="messageInput"
                            placeholder="Type your message..."
                            rows="1"
                        ></textarea>

                        <button class="send-btn" id="sendBtn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22,2 15,22 11,13 2,9"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <button class="context-menu-item" data-action="pin">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 9l3-3 3 3"/>
                <path d="M12 6v12"/>
            </svg>
            Pin Chat
        </button>
        <button class="context-menu-item" data-action="mute">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                <path d="M23 9l-6 6M17 9l6 6"/>
            </svg>
            Mute Notifications
        </button>
        <button class="context-menu-item" data-action="archive">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="21,8 21,21 3,21 3,8"/>
                <rect x="1" y="3" width="22" height="5"/>
                <line x1="10" y1="12" x2="14" y2="12"/>
            </svg>
            Archive
        </button>
        <div class="context-menu-separator"></div>
        <button class="context-menu-item" data-action="mark-unread">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
            </svg>
            Mark as Unread
        </button>
        <button class="context-menu-item" data-action="export">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Export Chat
        </button>
        <div class="context-menu-separator"></div>
        <button class="context-menu-item danger" data-action="delete">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
            </svg>
            Delete Chat
        </button>
    </div>

    <!-- File Input for Attachments -->
    <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip">

    <script>
        // ================================
        // GLOBAL VARIABLES & STATE
        // ================================

        const AppState = {
            currentChat: 'ai-assistant',
            currentTheme: 'light',
            sidebarCollapsed: false,
            isRecording: false,
            socket: null,
            user: null,
            chats: new Map(),
            messages: new Map(),
            contacts: new Map(),
            settings: {
                theme: 'light',
                fontSize: 'medium',
                soundNotifications: true,
                desktopNotifications: true,
                animations: true
            }
        };

        // ================================
        // UTILITY FUNCTIONS
        // ================================

        const Utils = {
            // Generate unique IDs
            generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9),

            // Format time
            formatTime: (date) => {
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) return 'Now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}d`;

                return date.toLocaleDateString();
            },

            // Debounce function
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // Throttle function
            throttle: (func, limit) => {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            },

            // Escape HTML
            escapeHtml: (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // Parse markdown
            parseMarkdown: (text) => {
                if (typeof marked !== 'undefined') {
                    return marked.parse(text);
                }
                // Basic fallback
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>');
            },

            // Show notification
            showNotification: (title, body, icon = '/favicon.ico') => {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, { body, icon });
                }
            },

            // Play sound
            playSound: (type = 'message') => {
                if (!AppState.settings.soundNotifications) return;

                const audio = new Audio();
                switch (type) {
                    case 'message':
                        audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmIcBj2a3fPAaR8Eo8D1x2oiBji+6MV4Hwet0fLZcyQFKX7L8N2QQAsJaLvt559NEAxPqeHuvmAcBT2a3e/GRQQI';
                        break;
                    case 'notification':
                        audio.src = 'data:audio/wav;base64,UklGRjIEAABXQVZFZm10IBAAAAABAAEAgLS2AIANLZ0AAIABAAgAZGF0YRAEAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBziR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmIcBj2a3fPAaR8Eo8D1x2oiBji+6MV4Hwet0fLZcyQFKX7L8N2QQAsJaLvt559NEAxPqeHuvmAcBT2a3e/GRQQI';
                        break;
                }
                audio.volume = 0.3;
                audio.play().catch(() => {}); // Ignore errors
            }
        };

        // ================================
        // THEME MANAGEMENT
        // ================================

        const ThemeManager = {
            themes: ['light', 'dark', 'amoled'],

            init() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                this.setTheme(savedTheme);
            },

            setTheme(theme) {
                if (!this.themes.includes(theme)) theme = 'light';

                document.body.setAttribute('data-theme', theme);
                AppState.currentTheme = theme;
                AppState.settings.theme = theme;
                localStorage.setItem('theme', theme);

                this.updateThemeButton();
            },

            toggleTheme() {
                const currentIndex = this.themes.indexOf(AppState.currentTheme);
                const nextIndex = (currentIndex + 1) % this.themes.length;
                this.setTheme(this.themes[nextIndex]);
            },

            updateThemeButton() {
                const btn = document.getElementById('themeToggle');
                const icons = {
                    light: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',
                    dark: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
                    amoled: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>'
                };
                btn.innerHTML = icons[AppState.currentTheme];
            }
        };

        // ================================
        // SIDEBAR MANAGEMENT
        // ================================

        const SidebarManager = {
            init() {
                const sidebarToggle = document.getElementById('sidebarToggle');
                const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');

                sidebarToggle.addEventListener('click', () => this.toggleSidebar());
                mobileSidebarToggle.addEventListener('click', () => this.toggleMobileSidebar());

                // Close mobile sidebar when clicking outside
                document.addEventListener('click', (e) => {
                    const sidebar = document.getElementById('sidebar');
                    const isClickInsideSidebar = sidebar.contains(e.target);
                    const isMobileToggle = e.target.closest('#mobileSidebarToggle');

                    if (!isClickInsideSidebar && !isMobileToggle && window.innerWidth <= 1024) {
                        this.closeMobileSidebar();
                    }
                });

                // Handle window resize
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 1024) {
                        this.closeMobileSidebar();
                    }
                });
            },

            toggleSidebar() {
                const container = document.getElementById('appContainer');
                const sidebar = document.getElementById('sidebar');

                AppState.sidebarCollapsed = !AppState.sidebarCollapsed;

                if (AppState.sidebarCollapsed) {
                    container.classList.add('sidebar-collapsed');
                    sidebar.classList.add('collapsed');
                } else {
                    container.classList.remove('sidebar-collapsed');
                    sidebar.classList.remove('collapsed');
                }

                localStorage.setItem('sidebarCollapsed', AppState.sidebarCollapsed);
            },

            toggleMobileSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('mobile-open');
            },

            closeMobileSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('mobile-open');
            }
        };

        // ================================
        // CHAT MANAGEMENT
        // ================================

        const ChatManager = {
            init() {
                this.initializeDefaultChats();
                this.bindEvents();
            },

            initializeDefaultChats() {
                // Add AI Assistant chat
                const aiChat = {
                    id: 'ai-assistant',
                    type: 'ai',
                    name: 'AI Assistant',
                    avatar: 'ü§ñ',
                    preview: 'Advanced AI helper with multiple capabilities',
                    lastMessage: 'Welcome! How can I help you today?',
                    lastMessageTime: new Date(),
                    unreadCount: 0,
                    isPinned: false,
                    isMuted: false,
                    participants: []
                };

                AppState.chats.set('ai-assistant', aiChat);
            },

            bindEvents() {
                // Chat selection
                document.addEventListener('click', (e) => {
                    const chatItem = e.target.closest('.chat-item');
                    if (chatItem && !e.target.closest('.chat-menu-btn')) {
                        const chatId = chatItem.dataset.chatId;
                        this.selectChat(chatId);
                    }
                });
            },

            selectChat(chatId) {
                // Remove active class from all chats
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Add active class to selected chat
                const selectedChat = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (selectedChat) {
                    selectedChat.classList.add('active');
                }

                AppState.currentChat = chatId;
                MessageManager.loadMessages(chatId);
                this.updateChatHeader(chatId);
            },

            updateChatHeader(chatId) {
                // Update header to show current chat info
                const chat = AppState.chats.get(chatId);
                if (chat) {
                    // Could add chat name/info to header here
                }
            },

            createChat(type, name, participants = []) {
                const chatId = Utils.generateId();
                const chat = {
                    id: chatId,
                    type,
                    name,
                    avatar: type === 'group' ? 'üë•' : 'üí¨',
                    preview: 'No messages yet',
                    lastMessage: null,
                    lastMessageTime: new Date(),
                    unreadCount: 0,
                    isPinned: false,
                    isMuted: false,
                    participants
                };

                AppState.chats.set(chatId, chat);
                this.renderChatList();
                return chatId;
            },

            renderChatList() {
                const chatList = document.getElementById('chatList');
                const chatsArray = Array.from(AppState.chats.values())
                    .sort((a, b) => {
                        // Sort by pinned first, then by last message time
                        if (a.isPinned && !b.isPinned) return -1;
                        if (!a.isPinned && b.isPinned) return 1;
                        return b.lastMessageTime - a.lastMessageTime;
                    });

                const chatElements = chatsArray.map(chat => this.createChatElement(chat));
                chatList.innerHTML = chatElements.join('');
            },

            createChatElement(chat) {
                const pinnedClass = chat.isPinned ? 'pinned' : '';
                const mutedClass = chat.isMuted ? 'muted' : '';
                const activeClass = chat.id === AppState.currentChat ? 'active' : '';

                const unreadBadge = chat.unreadCount > 0
                    ? `<div class="chat-badge">${chat.unreadCount}</div>`
                    : '';

                return `
                    <div class="chat-item ${activeClass} ${pinnedClass} ${mutedClass}" data-chat-id="${chat.id}">
                        <div class="chat-avatar ${chat.type === 'ai' ? 'ai-assistant' : ''}">
                            ${chat.avatar}
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">
                                ${chat.name}
                                ${chat.type === 'ai' ? '<span class="chat-badge" style="background: linear-gradient(135deg, #667eea, #764ba2);">AI</span>' : ''}
                            </div>
                            <div class="chat-preview">${chat.preview}</div>
                        </div>
                        <div class="chat-meta">
                            <div class="chat-time">${Utils.formatTime(chat.lastMessageTime)}</div>
                            ${unreadBadge}
                        </div>
                        <button class="chat-menu-btn" onclick="showChatMenu(event, '${chat.id}')">‚ãÆ</button>
                    </div>
                `;
            }
        };

        // ================================
        // MESSAGE MANAGEMENT
        // ================================

        const MessageManager = {
            init() {
                this.bindEvents();
                this.initializeInput();
            },

            bindEvents() {
                const sendBtn = document.getElementById('sendBtn');
                const messageInput = document.getElementById('messageInput');

                sendBtn.addEventListener('click', () => this.sendMessage());
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                messageInput.addEventListener('input', () => this.handleInputChange());
            },

            initializeInput() {
                const messageInput = document.getElementById('messageInput');

                // Auto-resize textarea
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            },

            handleInputChange() {
                const messageInput = document.getElementById('messageInput');
                const sendBtn = document.getElementById('sendBtn');

                const hasContent = messageInput.value.trim().length > 0;
                sendBtn.disabled = !hasContent;

                // Show typing indicator (would send to server in real app)
                if (hasContent) {
                    this.showTypingIndicator();
                }
            },

            showTypingIndicator() {
                // Would implement typing indicator here
            },

            sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const content = messageInput.value.trim();

                if (!content) return;

                const message = {
                    id: Utils.generateId(),
                    chatId: AppState.currentChat,
                    senderId: 'current-user',
                    senderName: 'You',
                    senderAvatar: 'üë§',
                    content,
                    contentType: 'text',
                    timestamp: new Date(),
                    reactions: [],
                    isOwn: true
                };

                this.addMessage(message);
                messageInput.value = '';
                messageInput.style.height = 'auto';
                document.getElementById('sendBtn').disabled = true;

                // Send to AI if current chat is AI assistant
                if (AppState.currentChat === 'ai-assistant') {
                    this.sendToAI(content);
                }

                Utils.playSound('message');
            },

            async sendToAI(content) {
                // Show typing indicator
                this.showAITyping();

                try {
                    // Simulate AI response delay
                    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));

                    const aiResponse = this.generateAIResponse(content);

                    const aiMessage = {
                        id: Utils.generateId(),
                        chatId: AppState.currentChat,
                        senderId: 'ai-assistant',
                        senderName: 'AI Assistant',
                        senderAvatar: 'ü§ñ',
                        content: aiResponse,
                        contentType: 'text',
                        timestamp: new Date(),
                        reactions: [],
                        isOwn: false
                    };

                    this.hideAITyping();
                    this.addMessage(aiMessage);

                    Utils.playSound('notification');

                } catch (error) {
                    console.error('AI response error:', error);
                    this.hideAITyping();
                }
            },

            generateAIResponse(userMessage) {
                const responses = [
                    "I understand your message! How can I help you with that?",
                    "That's an interesting point. Let me provide some insights...",
                    "I'm here to assist you with whatever you need. What would you like to explore?",
                    "Great question! Here's what I think about that...",
                    "I can help you with a variety of tasks. What specific assistance do you need?",
                    "Thanks for sharing that with me. How can I support you further?",
                    "I'm ready to help you tackle any challenge. What's on your mind?",
                    "That's a thoughtful message. Let me help you with a comprehensive response..."
                ];

                // Simple response generation (in real app, would call AI API)
                return responses[Math.floor(Math.random() * responses.length)];
            },

            showAITyping() {
                const messagesContainer = document.getElementById('messagesContainer');

                const typingElement = document.createElement('div');
                typingElement.className = 'message typing-indicator';
                typingElement.id = 'ai-typing';
                typingElement.innerHTML = `
                    <div class="message-avatar ai-assistant">ü§ñ</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">AI Assistant</span>
                            <span class="message-time">typing...</span>
                        </div>
                        <div class="message-bubble">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                `;

                messagesContainer.appendChild(typingElement);
                this.scrollToBottom();
            },

            hideAITyping() {
                const typingElement = document.getElementById('ai-typing');
                if (typingElement) {
                    typingElement.remove();
                }
            },

            addMessage(message) {
                // Add to messages map
                if (!AppState.messages.has(message.chatId)) {
                    AppState.messages.set(message.chatId, []);
                }
                AppState.messages.get(message.chatId).push(message);

                // Update chat preview
                const chat = AppState.chats.get(message.chatId);
                if (chat) {
                    chat.lastMessage = message.content;
                    chat.lastMessageTime = message.timestamp;
                    chat.preview = message.content.substring(0, 50) + (message.content.length > 50 ? '...' : '');
                }

                // Render message if it's for current chat
                if (message.chatId === AppState.currentChat) {
                    this.renderMessage(message);
                    this.scrollToBottom();
                }

                // Update chat list
                ChatManager.renderChatList();
            },

            renderMessage(message) {
                const messagesContainer = document.getElementById('messagesContainer');

                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.isOwn ? 'own' : ''}`;
                messageElement.dataset.messageId = message.id;

                const reactionsHtml = message.reactions && message.reactions.length > 0
                    ? `<div class="message-reactions">
                        ${message.reactions.map(reaction =>
                            `<div class="reaction ${reaction.isOwn ? 'own' : ''}">${reaction.emoji} ${reaction.count}</div>`
                        ).join('')}
                       </div>`
                    : '';

                messageElement.innerHTML = `
                    <div class="message-avatar ${message.senderId === 'ai-assistant' ? 'ai-assistant' : ''}">
                        ${message.senderAvatar}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${message.senderName}</span>
                            <span class="message-time">${Utils.formatTime(message.timestamp)}</span>
                        </div>
                        <div class="message-bubble">
                            ${Utils.parseMarkdown(message.content)}
                        </div>
                        ${reactionsHtml}
                    </div>
                `;

                messagesContainer.appendChild(messageElement);
            },

            loadMessages(chatId) {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';

                const messages = AppState.messages.get(chatId) || [];

                if (messages.length === 0 && chatId === 'ai-assistant') {
                    // Show welcome message for AI assistant
                    const welcomeMessage = {
                        id: 'welcome',
                        chatId: 'ai-assistant',
                        senderId: 'ai-assistant',
                        senderName: 'AI Assistant',
                        senderAvatar: 'ü§ñ',
                        content: `Welcome to the next generation of messaging! üöÄ

I'm your AI assistant, ready to help with:
‚Ä¢ üí¨ Natural conversations
‚Ä¢ üìä Data analysis and spreadsheets
‚Ä¢ üé® Image generation and editing
‚Ä¢ üîç Web search and research
‚Ä¢ üìÑ Document processing
‚Ä¢ üéµ Voice conversations

Try asking me anything or use voice messages!`,
                        contentType: 'text',
                        timestamp: new Date(),
                        reactions: [
                            { emoji: 'üëã', count: 2, isOwn: false },
                            { emoji: 'üöÄ', count: 1, isOwn: false }
                        ],
                        isOwn: false
                    };

                    this.renderMessage(welcomeMessage);
                } else {
                    messages.forEach(message => this.renderMessage(message));
                }

                this.scrollToBottom();
            },

            scrollToBottom() {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        };

        // ================================
        // CONTEXT MENU MANAGEMENT
        // ================================

        const ContextMenuManager = {
            init() {
                this.bindEvents();
            },

            bindEvents() {
                // Close context menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.context-menu')) {
                        this.hideContextMenu();
                    }
                });

                // Handle context menu actions
                document.addEventListener('click', (e) => {
                    const menuItem = e.target.closest('.context-menu-item');
                    if (menuItem) {
                        const action = menuItem.dataset.action;
                        const chatId = this.currentChatId;
                        this.handleContextAction(action, chatId);
                        this.hideContextMenu();
                    }
                });
            },

            showContextMenu(x, y, chatId) {
                const contextMenu = document.getElementById('contextMenu');
                this.currentChatId = chatId;

                // Position the menu
                contextMenu.style.left = `${x}px`;
                contextMenu.style.top = `${y}px`;

                // Show the menu
                contextMenu.classList.add('active');

                // Adjust position if menu goes off screen
                const rect = contextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    contextMenu.style.left = `${x - rect.width}px`;
                }
                if (rect.bottom > window.innerHeight) {
                    contextMenu.style.top = `${y - rect.height}px`;
                }
            },

            hideContextMenu() {
                const contextMenu = document.getElementById('contextMenu');
                contextMenu.classList.remove('active');
                this.currentChatId = null;
            },

            handleContextAction(action, chatId) {
                const chat = AppState.chats.get(chatId);
                if (!chat) return;

                switch (action) {
                    case 'pin':
                        chat.isPinned = !chat.isPinned;
                        ChatManager.renderChatList();
                        break;
                    case 'mute':
                        chat.isMuted = !chat.isMuted;
                        ChatManager.renderChatList();
                        break;
                    case 'archive':
                        // Implement archive functionality
                        console.log('Archive chat:', chatId);
                        break;
                    case 'mark-unread':
                        chat.unreadCount = 1;
                        ChatManager.renderChatList();
                        break;
                    case 'export':
                        this.exportChat(chatId);
                        break;
                    case 'delete':
                        if (confirm('Are you sure you want to delete this chat?')) {
                            AppState.chats.delete(chatId);
                            AppState.messages.delete(chatId);
                            ChatManager.renderChatList();
                            if (AppState.currentChat === chatId) {
                                ChatManager.selectChat('ai-assistant');
                            }
                        }
                        break;
                }
            },

            exportChat(chatId) {
                const chat = AppState.chats.get(chatId);
                const messages = AppState.messages.get(chatId) || [];

                const exportData = {
                    chatName: chat.name,
                    exportDate: new Date().toISOString(),
                    messageCount: messages.length,
                    messages: messages.map(msg => ({
                        sender: msg.senderName,
                        content: msg.content,
                        timestamp: msg.timestamp.toISOString()
                    }))
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${chat.name.replace(/[^a-z0-9]/gi, '_')}_export.json`;
                a.click();

                URL.revokeObjectURL(url);
            }
        };

        // ================================
        // SEARCH FUNCTIONALITY
        // ================================

        const SearchManager = {
            init() {
                const searchInput = document.getElementById('globalSearch');
                searchInput.addEventListener('input', Utils.debounce((e) => {
                    this.handleSearch(e.target.value);
                }, 300));

                // Global search shortcut (Ctrl/Cmd + K)
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        searchInput.focus();
                    }
                });
            },

            handleSearch(query) {
                if (query.length < 2) {
                    this.hideSearchResults();
                    return;
                }

                const results = this.performSearch(query);
                this.showSearchResults(results);
            },

            performSearch(query) {
                const results = {
                    messages: [],
                    chats: [],
                    contacts: []
                };

                const queryLower = query.toLowerCase();

                // Search messages
                AppState.messages.forEach((messages, chatId) => {
                    messages.forEach(message => {
                        if (message.content.toLowerCase().includes(queryLower)) {
                            results.messages.push({
                                ...message,
                                chatName: AppState.chats.get(chatId)?.name || 'Unknown'
                            });
                        }
                    });
                });

                // Search chats
                AppState.chats.forEach(chat => {
                    if (chat.name.toLowerCase().includes(queryLower)) {
                        results.chats.push(chat);
                    }
                });

                // Limit results
                results.messages = results.messages.slice(0, 5);
                results.chats = results.chats.slice(0, 3);

                return results;
            },

            showSearchResults(results) {
                // Implementation for showing search results overlay
                console.log('Search results:', results);
            },

            hideSearchResults() {
                // Implementation for hiding search results
            }
        };

        // ================================
        // FILE HANDLING
        // ================================

        const FileManager = {
            init() {
                const attachBtn = document.getElementById('attachBtn');
                const fileInput = document.getElementById('fileInput');

                attachBtn.addEventListener('click', () => {
                    fileInput.click();
                });

                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelection(e.target.files);
                });

                // Drag and drop
                const inputArea = document.querySelector('.input-area');
                inputArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    inputArea.classList.add('drag-over');
                });

                inputArea.addEventListener('dragleave', () => {
                    inputArea.classList.remove('drag-over');
                });

                inputArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    inputArea.classList.remove('drag-over');
                    this.handleFileSelection(e.dataTransfer.files);
                });
            },

            handleFileSelection(files) {
                Array.from(files).forEach(file => {
                    this.processFile(file);
                });
            },

            processFile(file) {
                // Validate file
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('File too large. Maximum size is 5MB.');
                    return;
                }

                // Create file message
                const message = {
                    id: Utils.generateId(),
                    chatId: AppState.currentChat,
                    senderId: 'current-user',
                    senderName: 'You',
                    senderAvatar: 'üë§',
                    content: `üìé ${file.name}`,
                    contentType: 'file',
                    timestamp: new Date(),
                    reactions: [],
                    isOwn: true,
                    fileData: {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: URL.createObjectURL(file)
                    }
                };

                MessageManager.addMessage(message);
                Utils.playSound('message');
            }
        };

        // ================================
        // VOICE RECORDING
        // ================================

        const VoiceManager = {
            mediaRecorder: null,
            audioChunks: [],

            init() {
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.addEventListener('click', () => {
                    if (AppState.isRecording) {
                        this.stopRecording();
                    } else {
                        this.startRecording();
                    }
                });
            },

            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];

                    this.mediaRecorder.addEventListener('dataavailable', (e) => {
                        this.audioChunks.push(e.data);
                    });

                    this.mediaRecorder.addEventListener('stop', () => {
                        this.processRecording();
                    });

                    this.mediaRecorder.start();
                    AppState.isRecording = true;

                    this.updateVoiceButton();
                    Utils.showNotification('Recording', 'Voice recording started');

                } catch (error) {
                    console.error('Failed to start recording:', error);
                    alert('Failed to access microphone. Please check permissions.');
                }
            },

            stopRecording() {
                if (this.mediaRecorder && AppState.isRecording) {
                    this.mediaRecorder.stop();
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    AppState.isRecording = false;
                    this.updateVoiceButton();
                }
            },

            processRecording() {
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);

                const message = {
                    id: Utils.generateId(),
                    chatId: AppState.currentChat,
                    senderId: 'current-user',
                    senderName: 'You',
                    senderAvatar: 'üë§',
                    content: 'üé§ Voice message',
                    contentType: 'voice',
                    timestamp: new Date(),
                    reactions: [],
                    isOwn: true,
                    voiceData: {
                        url: audioUrl,
                        duration: this.audioChunks.length // Approximate
                    }
                };

                MessageManager.addMessage(message);
                Utils.playSound('message');
            },

            updateVoiceButton() {
                const voiceBtn = document.getElementById('voiceBtn');
                if (AppState.isRecording) {
                    voiceBtn.style.color = 'var(--accent-error)';
                    voiceBtn.title = 'Stop Recording';
                } else {
                    voiceBtn.style.color = '';
                    voiceBtn.title = 'Voice Message';
                }
            }
        };

        // ================================
        // GLOBAL FUNCTIONS
        // ================================

        window.showChatMenu = (event, chatId) => {
            event.stopPropagation();
            const rect = event.target.getBoundingClientRect();
            ContextMenuManager.showContextMenu(rect.left, rect.bottom + 5, chatId);
        };

        // ================================
        // INITIALIZATION
        // ================================

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize all managers
            ThemeManager.init();
            SidebarManager.init();
            ChatManager.init();
            MessageManager.init();
            ContextMenuManager.init();
            SearchManager.init();
            FileManager.init();
            VoiceManager.init();

            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            // Load initial data
            ChatManager.selectChat('ai-assistant');

            // Add some sample chats for demo
            setTimeout(() => {
                const demoChats = [
                    {
                        id: 'demo-1',
                        type: 'dm',
                        name: 'John Doe',
                        avatar: 'üë®',
                        preview: 'Hey, how are you doing?',
                        lastMessage: 'Hey, how are you doing?',
                        lastMessageTime: new Date(Date.now() - 3600000), // 1 hour ago
                        unreadCount: 2,
                        isPinned: true,
                        isMuted: false,
                        participants: ['john-doe']
                    },
                    {
                        id: 'demo-2',
                        type: 'group',
                        name: 'Team Project',
                        avatar: 'üë•',
                        preview: 'The meeting is scheduled for tomorrow',
                        lastMessage: 'The meeting is scheduled for tomorrow',
                        lastMessageTime: new Date(Date.now() - 7200000), // 2 hours ago
                        unreadCount: 0,
                        isPinned: false,
                        isMuted: false,
                        participants: ['john-doe', 'jane-smith', 'bob-wilson']
                    }
                ];

                demoChats.forEach(chat => AppState.chats.set(chat.id, chat));
                ChatManager.renderChatList();
            }, 1000);

            console.log('üöÄ Talk pAI - Next Generation Messenger initialized!');
        });

        // Add CSS for typing indicator
        const style = document.createElement('style');
        style.textContent = `
            .typing-dots {
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .typing-dots span {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: var(--text-secondary);
                animation: typing 1.4s infinite ease-in-out;
            }

            .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
            .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

            @keyframes typing {
                0%, 80%, 100% {
                    transform: scale(0.8);
                    opacity: 0.5;
                }
                40% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            .drag-over {
                background: var(--glass-accent) !important;
                border-color: var(--accent-primary) !important;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>